---
title: "tents_data_cleaning"
date: "2023-02-15"
---

# roadmap

1. load data & packages
2. cleaning: prefiltering, fix columns, add columns
3. save output

# 1. load data & packages
```{r message = FALSE}
library(conflicted)
library(dplyr)
conflicts_prefer(dplyr::filter)
library(tidyr)
library(purrr)

# to load data from gsheets
library(googlesheets4)
```

## - data import from gsheets

```{r}
# before importing,
  # run cleaning macros,
  # check column/row alignment + proper sorting

# tents/hatch data
data_pairs <- read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet="mating pairs", col_types = "c", na = c("#N/A", "NA", "--", "", "#REF!"))
data_tstats <- read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet="tent stats v2", col_types = "c", range = "A:P", na = c("#N/A", "NA", "--", "", "#REF!", "unk"))
data_hatch <- read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet="hatch stats", col_types = "c", range = "A:F", na = c("#N/A", "NA", "--", "", "#REF!"))
```

# 2. cleaning

matepairs:
- *drop extra na rows*
- *drop hidden columns(?)*
- *replace #N/A with actual NAs*
- *replace "col" and "lab" with actual # values, change column format*
- fill in other tents (i.e cages) w/ sth
- *standardise column names*

## - add/drop columns
```{r}
# drop unneeded columns
data_pairs <- select(data_pairs, -c("sex_A", "sex_B", "id_F2", "id_M2", "id_A-orig", "id_B-orig", "combo2"))
data_tstats <- select(data_tstats, -starts_with(c("total", "lifetime")))

# add IDs
# data_pairs <- mutate(data_pairs, src = "pairs")
# data_tstats <- mutate(data_tstats, src = "tstats")
# data_hatch <- mutate(data_hatch, src = "hatch")
```

## - standardise column names, row trimming
```{r}
data_hatch <- data_hatch %>%
  rename(date.hatched = date.hatchlings,
         id.tent = "tent id",
         id.coll = "coll-tent", # collection id (date-tent)
         n.hatched = n.hatchlings,
         notes.hatch = notes)

data_pairs <- data_pairs %>%
  rename(trt.pair = combo,
         id.tent = tent_id,
         id.pair = pair_id,
         room = location,
         date.paired = date_paired,
         id.f = id_F,
         date.fdied = died_F,
         id.m = id_M,
         date.mdied = died_M,
         trt.f = trt_F,
         date.fec = eclose_F,
         track.f = purpose_F,
         trt.m = trt_M,
         date.mec = eclose_M,
         track.m = purpose_B)

data_tstats <- data_tstats %>%
  rename(date.coll = date,
         id.tent = tent.ID,
         n.eggs = "eggs collected",
         n.new.f = "females added",
         n.curr.f = "females alive current",
         n.died.f = "females dead",
         n.new.m = "males added",
         n.curr.m = "males alive",
         n.died.m = "males dead",
         notes.tents = notes)

# drop empty rows
data_pairs <- drop_na(data_pairs, id.tent)
data_hatch <- drop_na(data_hatch, id.tent)
```


## - consolidation, fixing column format + values

(values to fix: nas and stuff.. replacements... unks... etc... better strings to filter on... see above)
```{r}
# consolidate
data_tents <- merge(data_tstats, data_hatch, by = c("date.coll", "id.tent"), all = TRUE) 
  #%>%
  #fix.columns()

tentlist <- list(data_tents, data_pairs)

# function to standardise column format
# fix.columns <- function(data) {
#   cleaned_data <- data %>%
#     mutate(across(starts_with("date."),  as.Date, format = "%m/%d"),
#            across(starts_with("n."), as.numeric),
#     )
#   
#   return(cleaned_data)
# }

# function to fix values, column format
fix.values <- function(data) {
  #data <- fix.columns(data)
  data <- data %>%
    mutate(# fix column format
           across(starts_with("date."),  as.Date, format = "%m/%d"),
           across(starts_with("n."), as.numeric),
           
           # fix values
           trt.m = case_when(trt.m == "col" ~ 999,
                             trt.m == "ctrl" ~ 900,
                             TRUE ~ as.numeric(trt.m)),
           trt.f = case_when(trt.f == "col" ~ 999,
                             trt.f == "ctrl" ~ 900,
                             TRUE ~ as.numeric(trt.f))
           )
  
  # data[trt.m == "col" | trt.f == "col"] <- 999
  # data[trt.m == "ctrl" | trt.f == "ctrl"] <- 900
}

tentlist_clean <- lapply(tentlist, fix.values)
data_tents <- tentlist_clean[[1]]
data_pairs <- tentlist_clean[[2]]

# per df value fixing & cleaning
data_pairs <- data_pairs %>%
  mutate(id.pair = as.numeric(id.pair),
         room = as.numeric(room),
         tent = case_when(is.na(tent) ~ "cage",
                          TRUE ~ as.character(tent)),
         id.tent = paste(room, tent, sep = "-")) %>% # diff from paste(x1, "-", x2) lol idky
  naniar::replace_with_na_all(condition = ~.x %in% c("unk", "na"))

data_tents <- data_tents %>%
  filter(is.na(if.ignore)) 
```

# 3. extracting notes & saving outputs

```{r}
# save notes elsewhere
notes_pairs <- select(data_pairs, c(trt.pair, id.tent, id.pair, date.paired, id.f, id.m, notes))

notes_tents <- select(data_tents, id.tent, date.coll, id.coll, notes.tents, date.hatched, notes.hatch)

write.csv(notes_pairs, "~/Documents/repos/_private/data/ntw_data/notes_tentpairs.csv", row.names = FALSE)
write.csv(notes_tents, "~/Documents/repos/_private/data/ntw_data/notes_tentstats.csv", row.names = FALSE)

# drop from main dfs
data_pairs <- select(data_pairs, -notes)
data_tents <- select(data_tents, -c(notes.tents, id.coll, notes.hatch, if.ignore))

# save cleaned dfs
write.csv(data_tents, "~/Documents/repos/_private/data/ntw_data/clean-tentstats.csv", row.names = FALSE)
write.csv(data_pairs, "~/Documents/repos/_private/data/ntw_data/clean-pairs.csv", row.names = FALSE)
```


```{r}
# ref code on running fns across a list lol

# formatear <- function(eq){
#   eq$Volume <- NULL
#   eq$Date <- as.Date(eq$Date)
#   
#   nt <- eq$Adj.Close[1:nrow(eq)-1]
#   nt1 <- eq$Adj.Close[2:nrow(eq)]
#   eq$return <- percent(c(NA, nt1/nt-1), accuracy = 0.0001)
#   return(eq) 
# }

#You can use mget to get list of dataframes and apply the function with lapply.

# clean_list_data <- lapply(mget(dfs), formatear)
# clean_list_data[[1]]
```



