---
title: "analysis code v3"
date: "2023-10-31"
output: html_notebook
---

lol

(because i am lost in the sauce again and also want to rename things)


**overview:**

0. load in data, packages
1. clean data

**todos:**



# 0.1 load data & packages
```{r message = FALSE}
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)

# survival curve stuff
library(survival)
library(survminer)

# to load data from gsheets
library(googlesheets4)

```

```{r}
# before importing,
  # run cleaning macros (larva sheets)
  # check column/row alignment + proper sorting (adult sheets)

# larva data
data_field <- read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet = "june field", col_types = "c")
data_labsu <- read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet="june 2023 lab", col_types = "c")
data_labF1 <- read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet="lab F1", col_types = "c")
data_labsp <- read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet="consolidated + tidyed", col_types = "c")

# tents/hatch data
# data_matepairs <- read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet="mating pairs", col_types = "c")
# data_tents <- read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet="tent stats v2", col_types = "c")
# data_hatching <- read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet="hatch stats", col_types = "c")
```
## - define aesthetics
```{r}
#all_trts <- c("260-hatch", "267-hatch", "330-hatch", "337-hatch", "337-3rd", "337-4th", "40-19", "40-26")


# temp: effect of mean/fluct temp (treatment)
temp_trts = c("260-hatch", "267-hatch", "330-hatch", "337-hatch")
temp_labels = c("260-hatch"="26°C", "267-hatch"="26±7°C", "330-hatch"="33°C", "337-hatch"="33±7°C")
temp_colors = c("260-hatch"="#00C2D1","267-hatch"="#1929B3", "330-hatch"="#F9C639", "337-hatch"="#710A36")



# accum: effect of temp x instar (trt.stage)
acc_trts = c("260-hatch", "337-hatch", "337-3rd", "337-4th")
acc_labels = c("260-hatch"="26°C @ hatch","337-hatch"="33±7°C @ hatch", "337-3rd"="33±7°C @ 3rd", "337-4th"="33±7°C @ 4th")
acc_colors = c("260-hatch"="#00C2D1", "337-hatch"="#710A36", "337-3rd"="#C23C1E", "337-4th"="#F3922B")
#CD133F


# NTs: same DTs, different NTs 
NT_trts = c("260-hatch", "419-hatch", "337-hatch", "433-hatch")
NT_labels = c("260-hatch"="26/26 (26±0°C)", "419-hatch"="40/19 (29.5±10.5°C)", "337-hatch"="40/26 (33±7°C)", "433-hatch"="40/33 (36.5±3.5°C)")
NT_colors = c("260-hatch"="#F4B942", "419-hatch"="#4059AD", "337-hatch"="#6B9AC4", "433-hatch"="#97D8C4")
  # although i think 267 is the better comparison, i have more 260s

# for survival but lowkey need to edit it below
# A_hex = c("#00C2D1","#1929B3", "#F9C639", "#710A36")
# B_hex = c("#00C2D1", "#710A36", "#C23C1E", "#F3922B")
# C_hex = c("#F4B942", "#4059AD", "#6B9AC4", "#97D8C4")
```


# 0.2. clean data

## - column fixing, consolidation, standardising, pre-filtering
```{r}
# function to standardise column format
fix.columns <- function(data) {
  cleaned_data <- data %>%
    mutate(across(starts_with("date."),  as.Date, format = "%m/%d")) %>%
    mutate(mutate(across(starts_with("mass."), as.numeric))
    )
  
  return(cleaned_data)
}

# add IDs to imported data sheets and consolidate
data_field <- mutate(data_field, src = "field")
data_labF1 <- mutate(data_labF1, src = "F1")
data_labsp <- mutate(data_labsp, src = "sp")
data_labsu <- mutate(data_labsu, src = "su")

data_all <- data.table::rbindlist(lapply(list(data_field, data_labF1, data_labsp, data_labsu), fix.columns), fill = T)

# value standardising
data_all$treatment[data_all$treatment=="426"] <- "337" # match for consistency
data_all$instar.enter[data_all$trt.stage == "1st"] <- "hatch" # change field 1sts to hatchlings

# filter out individuals that didnt hatch at 26C
data_all <- data_all %>%
    filter(is.na(from.E) | !(from.E == 2 | (from.E == 0 & (treatment == 337 | treatment == 330 | treatment == 267))))

# filter random deaths
data_all <- data_all %>% filter(is.na(ignore.reason))

# filter out MQs
MQ_data <- data_all %>% filter(species == "MQ")
data_all <- data_all %>% filter(is.na(species))

# remove imports env bc it gets messy fast lol
#rm(data_field, data_labF1, data_labsp, data_labsu)
```

## - column creation for addtl stats + cleanup
```{r}
# survival/development binaries
data_all <- data_all %>% mutate(
  #if.stuck = case_when(is.na(date.stuck) ~ "N", TRUE ~ "Y"),
  if.pupa = case_when(is.na(date.LP) & is.na(date.pupa) ~ "N", TRUE ~ "Y"),
  if.sup = case_when(is.na(date.6th) ~ "N", TRUE ~ "Y"),
  sup = case_when(!is.na(date.7th) ~ 7, !is.na(date.6th) ~ 6, TRUE ~ 0) # type of sup
  )

# mean/fluc Ts
data_all <- data_all %>% mutate(
  meanT = case_when(treatment == 260 | treatment == 267 | treatment == "ctrl" ~ 26,
                    treatment == 337 | treatment == 330 ~ 33,
                    treatment == 433 ~ 36.5,
                    treatment == 419 ~ 29.5),
  flucT = case_when(treatment == 260 | treatment == 330 ~ 0,
                    treatment == 267 | treatment == 337 ~ 7,
                    treatment == 433 ~ 3.5,
                    treatment == 419 ~ 10.5)
  )

# subdivide trts and prep for calculating timetos
data_all <- data_all %>%
  mutate(across(starts_with("date."), format, "%j", .names = "j{.col}")) %>%
  mutate(across(starts_with("jdate."), as.numeric),
         treatment = as.character(treatment),
         trt.stage = as.character(paste(treatment,instar.enter, sep = "-")), # treatment @ instar
         grp.trt = paste(expt.group, trt.stage, sep = "-")) # round @ treatment

# indicate field or lab pops
data_all <- data_all %>%
  mutate(pop = case_when(location == "CC" ~ "field",
                         src == "F1" ~ "F1",
                         TRUE ~ "lab"))

# indicate overly long-lived individuals: things that took > 25 days to die
# these can be omitted later
data_all <- data_all %>% mutate(ignore.reason = case_when(jdate.pmd-jdate.hatch > 25 ~ "slow"))
  # check: table(data_all$ignore.reason)

# extract wordier notes from data and save elsewhere
notes_all <- select(data_all, c("treatment", "ID", "expt.group", "location", "date.collected", "date.stuck", "time.in.approx", "dv", "mass.died", "pupa.deformities", "notes", "ignore.reason", ends_with(".stuck"), ends_with(".culled")))

# remove unneeded columns
data_all <- select(data_all, -c("species", "from.E", "location", "date.collected", "date.stuck", "time.in.approx", "dv", "pupa.deformities", "mass.died", "toss.if", "old.date.pmd", "fate.code", "notes", ends_with(".stuck"), ends_with(".culled"), "eclose-3"))
  # need to put back 'species' if the MQ get put back in
```

## - pivots and renaming
```{r}
wide_all <- data_all

long_all <- data_all %>% select(-(starts_with("date."))) %>%
  mutate(tt.3rd = jdate.3rd - jdate.hatch,
         tt.4th = jdate.4th - jdate.hatch,
         tt.5th = jdate.5th - jdate.hatch,
         tt.6th = jdate.6th - jdate.hatch,
         tt.7th = jdate.7th - jdate.hatch, 
         tt.wander = jdate.wander - jdate.hatch,
         #tt.pupa = jdate.pupa - jdate.wander,
         tt.pupa = jdate.pupa-jdate.hatch,
         tt.15 = jdate.15-jdate.hatch,
         tt.eclose = jdate.eclose-jdate.pupa,
         tt.exit = jdate.exit - jdate.enter,
         tt.surv = jdate.surv - jdate.hatch) %>%
  pivot_longer(cols = starts_with(c("jdate", "mass", "h", "tt")),
               names_to = c(".value", "instar"),
               #names_sep = ".",
               values_drop_na = TRUE,
               names_pattern = ("([a-z]*)\\.(\\d*[a-z]*)")) %>%
  rename(molt.status = h) %>%
  drop_na(jdate) %>% drop_na(tt) %>% # drops NA's if an individual didnt reach a certain stage
  filter(instar != "15")

# add instar factor levels
long_all <- long_all %>% mutate(instar = factor(instar, levels=c("hatch", "2nd", "3rd", "4th", "5th", "6th", "7th", "stuck", "wander", "15", "pupa", "eclose", "exit")))
#long_all$instar <- factor(long_all$instar, c("hatch", "2nd", "3rd", "4th", "5th", "6th", "7th", "stuck", "wander", "15", "pupa", "eclose", "exit"))

#rm(data_all)

```
# 0.3 define helpful functions

## - filter groups
```{r}
# separate experiment groups
filter.temps <- function(data) {
  filtered_data <- data %>% filter(trt.stage == "260-hatch" | trt.stage =="267-hatch" | trt.stage == "330-hatch" | trt.stage == "337-hatch")
  
  return(filtered_data)
}

filter.acc <- function(data) {
  filtered_data <- data %>% filter(trt.stage != "267-hatch" & trt.stage != "330-hatch" & trt.stage != "419-hatch" & trt.stage != "433-hatch") %>% mutate(trt.stage = factor(trt.stage, levels = c("260-hatch", "337-hatch", "337-3rd", "337-4th")))
  
  return(filtered_data)
}


filter.NTs <-function(data){
  filtered_data <- data %>% filter(trt.stage == "260-hatch" | trt.stage == "337-hatch" | trt.stage == "419-hatch" | trt.stage == "433-hatch") %>% mutate(trt.stage = factor(trt.stage, levels = c("260-hatch", "419-hatch", "337-hatch", "433-hatch")))
  
    return(filtered_data)
}

# separate instars
filter.ins.topup <- function(data) {
  filtered_data <- data %>%
      filter(instar == "4th" | instar == "5th" | instar == "6th" | instar == "7th" | instar == "wander" | instar == "pupa")
  
  return(filtered_data)
}
```

## - adding geoms
```{r}
# error bars
y_err_logmass <- function(x) {
  list(geom_errorbar(aes(ymin = avg.logmass - se.logmass, ymax = avg.logmass + se.logmass), width = x))
}

y_err_mass <- function(x) {
  list(geom_errorbar(aes(ymin = avg.mass - se.mass, ymax = avg.mass + se.mass), width = x))
}

x_err_tt <- function(x){
  list(geom_errorbarh(aes(xmin = avg.tt - se.tt, xmax = avg.tt + se.tt), width = x))
}

# recoloring theme + legend
temp_aes <- function(x)(
  list(theme_bw(), scale_color_manual(values=temp_colors, labels=temp_labels))
)

acc_aes <- function(x){
  list(theme_bw(), scale_color_manual(values=acc_colors, labels=acc_labels))  
}

NT_aes <- function(x){
  list(theme_bw(), scale_color_manual(values=NT_colors, labels=NT_labels))
}
```


 - calc timeto (3rd-pup)
```{r}
pivot.ttpup <- function(wide_data) {
  pivoted_data <- wide_data %>%
  select(-starts_with(c("h", "date", "mass", "reason."))) %>%
  mutate("3rd" = jdate.3rd - jdate.hatch,
         "4th" = jdate.4th - jdate.hatch,
         "5th" = jdate.5th - jdate.hatch,
         "6th" = jdate.6th - jdate.hatch,
         "7th" = jdate.7th - jdate.hatch, 
         wander = jdate.wander - jdate.hatch,
         pupa = jdate.pupa - jdate.wander) %>%
  select(-starts_with("jdate.")) %>%
  pivot_longer (cols = c("3rd", "4th", "5th", "wander", "pupa"), # pivot differences by stage
                names_to = "instar",
                values_to = "days.to") %>%
  drop_na(days.to) # drop whoever didnt hit a certain stage
  
  return(pivoted_data)
}
```



# 0.4 validation stuff lol

- 260 diurnal vs 26 C
- 25 col vs 260 ctrls generally
- batch effects (maybe clear this in models...)
- effects of lab diet vs TB diet in lab bugs

# 1.0 super simple stats
```{r}
# temps stats 
 test <- wide_all %>% filter.temps() %>% filter(pop == "lab") %>% filter(treatment <331 & treatment > 266)
# unique(test$treatment) 
# test %>% group_by(treatment) %>% summarise(n=n())

wide_all %>%
  filter.temps() %>% filter(pop == "lab") %>%
  group_by(treatment) %>%
  summarise(n=n(),
            pct.sup = round(sum(if.sup == "Y")/n*100, digits = 1),
            pct.6th = round(sum(sup == 6)/sum(if.sup == "Y")*100, digits = 1),
            pct.7th = round(sum(sup == 7)/sum(if.sup == "Y")*100, digits = 1),
            n.pmd = sum(final.fate == "pmd"),
            pct.pmd = round(sum(final.fate == "pmd")/n, digits = 1),
            pct.slow = round(sum(ignore.reason == "slow")/n*100, digits = 1))

# NT stats
wide_all %>%
  filter.NTs() %>% filter(pop == "field" | pop == "lab") %>%
  group_by(treatment, pop) %>%
  summarise(n=n(),
            pct.sup = round(sum(if.sup == "Y")/n*100, digits = 1),
            pct.6th = round(sum(sup == 6)/sum(if.sup == "Y")*100, digits = 1),
            pct.7th = round(sum(sup == 7)/sum(if.sup == "Y")*100, digits = 1),
            #n.pmd = sum(final.fate == "pmd"),
            pct.pup = round(n-sum(final.fate == "pmd")/n, digits = 1),
            pct.slow = round(sum(ignore.reason == "slow")/n*100, digits = 1))
```



# 2.0 overall growth trends; end points

compare overall development of all individuals compared to average growth

## - set up the df
```{r}
# pull out the lab bugs
long_lf <- long_all %>% filter(pop == "lab" | pop == "field") 

# individual dev stats
dev_L <- long_lf %>%
  filter(!(final.fate == "pmd" | final.fate == "misc")) %>%
  filter.ins.topup() %>%
  mutate(logmass = log(mass))

devsumm_L <- dev_L %>%
  group_by(pop, trt.stage, instar) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.tt = mean(na.omit(tt)),
            se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt))),
            avg.logmass = mean(na.omit(logmass)),
            se.logmass = sd(na.omit(logmass))/sqrt(length(na.omit(logmass))),
            n=n())
  
```

## - plot temps
```{r}
temps_dev <- dev_L %>% filter(pop == "lab") %>% filter.temps()
temps_devsumm <- devsumm_L %>% filter(pop == "lab") %>% filter.temps()

temps_devsumm %>%
  ggplot(aes(x=avg.tt, y=avg.logmass, color=trt.stage)) +
  geom_line() +
  geom_point(data=temps_dev, aes(x=tt, y=logmass, color=trt.stage), alpha = 0.15) + 
  geom_point(aes(shape = instar), size = 3) +
  #y_err_logmass(0.5) + x_err_tt(1) +
  temp_aes() +
  labs(title = "temps: average development from 3rd - pupa", color = "treatment", y = "log(mass (mg))", x = "days to instar",
       caption = "lab, no pmd, enter at hatch")

temps_devP <- temps_dev %>% filter(instar == "pupa")
temps_devsummP <- dev_L %>%
  filter.temps() %>%
  group_by(trt.stage, sex, instar) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.tt = mean(na.omit(tt)),
            se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt)))) %>% 
  filter(instar == "pupa")

temps_devsummP %>%
  ggplot(aes(x=avg.tt, y=avg.mass, color=trt.stage)) +
  geom_point(size = 2) +
  geom_point(data=temps_devP, aes(x=tt, y=mass, color=trt.stage), alpha = 0.275) +
  y_err_mass(0.5) + x_err_tt(1) +
  temp_aes() + facet_wrap(~sex) +
  labs(title = "temps: average development to pupa", color = "treatment", y = "mass (mg)", x = "days to instar")
```

## - plot acc
```{r}
acc_dev <- dev_L %>% filter(pop == "lab") %>% filter.acc()
acc_devsumm <- devsumm_L %>% filter(pop == "lab") %>% filter.acc()

acc_devsumm %>%
  ggplot(aes(x=avg.tt, y=avg.logmass, color=trt.stage)) +
  geom_line() +
  geom_point(aes(shape = instar), size = 3) +
  geom_point(data=acc_dev, aes(x=tt, y=logmass, color=trt.stage), alpha = 0.25) + 
  acc_aes() +
  labs(title = "accumulation: average development from 3rd - pupa", color = "treatment", y = "log(mass (mg))", x = "days to instar",
       caption = "lab, no pmd, at 26 +/- 0 until enter trt")

acc_devP <- acc_dev %>% filter(instar == "pupa")
acc_devsummP <- dev_L %>%
  filter.acc() %>%
  group_by(trt.stage, sex, instar) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.tt = mean(na.omit(tt)),
            se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt)))) %>% 
  filter(instar == "pupa")

acc_devsummP %>%
  ggplot(aes(x=avg.tt, y=avg.mass, color=trt.stage)) +
  geom_point(size = 2) +
  geom_point(data=acc_devP, aes(x=tt, y=mass, color=trt.stage), alpha = 0.275) +
  y_err_mass(0.5) + x_err_tt(1) +
  acc_aes() + facet_wrap(~sex) +
  labs(title = "accumulation: average development to pupa", color = "treatment", y = "mass (mg)", x = "days to instar")
```

## - plot NTs
```{r}
NT_dev <- dev_L %>% filter.NTs()
NT_devsumm <- devsumm_L %>% filter.NTs()

NT_devsumm %>%
  ggplot(aes(x=avg.tt, y=avg.logmass, color=trt.stage)) +
  geom_line() +
  geom_point(aes(shape = instar), size = 3) +
  geom_point(data=NT_dev, aes(x=tt, y=logmass, color=trt.stage), alpha = 0.25) + 
  NT_aes() + facet_wrap(~pop) +
  labs(title = "NTs: average development from 3rd - pupa", color = "treatment", y = "log(mass (mg))", x = "days to instar",
       caption = "L+F, no pmd, enter at hatch")

NT_devP <- NT_dev %>% filter(instar == "pupa")
NT_devsummP <- dev_L %>%
  filter.NTs() %>%
  group_by(pop, sex, trt.stage, instar) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.tt = mean(na.omit(tt)),
            se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt)))) %>% 
  filter(instar == "pupa")

NT_devsummP %>%
  ggplot(aes(x=avg.tt, y=avg.mass, color=trt.stage)) +
  geom_point(size = 2) +
  geom_point(data=NT_devP, aes(x=tt, y=mass, color=trt.stage), alpha = 0.275) +
  y_err_mass(0.5) + x_err_tt(1) +
  NT_aes() + facet_wrap(sex~pop) +
  labs(title = "NTs: average development to pupa", color = "treatment", y = "mass (mg)", x = "days to instar")



```

# 3.0 survival to pupation

# 4.0 model?