---
title: "import 2025 tdt data"
date: "2026-01-07"
---

# preamble


## roadmap

-   loading
-   filtering and fixes
    -   filter out bad bugs
    -   fix timepoints (for consistency)
    -   fix weights
    - fix parsing of culled vs died
    - fix instar exits
-   standardising
    -   times
        -   calculate dh cols
        -   recalculate exits for ctrls/culled
        -   convert julian dates
    -   binaries?
        -   determine fates (for KM?)

# loading

## - packages

```{r loading message = FALSE}
library(tidyverse)
library(lubridate) # for datetime parsing
library(googlesheets4)

here::i_am("_tdt/scripts/import.Rmd")
library(here)
```

## - data

```{r import}
# import corrections:
  # prefix "2025" to dates
  # replace commas in notes
  # remove "dv." col bc not correctly calculated in gsheets...
df_raw <-
  read_sheet("https://docs.google.com/spreadsheets/d/1rxZSI-8ubhMkeM2Sh1xNi5IKF0Vt_BDFItAg_Ak476M/edit?gid=1826657546#gid=1826657546",
             sheet = "tdt jun 2025", col_types = "c", na = c("#VALUE!")) %>%
  drop_na() %>% na_if("--") %>% na_if("") %>%
  mutate(across(starts_with("date."), ~ str_c("2025/", .)),
         across(notes, gsub, pattern = ",", replacement = ";")) %>%
  rename(trt = treatment) %>%
  select(-starts_with("dv"))
```

# filtering and fixes
    
## - fix values

filter bugs accidentally culled before 3rd (dont fix `instar.exit` before this)

weights: 
  - drop masses of bugs at molts/return to 40C if they were already dead by the am (weight will not be accurate)

dates/times:
- parsing endpts better:
  - pmc: bugs culled early (ctrls and expts); bc of disease
  - died: 40C bugs dying
  - pmd: cold ctrl bugs dying before 3rd (cohorts B, C)/4th (cohort A)
  - culled: cold ctrl bugs dying after 3rd/4th
- parse culled vs died better: (things with `.culled` should be empty in `.died` and vice versa)
- add return/recovery dates/times to 0hr recovery bugs

fix `instar.exit`

fix `fate`? (based on their expected deaths at 40C trts and survival at other trts)
  - 0 = died
  - 1 = surved to 4th (if expt, which none did) or to 3rd (slow ctrls were culled at 3rd)
  - 2 = culled (i.e. died before 1 or 2; usually disease, for the most part)

```{r fixes}
df_filtered <- df_raw %>%
  # filtering
  ## drop bugs accidentally culled before 3rd
  filter(!(!is.na(date.culled) & instar.exit < 3)) %>%
  
  # fixes
  ## fix masses of bugs if they died in the pm
  pivot_longer(c(ends_with(c("3rd", "4th", "return")), -starts_with(c("h", "time"))),
               names_to = c(".value", "event"), names_sep = "\\.") %>%
  mutate(mass = case_when(date == date.died & when.died == "am" ~ NA_real_,
                          TRUE ~ as.numeric(mass))) %>%
  pivot_wider(names_from = event, values_from = c("date", "mass"),
              names_glue = "{.value}.{event}") %>%
  
  ## add missing dates & times for 0h recovery bugs
  mutate(across(c("date.recover", "date.return"), 
                ~ case_when(trt.duration == 0 ~ date.enter, TRUE ~ .)),
         across(c("time.recover", "time.return"), 
                ~ case_when(trt.duration == 0 ~ time.enter, TRUE ~ .))) %>%
  
  ## better parsing of culled vs died
    ## "pmc" if culled before expected endpt; "culled" if culled after reaching endpt
  mutate(date.pmc = case_when(!is.na(date.culled) & 
                                !grepl("(culled R\\d)|(given)", notes) ~ date.culled),
         date.culled = case_when(!is.na(date.pmc) ~ NA_character_,
                                 !is.na(date.pupa) & is.na(date.culled) ~ date.pupa,
                                 TRUE ~ date.culled),
         
         ## "pmd" if cold ctrl bugs died early
         date.pmd = case_when(trt %in% c(19, 26, 33) & !is.na(date.died) & is.na(date.4th) ~ date.died),
         date.died = case_when(!is.na(date.pmd) ~ NA_character_,
                               TRUE ~ date.died),
         
         ## reassign missing culled times from died times (or arbitrarily assign late in day)
         time.culled = case_when(date.culled == "2025/8/6" ~ "12:00",
                                 date.culled == "2025/6/24" ~ "13:07",
                                 (!is.na(date.culled) | !is.na(date.pmc)) & !is.na(time.died) ~ time.died,
                                 (!is.na(date.culled) | !is.na(date.pmc)) & is.na(time.died) ~ "23:59"),
         
         ## "culled" bugs should be NA in "died" cols
         time.died = case_when(!is.na(time.culled) ~ NA_character_,
                               !is.na(date.died) & is.na(time.died) ~ time.enter, # id:194 was missing
                               TRUE ~ time.died),
         when.died = case_when(!is.na(date.culled) ~ NA_character_,
                               TRUE ~ when.died)) %>%
  
  ## fix instar.exit (dont know if need, but the gsheets is wrong for older bugs lol)
  mutate(instar.exit = case_when(!is.na(date.pupa) ~ "pupa",
                                 !is.na(date.wander) ~ "wander",
                                 !is.na(date.6th) ~ "6",
                                 !is.na(date.5th) ~ "5",
                                 !is.na(date.4th) ~ "4",
                                 !is.na(date.3rd) ~ "3",
                                 !is.na(date.2nd) ~ "2",
                                 TRUE ~ "1")) %>% 
  
  ## fix fates (based on bugs in 40C trts being expected to die)
  ## note: no expt bugs past 4th but not all ctrl bugs to 4th
  mutate(fate = case_when(!is.na(date.pmc) ~ "pmc",
                          !is.na(date.pmd) ~ "pmd",
                          !is.na(date.died) ~ "died",
                          !is.na(date.culled) ~ "culled")
         # fate = case_when(!is.na(date.pmc) ~ "2",
         #                  !is.na(date.culled) | 
         #                    (trt <= 33 & !is.na(date.4th)) ~ "1", # catch straggler ctrls
         #                  !is.na(date.died) ~ "0")
         )

```

## - stdise cols & times

standardise timepts (align everything to `hatch.time` to avoid negatives in `exit.from...` calcs later):
  - R2 d2 pm expt bugs recover time (returned late)
  - R3 d2 expt bugs recover time (data entry typo?)
  - R3 d2 26C bugs enter time (entered late)

stdise col formats and calcs
  - format date times: dh.hatch/enter/recover/return/died/culled
  - assign exit times
  - fix gaps in recover/return/etc
  
add jdate (tho mostly we are interested in the `dd.` cols for analyses)

```{r datetime calcs}
df_cleaned <- df_filtered %>%
  mutate(
    # align timepts
    ## R2 d2 pm expt bugs
    time.return = case_when(date.hatch == "2025/7/7" & trt > 200 &
                              !is.na(date.return) ~ time.hatch,
                            TRUE ~ time.return),
    ## R3 d2 expt bugs
    time.recover = case_when(date.hatch == "2025/7/24" & trt > 100 &
                               !is.na(date.return) ~ as.character(time.hatch),
                             TRUE ~ time.recover)) %>%
    ## R3 d2 26C
  mutate(across(c("time.enter", "time.recover", "time.return"), 
                ~ case_when(date.hatch == "2025/7/25" & trt == 26 ~ "12:00",
                            TRUE ~ .))) %>%
    ## align other times to time.enter for cleaner KMs
  mutate(across(c("time.recover", "time.return"),
                ~ case_when(!is.na(.) & . != time.enter ~ time.enter,
                            TRUE ~ .))) %>% 
  
  # create date-time objs to calc decimal days
  mutate(
         dh.hatch = paste(date.hatch, time.hatch),
         dh.enter = paste(date.enter, time.enter),
         dh.recover = paste(date.recover, time.recover),
         dh.return = paste(date.return, time.return),
         dh.culled = case_when(!is.na(date.culled) ~ paste(date.culled, time.culled),
                               !is.na(date.pmc) ~ paste(date.pmc, time.culled)),
         dh.died = case_when(!is.na(date.died) ~ paste(date.died, time.died),
                             !is.na(date.pmd) ~ paste(date.pmd, time.died))) %>%
  na_if("NA NA") %>% 
  
  ## determine exit times
  mutate(dh.exit = case_when(
                             !is.na(dh.died) ~ dh.died,
                             !is.na(dh.culled) ~ dh.culled,
                             TRUE ~ NA_character_)) %>%

  ## formatting
  # convert date-times (sec) to decimal hours (dh)
  mutate(across(starts_with("date."), ymd),
         across(starts_with("date."), as.numeric), # days
         across(starts_with("dh."), ymd_hm), 
         #across(starts_with("dh."), as.numeric), # seconds
         #across(starts_with("dh."), ~ as.numeric(.)/(60*60*24)) # hours
         across(starts_with("dh."),
                ~ (yday(.)*24 + hour(.) + minute(.)/60))
         ) %>%
  rename_with(., ~paste0("j", .), starts_with("date.")) %>% # days
  mutate(across(c(trt, trt.enter, trt.recover, trt.duration, #fate,
                  id, instar.exit, starts_with(c("mass", "jdate"))), as.numeric))
```

# export

```{r}
today <- format(Sys.time(), "%y%m%d-%H%M")

# export filtered df as raw per corrections
write.csv(df_filtered, file = paste0(here("_tdt/data/raw/"), "dev_", today, ".csv"), row.names = FALSE)

# extract useful stuff
df_cleaned %>%
  select(c("cohort", "shelf", "id", starts_with(c("trt", "jdate", "mass", "dh.")), "fate"),
         -c(ends_with(c("culled", "died", "pmd", "pmc")),
            starts_with("time"))) %>%
  write.csv(., file = paste0(here("_tdt/data/clean/dev.csv")), row.names = FALSE)
```

```{r}
# clean up
rm(df_raw, df_filtered, df_cleaned, export, today)
```
