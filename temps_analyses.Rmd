---
title: "temps_analyses"
date: "2023-12-07"
---

# 0. load data & packages
```{r}
source("./ntw_helper-functions.R")
rm(list=c(acc_helpers, NT_helpers))

library(survival)
library(survminer)

RYB <- c("#324DA0", "#acd2bb", "#f1c363", "#a51122")
```

# 1. pct sup
```{r}
wide_all %>%
  filter.temps2() %>% filter(pop == "lab") %>%
  group_by(treatment) %>%
  summarise(n=n(),
            pct.pmd = round(sum(final.fate == "pmd")/n*100, digits = 1),
            #pct.slow = round(sum(ignore.reason == "slow")/n*100, digits = 1),
            pct.sup = round(sum(if.sup == "Y")/n*100, digits = 1),
            pct.6th = round(sum(sup == 6)/sum(if.sup == "Y")*100, digits = 1),
            pct.7th = round(sum(sup == 7)/sum(if.sup == "Y")*100, digits = 1))
            #n.pmd = sum(final.fate == "pmd"),)

```

## a. barplots
```{r}
# make these into barplots instead

wide_all %>%
  filter.temps2() %>% filter(pop == "lab") %>%
  mutate(sup = factor(sup)) %>%
  ggplot(aes(x = trt.stage, fill = sup)) +
  geom_bar(stat = "count", position = position_fill(reverse = TRUE)) +
  labs(title = "temps: supernumerary fates", fill = "supernumerary stage", x = "treatment", y = "percent") +
  scale_x_discrete(labels = temp_labels) +
  theme_bw() + scale_fill_brewer(palette = "Greens")
```

# *** lowkey ignore ***

i sorta dislike everything under here so we're kinda ignoring it rn (maybe picking + choosing tho)

# overall growth trends; end points

compare overall development of all individuals compared to average growth

## - set up the df (**)
```{r}
# pull out the lab bugs
long_lf <- long_all %>% filter(pop == "lab" | pop == "field") 

# individual dev stats
dev_L <- long_lf %>%
  filter(!(final.fate == "pmd" | final.fate == "misc")) %>%
  filter.ins.topup() %>%
  mutate(logmass = log(mass))

devsumm_L <- dev_L %>%
  group_by(pop, trt.stage, instar) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.tt = mean(na.omit(tt)),
            se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt))),
            avg.logmass = mean(na.omit(logmass)),
            se.logmass = sd(na.omit(logmass))/sqrt(length(na.omit(logmass))),
            n=n())

# for pulling out supernumeraries.. need to tweak
# devsumm_Lsups <- dev_L %>%
#   group_by(pop, sup, trt.stage, instar) %>%
#   summarise(avg.mass = mean(na.omit(mass)),
#             se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
#             avg.tt = mean(na.omit(tt)),
#             se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt))),
#             avg.logmass = mean(na.omit(logmass)),
#             se.logmass = sd(na.omit(logmass))/sqrt(length(na.omit(logmass))),
#             n=n())

# see 'plot NTs' under 'overall growth'
  
```

## - plot temps
```{r}
temps_dev <- dev_L %>% filter(pop == "lab") %>% filter.temps2()
#temps_devsumm <- devsumm_L %>% filter(pop == "lab") %>% filter.temps2()
temps_devsumm <- dev_L %>% filter.temps2() %>% calc.devsumm.trtstg()

temps_devsumm %>%
  filter(instar != "pupa") %>%
  ggplot(aes(x=avg.tt, y=avg.logmass, color=trt.stage)) +
  geom_line() +
  geom_point(data=(temps_dev %>% filter(instar != "pupa")), aes(x=tt, y=logmass, color=trt.stage), alpha = 0.15) + 
  geom_point(aes(shape = instar), size = 3) +
  #y_err_logmass(0.5) + x_err_tt(1) +
  temp_aes() +
  labs(title = "temps: average development from 3rd - wander", color = "treatment", y = "log(mass (mg))", x = "days to instar",
       caption = "lab, no pmd, enter at hatch")

temps_devP <- temps_dev %>% filter(instar == "pupa")
  # tbh can drop lol

temps_devsummP <- dev_L %>%
  filter.temps2() %>%
  group_by(trt.stage, sex, instar) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.tt = mean(na.omit(tt)),
            se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt)))) %>% 
  filter(instar == "pupa")

temps_devsummP %>%
  ggplot(aes(x=avg.tt, y=avg.mass, color=trt.stage)) +
  geom_point(size = 2) +
  geom_point(data=temps_devP, aes(x=tt, y=mass, color=trt.stage), alpha = 0.275) +
  y_err_mass(0.5) + x_err_tt(1) +
  temp_aes() + facet_wrap(~sex) +
  labs(title = "temps: average development to pupa", color = "treatment", y = "mass (mg)", x = "days to instar")


### plot with response on the y (for the pupated only)
# survival vs mean/fluc T
temps_dev
  


# dev rate vs mean/fluc T
temps_devP %>%
  mutate(devrate = 1/tt) %>%
  group_by(meanT, flucT, sex) %>%
  summarise(avg.devrate = mean(devrate)) %>%
  ggplot(aes(y=avg.devrate, x = meanT, shape = as.factor(flucT), lty = as.factor(flucT))) +
  geom_point() + geom_line() +
  facet_wrap(~sex) + theme_bw() +
  labs(y = "average development rate (to pupa)", x = "mean temperature (°C)", shape = "fluctuation (°C)", lty = "fluctuation (°C)")
```

# survival to pupation

## - censoring + subsetting
```{r}
# censor data
surv_P <-  wide_all %>%
  filter(!(final.fate == "ignore" | final.fate == "culled")) %>%
  mutate(censor = case_when(final.fate == "pmd" ~ 1,
                            TRUE ~ 0),
         timeto.exit = jdate.exit - jdate.hatch) %>%
  select(-starts_with(c("h.", "date.", "mass.", "jdate.", "fate.")))

temps_surv <- surv_P %>% filter.temps2()
```

## - create survival objects and fits
```{r}
temps_sobj <- Surv(temps_surv$timeto.exit, temps_surv$censor)
temps_sfit <- survfit(temps_sobj ~ treatment, data = temps_surv)
```

## - plot survival curves
```{r}
ggsurvplot(fit = temps_sfit, data=temps_surv,
           conf.int = T,
           xlab = "days from hatching", ylab = "survival probability",
           title = "temp: survival from hatch-pup",
           #palette = temp_colors,
           palette = c("#00C2D1","#1929B3", "#F9C639", "#710A36"),
           legend.title = "treatment", 
           legend.labs = temp_labels
           ) +
  labs(caption = "(uses actual cohort; ignores 'ignores' + 'culled')")
```

# cox-ph survival stuff?

- check as variables: lab/TB diet; if.sup; if.stuck

##  - if sup x to pup/eclosion

```{r}
#check_suppup <- wide_all %>% filter(if.pupa == "Y")

#mod_suppup <- lm(if.pupa ~ if.sup + treatment + pop, data = check_suppup, na.action=na.omit)
  # does this not work bc Y needs to be a # LOL

# i think this shoudl be part of survival stuff

```

# x=trt, y = response graphs

```{r}
# subset data
temps_all <- wide_all %>% filter.temps2()

#ggplot()

```


# *** ok restarting here lol ***

(this mostly takes the code from `overall_controls.Rmd` LOL)

# 2. visualise growth, dev, surv

## a. calc stats
```{r calculate stats}
# filter out pupal stuff & the correct bugs lol
temps_all <- wide_all %>%
  filter.temps2() %>%
  filter(final.fate != "misc" & final.fate != "accidental" & final.fate != "culled") %>%
  mutate(tt.pupa = jdate.pupa - jdate.hatch)

# calculate the pup stats we're interested in
summary_temps <- temps_all %>%
  group_by(meanT, flucT) %>%
  summarise(avg.tt = mean(na.omit(jdate.pupa - jdate.hatch)),
            se.tt = sd(na.omit(jdate.pupa - jdate.hatch))/sqrt(length(na.omit(jdate.pupa - jdate.hatch))),
            avg.mass = mean(na.omit(mass.pupa)),
            se.mass = sd(na.omit(mass.pupa)/sqrt(length(na.omit(mass.pupa)))),
            n_all = n(),
            n_pmd = sum(final.fate == "pmd"), 
            prop.survpup = round(1-(n_pmd/n_all), digits=2))
  # mutate(meanT = as.factor(meanT),
  #        flucT = as.factor(flucT))
  # # nvm lets NOT do this bc i'll forget to fix when we do the surv stuff
```


## b. plots

```{r plot}
# visualise time to pup, pupal mass across expt groups
summary_temps %>% ggplot(aes(y = avg.mass, x = avg.tt, color = as.factor(meanT), shape = as.factor(flucT))) +
  geom_point(size = 2.5) +
  y_err_mass(y_err= 0.1) + x_err_tt(x_err = 100) + theme_bw() +
  labs(title = "2x2: avg time to and mass at pupation", 
       y = "average pupal mass (mg)", 
       x = "average time to pupa from hatching (days)", 
       caption = "all lab",
       shape = "fluctuation temp", color = "mean temp") +
  scale_color_manual(labels = c("26°C", "33°C"), 
                     values = c("#00BFC4", "#F8766D")) +
  scale_shape_discrete(labels = c("± 0°C", "± 7°C"))

# eyeeee dk what this means honestly LOLLL (not sure how to make sense of it)
```
so... hotter mean = lower mass. higher fluct = longer tt pup...

let's try to not plot 80 things at once and just put 1 response var on the y lol

```{r plot 1 response var at a time}
# avg pup mass due to temp
summary_temps %>% ggplot(aes(y = avg.mass, x = as.factor(meanT), shape = as.factor(flucT))) +
  geom_point(size = 2) + geom_text(aes(label = n_all), vjust = -1.1, hjust = -0.5) +
  geom_line(aes(lty = as.factor(flucT), group = flucT)) +
  y_err_mass(y_err = 0.04) + theme_bw() +
  labs(title = "2x2: avg mass at pupation", 
       y = "average pupal mass (mg)", 
       x = "mean temp (°C)", 
       caption = "all lab; N",
       shape = "fluctuation temp", lty = "fluctuation temp") +
  scale_shape_discrete(labels = c("± 0°C", "± 7°C")) +
  scale_linetype_discrete(labels = c("± 0°C", "± 7°C"))
  
# avg tt pupa due to temp
summary_temps %>% ggplot(aes(y = avg.tt, x = as.factor(meanT), shape = as.factor(flucT))) +
  geom_point(size = 2) + geom_text(aes(label = n_all), vjust = -1.1, hjust = -0.5) +
  geom_line(aes(lty = as.factor(flucT), group = flucT)) +
  y_err_tt(y_err = 0.04) + theme_bw() +
  labs(title = "2x2: avg time to pupation", 
       y = "average time to pupation from hatching (days)", 
       x = "mean temp (°C)", 
       caption = "all lab; N",
       shape = "fluctuation temp", lty = "fluctuation temp") +
  scale_shape_discrete(labels = c("± 0°C", "± 7°C")) +
  scale_linetype_discrete(labels = c("± 0°C", "± 7°C"))

# avg surv due to temp
summary_temps %>% ggplot(aes(y = prop.survpup, x = as.factor(meanT), shape = as.factor(flucT))) +
  geom_point(size = 2) + 
  #geom_text(aes(label = n_all), vjust = -1.1, hjust = -0.5, position = position_jitter()) +
  geom_line(aes(lty = as.factor(flucT), group = flucT)) +
  theme_bw() + 
  #geom_blank(aes(y=1.0095)) +
  # expand_limits(y = c(0.87, 1.025)) +
  labs(title = "2x2: proportion survived to pupation", 
       y = "prop. survived to pupation", 
       x = "mean temp (°C)", 
       caption = "all lab; N",
       shape = "fluctuation temp", lty = "fluctuation temp") +
  scale_shape_discrete(labels = c("± 0°C", "± 7°C")) +
  scale_linetype_discrete(labels = c("± 0°C", "± 7°C"))

```


```{r KM curve}
# KM curve

# add binaries and fit model
temps_all <- temps_all %>% 
  mutate(status = case_when(final.fate == "pmd" ~ 1,
                            TRUE ~ 0),
         tt.exit = jdate.exit - jdate.hatch)

# kmfit.temps <- survfit(Surv(temps_all$tt.exit, temps_all$status) ~ meanT*flucT, data = temps_all)
  # this doesnt work bc u cant do int terms. til

kmfit.temps <- survfit(Surv(temps_all$tt.exit, temps_all$status) ~ treatment, data = temps_all)

# plot
ggsurvplot(fit = kmfit.temps, data = temps_all,
           conf.int = TRUE,
           palette = RYB)
```

- this KM curve is not really interesting (everything overlaps + surv is high overall) so we'll just leave it here!
  - altho probably of note is that the mean=33 does separate out from mean=26 (lower survival). but again the probabilies/CIs are close/overlap so.
  
let's move into models!

# 3. modeling

lets confirm what our graphs suggest + look for interactions/or lack thereof.

## a. pup mass

graphs suggest there is no mean/fluct int: let's confirm

```{r}
mod.mass <- lm(mass.pupa ~ meanT*flucT, data = temps_all)
anova(mod.mass)
summary(mod.mass)
  # meanT + flucT are sig on their own (***) and (**) but not the interaction
  # lowkey why is SS sooo big for mean tho LOL

# add sex as an additional check. sex shoooould be signif
mod.mass2 <- lm(mass.pupa ~ meanT*flucT*sex, data = temps_all)
anova(mod.mass2) # (it is)

# since the MxF interaction isnt signif, drop it from the model
mod.mass4 <- lm(mass.pupa ~ meanT + flucT, data = temps_all)
anova(mod.mass4)
summary(mod.mass4) ## use this!

# is this different for those that survived to pupae?
mod.mass5 <- lm(mass.pupa ~ meanT*flucT, 
                data = temps_all[temps_all$if.pupa == "Y", ])
anova(mod.mass5)
  # not really
```


## b. tt pup

confirm there there is a signif interaction btwn mean/fluct

```{r}
mod.tt <- lm(tt.pupa ~ meanT*flucT, data = temps_all)
anova(mod.tt) # fuller model is better
summary(mod.tt) # all the things matter

# let's add sex? (there shouldnt be anything)
mod.tt2 <- lm(tt.pupa ~ meanT*flucT*sex, data = temps_all)
summary(mod.tt2) # a little but not rly an effect of sex so w/e
anova(mod.tt2)

```


## c. survival

probably nothing of note will arise but we can add the glms in here anyway

```{r}
# what affects overall survival?
mod.surv <- glm(status ~ meanT*flucT, data = temps_all, family = binomial)
summary(mod.surv)
  # in this expt, neither of these LOL
```


(previous nts: as a followup to km plot -> model w/ glms?)





(testing...)
```{r}
# let's isolate more... just masspup
summary_lab260 %>% ggplot(aes(y = avg.mass, x = expt.group, fill = expt.group)) +
  geom_col() +
  y_err_mass(y_err= 0.9) + theme_bw() +
  scale_fill_hue(labels = c("A (n = 21)",
                                "B (n = 16)",
                                "D (n = 18)",
                                "F (n = 19)")) +
  labs(title = "avg mass at pupation for lab controls", 
       y = "average pupal mass", 
       x = "expt group", 
       caption = "C omitted bc of culling; D = diurnal, F = diurnal + TB diet")

# just tt pup
summary_lab260 %>% ggplot(aes(y = avg.tt, x = expt.group, fill = expt.group)) +
  geom_col() +
  y_err_tt(y_err= 0.9) + theme_bw() +
  scale_fill_hue(labels = c("A (n = 21)",
                                "B (n = 16)",
                                "D (n = 18)",
                                "F (n = 19)")) +
  labs(title = "avg time to pupation for lab controls", 
       y = "average time to pupation from hatching", 
       x = "expt group", 
       caption = "C omitted bc of culling; D = diurnal, F = diurnal + TB diet")

# visualise % survival
summary_lab260 %>% ggplot(aes(y = pct.survpup, fill = expt.group, x = expt.group)) +
  geom_col() + theme_bw() +
  #y_err(avg.mass, se.mass) + #SIGH
  # scale_fill_hue(labels = c("A (n = 21)",
  #                            "B (n = 16)",
  #                            "D (n = 18)",
  #                            "F (n = 19)")) +
  geom_text(aes(label = paste0("n = ", n_all), y = 10), check_overlap = TRUE) +
  labs(title = "% survived to pupation (incl LPI)", 
       y = "% surviving", 
       x = "expt group/cohort", 
       caption = "C omitted bc of culling; D = diurnal, F = diurnal + TB diet")
```




