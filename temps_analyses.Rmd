---
title: "temps_analyses"
date: "2023-12-07"
---

# 0 load data & packages
```{r}
source("./ntw_helper-functions.R")
rm(list=c(acc_helpers, NT_helpers))

library(survival)
library(survminer)
```

# 2.0 super simple stats
```{r}
wide_all %>%
  filter.temps2() %>% filter(pop == "lab") %>%
  group_by(treatment) %>%
  summarise(n=n(),
            pct.pmd = round(sum(final.fate == "pmd")/n*100, digits = 1),
            #pct.slow = round(sum(ignore.reason == "slow")/n*100, digits = 1),
            pct.sup = round(sum(if.sup == "Y")/n*100, digits = 1),
            pct.6th = round(sum(sup == 6)/sum(if.sup == "Y")*100, digits = 1),
            pct.7th = round(sum(sup == 7)/sum(if.sup == "Y")*100, digits = 1))
            #n.pmd = sum(final.fate == "pmd"),)

```

## - sup barplots
```{r}
# make these into barplots instead

wide_all %>%
  filter.temps2() %>% filter(pop == "lab") %>%
  mutate(sup = factor(sup)) %>%
  ggplot(aes(x = trt.stage, fill = sup)) +
  geom_bar(stat = "count", position = position_fill(reverse = TRUE)) +
  labs(title = "temps: supernumerary fates", fill = "supernumerary stage", x = "treatment", y = "percent") +
  scale_x_discrete(labels = temp_labels) +
  theme_bw() + scale_fill_brewer(palette = "Greens")
```

# 3.0 overall growth trends; end points

compare overall development of all individuals compared to average growth

## - set up the df (**)
```{r}
# pull out the lab bugs
long_lf <- long_all %>% filter(pop == "lab" | pop == "field") 

# individual dev stats
dev_L <- long_lf %>%
  filter(!(final.fate == "pmd" | final.fate == "misc")) %>%
  filter.ins.topup() %>%
  mutate(logmass = log(mass))

devsumm_L <- dev_L %>%
  group_by(pop, trt.stage, instar) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.tt = mean(na.omit(tt)),
            se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt))),
            avg.logmass = mean(na.omit(logmass)),
            se.logmass = sd(na.omit(logmass))/sqrt(length(na.omit(logmass))),
            n=n())

# for pulling out supernumeraries.. need to tweak
# devsumm_Lsups <- dev_L %>%
#   group_by(pop, sup, trt.stage, instar) %>%
#   summarise(avg.mass = mean(na.omit(mass)),
#             se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
#             avg.tt = mean(na.omit(tt)),
#             se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt))),
#             avg.logmass = mean(na.omit(logmass)),
#             se.logmass = sd(na.omit(logmass))/sqrt(length(na.omit(logmass))),
#             n=n())

# see 'plot NTs' under 'overall growth'
  
```

## - plot temps
```{r}
temps_dev <- dev_L %>% filter(pop == "lab") %>% filter.temps2()
#temps_devsumm <- devsumm_L %>% filter(pop == "lab") %>% filter.temps2()
temps_devsumm <- dev_L %>% filter.temps2() %>% calc.devsumm.trtstg()

temps_devsumm %>%
  filter(instar != "pupa") %>%
  ggplot(aes(x=avg.tt, y=avg.logmass, color=trt.stage)) +
  geom_line() +
  geom_point(data=(temps_dev %>% filter(instar != "pupa")), aes(x=tt, y=logmass, color=trt.stage), alpha = 0.15) + 
  geom_point(aes(shape = instar), size = 3) +
  #y_err_logmass(0.5) + x_err_tt(1) +
  temp_aes() +
  labs(title = "temps: average development from 3rd - wander", color = "treatment", y = "log(mass (mg))", x = "days to instar",
       caption = "lab, no pmd, enter at hatch")

temps_devP <- temps_dev %>% filter(instar == "pupa")
  # tbh can drop lol

temps_devsummP <- dev_L %>%
  filter.temps2() %>%
  group_by(trt.stage, sex, instar) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.tt = mean(na.omit(tt)),
            se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt)))) %>% 
  filter(instar == "pupa")

temps_devsummP %>%
  ggplot(aes(x=avg.tt, y=avg.mass, color=trt.stage)) +
  geom_point(size = 2) +
  geom_point(data=temps_devP, aes(x=tt, y=mass, color=trt.stage), alpha = 0.275) +
  y_err_mass(0.5) + x_err_tt(1) +
  temp_aes() + facet_wrap(~sex) +
  labs(title = "temps: average development to pupa", color = "treatment", y = "mass (mg)", x = "days to instar")


### plot with response on the y (for the pupated only)
# survival vs mean/fluc T
temps_dev
  


# dev rate vs mean/fluc T
temps_devP %>%
  mutate(devrate = 1/tt) %>%
  group_by(meanT, flucT, sex) %>%
  summarise(avg.devrate = mean(devrate)) %>%
  ggplot(aes(y=avg.devrate, x = meanT, shape = as.factor(flucT), lty = as.factor(flucT))) +
  geom_point() + geom_line() +
  facet_wrap(~sex) + theme_bw() +
  labs(y = "average development rate (to pupa)", x = "mean temperature (°C)", shape = "fluctuation (°C)", lty = "fluctuation (°C)")
```

# 4.0 survival to pupation

## - censoring + subsetting
```{r}
# censor data
surv_P <-  wide_all %>%
  filter(!(final.fate == "ignore" | final.fate == "culled")) %>%
  mutate(censor = case_when(final.fate == "pmd" ~ 1,
                            TRUE ~ 0),
         timeto.exit = jdate.exit - jdate.hatch) %>%
  select(-starts_with(c("h.", "date.", "mass.", "jdate.", "fate.")))

temps_surv <- surv_P %>% filter.temps2()
```

## - create survival objects and fits
```{r}
temps_sobj <- Surv(temps_surv$timeto.exit, temps_surv$censor)
temps_sfit <- survfit(temps_sobj ~ treatment, data = temps_surv)
```

## - plot survival curves
```{r}
ggsurvplot(fit = temps_sfit, data=temps_surv,
           conf.int = T,
           xlab = "days from hatching", ylab = "survival probability",
           title = "temp: survival from hatch-pup",
           #palette = temp_colors,
           palette = c("#00C2D1","#1929B3", "#F9C639", "#710A36"),
           legend.title = "treatment", 
           legend.labs = temp_labels
           ) +
  labs(caption = "(uses actual cohort; ignores 'ignores' + 'culled')")
```

# 5.0 cox-ph survival stuff?

- check as variables: lab/TB diet; if.sup; if.stuck

##  - if sup x to pup/eclosion

```{r}
#check_suppup <- wide_all %>% filter(if.pupa == "Y")

#mod_suppup <- lm(if.pupa ~ if.sup + treatment + pop, data = check_suppup, na.action=na.omit)
  # does this not work bc Y needs to be a # LOL

# i think this shoudl be part of survival stuff

```

# 6.0 x=trt, y = response graphs

```{r}
# subset data
temps_all <- wide_all %>% filter.temps2()

ggplot()






```

