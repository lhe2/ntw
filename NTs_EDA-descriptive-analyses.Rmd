---
title: "NTs_EDA and decriptive analyses"
date: "2024-01-08"
---

# 0. load data, packages, helper functions
```{r}
source("./ntw_helper-functions.R")
rm(list=c(acc_helpers, temps_helpers))
```


TODO 240108: at some point i need to reorganise this probably (idk how much of these are descriptive but not today!)

# 0.1 questions/responses of interest

- within the NTs, how many go sup? what's the breakdown (if any)? do certain trts lead to more sup?
- what does overall larval growth look like? (i.e. mass gained per day?)
- pupal response: final pupal mass? time to pup? survival to pup? survival dynamics?
  - break it down by min T (maybe mean/flucT later...)
  - can we use the 2x2 results to inform?
- diet/sex effects?


# A. looking for sups

**questions:** how many go sup? how many die early? how many are slow?

## - look at summary stats and pcts

```{r summ stats}
# NT stats
wide_all %>%
  filter.NTs2() %>% filter(pop == "field") %>%
  group_by(treatment) %>%
  summarise(field_n=n(),
            pct.pmd = round(sum(final.fate == "pmd")/field_n*100, digits = 1),
            #pct.slow = round(sum(ignore.reason == "slow")/n*100, digits = 1),
            pct.sup = round(sum(if.sup == "Y")/field_n*100, digits = 1),
            pct.6th = round(sum(sup == 6)/sum(if.sup == "Y")*100, digits = 1),
            pct.7th = round(sum(sup == 7)/sum(if.sup == "Y")*100, digits = 1))
            #n.pmd = sum(final.fate == "pmd"),

wide_all %>%
  filter.NTs2() %>% filter(pop == "lab") %>%
  group_by(treatment) %>%
  summarise(lab_n=n(),
            pct.pmd = round(sum(final.fate == "pmd")/lab_n*100, digits = 1),
            #pct.slow = round(sum(ignore.reason == "slow")/n*100, digits = 1),
            pct.sup = round(sum(if.sup == "Y")/lab_n*100, digits = 1),
            pct.6th = round(sum(sup == 6)/sum(if.sup == "Y")*100, digits = 1),
            pct.7th = round(sum(sup == 7)/sum(if.sup == "Y")*100, digits = 1))

```

### - visualise with barplots

```{r sup barplots}
# make these into barplots instead

wide_all %>%
  filter.NTs2() %>% 
  #filter(!(pop == "lab" & diet == "TB")) %>%
  filter(pop != "F1") %>%
  mutate(sup = factor(sup)) %>%
  ggplot(aes(x = trt.stage, fill = sup)) +
  geom_bar(stat = "count", position = position_fill(reverse = TRUE)) +
  labs(title = "NTs: supernumerary fates", fill = "supernumerary stage", x = "treatment", y = "percent") +
  scale_x_discrete(labels = NT_labels, guide = guide_axis(angle = 45)) +
  facet_wrap(~pop) +
  theme_bw() + scale_fill_brewer(palette = "Greens") 
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, hjust=1))

# did i filter out the diet stuff...
  
```

# B1. growth per day; end points

compare overall development of all individuals compared to average growth (avg growth over time)

## - (**) prep the dfs for plotting

(**) calculate summary growth stats df 
  - there's a lot of downstream code that relies on this codeblock LOL hence the (**)
```{r calc dev_L stats df} 
# pull out the lab bugs
long_lf <- long_all %>% filter(pop == "lab" | pop == "field") 

# individual dev stats
dev_L <- long_lf %>%
  filter(!(final.fate == "pmd" | final.fate == "misc")) %>%
  filter.ins.topup() %>%
  mutate(logmass = log(mass))

# do the summary stats
devsumm_L <- dev_L %>%
  group_by(pop, trt.stage, instar) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.tt = mean(na.omit(tt)),
            se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt))),
            avg.logmass = mean(na.omit(logmass)),
            se.logmass = sd(na.omit(logmass))/sqrt(length(na.omit(logmass))),
            n=n())

# for pulling out supernumeraries.. need to tweak
# devsumm_Lsups <- dev_L %>%
#   group_by(pop, sup, trt.stage, instar) %>%
#   summarise(avg.mass = mean(na.omit(mass)),
#             se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
#             avg.tt = mean(na.omit(tt)),
#             se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt))),
#             avg.logmass = mean(na.omit(logmass)),
#             se.logmass = sd(na.omit(logmass))/sqrt(length(na.omit(logmass))),
#             n=n())

# see 'plot NTs' under 'overall growth'
  
```

filter the relevant bugs out for plotting
```{r filter out NT bugs from dev_L}
NT_dev <- dev_L %>% filter.NTs2()
#NT_devsumm <- devsumm_L %>% filter.NTs()
NT_devsumm <- dev_L %>% filter.NTs2() %>% calc.devsumm.trtstg()
```

make another df with summary stats for the sup bugs for plotting:

```{r another df with sups pulled out}
#NTsups_devsumm <- devsumm_Lsups %>% filter.NTs2()
NTsups_devsumm <- NT_dev %>%
  group_by(pop, sup, trt.stage, instar) %>%
  calc.devsumm() %>%
  mutate(if.sup = case_when(sup == 0 ~ "N", TRUE ~ "Y"))
```

### - line plots

### - all bugs larval instars
plot avg growth of all bugs (sups included in math)
```{r avg larval growth all bugs}
NT_devsumm %>%
  #filter(!(instar == "3rd" | instar == "pupa")) %>%
  filter(instar != "pupa") %>%
  #filter(sup == 0) %>%
  ggplot(aes(x=avg.tt, y=avg.logmass, color=trt.stage)) +
  geom_line() +
  geom_point(aes(shape = instar), size = 3) +
  geom_point(data=(NT_dev %>% filter(instar != "pupa")), aes(x=tt, y=logmass, color=trt.stage), alpha = 0.25) + 
  NT_aes() + facet_wrap(~pop) +
  labs(title = "NTs: average development from 3rd - wander", color = "treatment", y = "log(mass (mg))", x = "days to instar",
       caption = "L+F, no pmd, enter at hatch")
```

==> this is hard to separate out the sups and imo shouldnt do the math w the sups + non-sups combined, so:


### - sup bugs separated
plot avg growth bugs but separate out the sups

(so 3 groups total: bugs with 1-5 instars, bugs that had 6th, bugs that had 7th)
```{r avg larval growth separate sups}
# plot only from 4th instar onward bc 3rd looks the same, basically
NTsups_devsumm %>%
  filter(!(instar == "3rd" | instar == "pupa")) %>%
  ggplot(aes(x=avg.tt, y=avg.logmass, color=trt.stage)) +
  geom_line(aes(lty = as.factor(sup))) +
  geom_point(aes(shape = instar), size = 3) +
  geom_point(data=NT_dev, aes(x=tt, y=logmass, color=trt.stage), alpha = 0.25) + 
  NT_aes() + facet_wrap(if.sup~pop) +
  labs(title = "NTs: average development from 4th - wander", color = "treatment", y = "log(mass (mg))", x = "days to instar",
       caption = "L+F, no pmd, enter at hatch")
```


still messy. try again but add sup as a Y/N
```{r var}
# trying this again adding "if.sup" as Y/N
  # a little better but still hard to compare
NTsups_devsumm %>%
  filter(!(instar == "3rd" | instar == "pupa")) %>%
  ggplot(aes(x=avg.tt, y=avg.logmass, color=trt.stage)) +
  geom_line(aes(lty = as.factor(sup))) +
  geom_point(aes(shape = instar), size = 3) +
  geom_point(data=NT_dev, aes(x=tt, y=logmass, color=trt.stage), alpha = 0.25) + 
  NT_aes() + facet_wrap(~pop) +
  labs(title = "NTs: average development from 4th - wander", color = "treatment", y = "log(mass (mg))", x = "days to instar",
       caption = "L+F, no pmd, enter at hatch")
```

try again, focusing on the trt.stages that produce sups instead
```{r var}
NTsups_devsumm %>%
  filter(!(instar == "3rd" | instar == "pupa")) %>%
  #filter(if.sup == "Y") %>%
  ggplot(aes(x=avg.tt, y=avg.logmass, color=trt.stage)) +
  geom_line(aes(lty = as.factor(sup))) +
  geom_point(aes(shape = instar), size = 3) +
  geom_point(data=NT_dev, aes(x=tt, y=logmass, color=trt.stage), alpha = 0.25) + 
  NT_aes() + facet_wrap(if.sup~pop) +
  labs(title = "NTs: average development from 4th - wander", color = "treatment", y = "log(mass (mg))", x = "days to instar",
       caption = "L+F, no pmd, enter at hatch") +
  scale_x_continuous(expand = c(0.001, 1))
```

try faceting differently:
```{r var}
NTsups_devsumm %>%
  filter(!(instar == "3rd" | instar == "pupa")) %>%
  #filter(if.sup == "Y") %>%
  ggplot(aes(x=avg.tt, y=avg.logmass, color=trt.stage)) +
  geom_line(aes(lty = as.factor(sup))) +
  geom_point(aes(shape = instar), size = 3) +
  geom_point(data=NT_dev, aes(x=tt, y=logmass, color=trt.stage), alpha = 0.25) + 
  NT_aes() + facet_wrap(sup~pop, nrow=3) +
  labs(title = "NTs: average development from 4th - wander", color = "treatment", y = "log(mass (mg))", x = "days to instar",
       caption = "L+F, no pmd, enter at hatch") +
    scale_x_continuous(expand = c(0.001, 1))
```

apparently i really liked this next plot
```{r var}
# this is it...
  #but need to filter out the lab bugs on TB/regular diet i think
NTsups_devsumm %>%
  filter(!(instar == "3rd" | instar == "pupa")) %>%
  ggplot(aes(x=avg.tt, y=avg.logmass, color=trt.stage)) +
  geom_line(aes(lty = as.factor(sup))) +
  geom_point(aes(shape = instar), size = 3) +
  geom_point(data=NT_dev, aes(x=tt, y=logmass, color=trt.stage), alpha = 0.25) + 
  NT_aes() + facet_wrap(pop~trt.stage, ncol=4) +
  labs(title = "NTs: average development from 4th - wander", color = "treatment", y = "log(mass (mg))", x = "days to instar",
       caption = "L+F, no pmd, enter at hatch") 
```

#### - pupa/endpoints only

calculate the stats
```{r pupa dev summ stats}
NT_devP <- NT_dev %>% filter(instar == "pupa")
NT_devsummP <- dev_L %>%
  filter.NTs2() %>%
  group_by(pop, sex, trt.stage, instar) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.tt = mean(na.omit(tt)),
            se.tt = sd(na.omit(tt))/sqrt(length(na.omit(tt)))) %>% 
  filter(instar == "pupa")
```

graph it
```{r plot}
NT_devsummP %>%
  ggplot(aes(x=avg.tt, y=avg.mass, color=trt.stage)) +
  geom_point(size = 2) +
  geom_point(data=NT_devP, aes(x=tt, y=mass, color=trt.stage), alpha = 0.275) +
  y_err_mass(0.5) + x_err_tt(1) +
  NT_aes() + facet_wrap(sex~pop) +
  labs(title = "NTs: average development to pupa", color = "treatment", y = "mass (mg)", x = "days to instar")
```

# C1. (old) growth response as a function of treatment 

(keeping these bc theyre mostly fine but going to ignore the sex stuff a bit lol. we can get into it later. use C2 instead!

prep the df:
```{r filter NTs from larger dataset}
# subset data
long_NTs <- long_all %>% 
  #filter(is.NA(ignore.reason)) %>%
  filter.NTs2()
  # "slows" are messing things up
```

- mass.pup ~ meanT
```{r}
long_NTs %>%
  #filter(ignore.reason == "NA") %>%
  filter(instar == "pupa") %>%
  group_by(pop, sex, meanT) %>%
  calc.devsumm() %>%
  ggplot(aes(x = meanT, y = avg.mass)) +
  geom_point() +
  geom_line(aes(lty = pop)) +
  y_err_mass(y_err=0.5) +
  facet_wrap(~sex) +
  theme_bw() +
  labs(title = "NT: mean temperatures on pupal mass", caption = "NT pupa")
```

- mass.pup ~ flucT

```{r}
long_NTs %>%
  filter(instar == "pupa") %>%
  #filter(!is.NA(ignore.reason)) %>%
  group_by(pop, sex, flucT) %>%
  calc.devsumm() %>%
  ggplot(aes(x = flucT, y = avg.mass)) +
  geom_point() +
  geom_line(aes(lty = pop)) +
  y_err_mass(y_err=0.5) +
  facet_wrap(~sex) +
  theme_bw() +
  labs(caption = "NT pupa")
  # smth is breaking bc this doesnt match the above LOL
```

- mass.pup ~ minT

this is the interesting one bc everyone has the same max T... altho it's lowkey the same as just plotting by `trt.stage` or something. it's more intuitive though, looking at graph-wise.
  - upon 2nd look this is wonky bc of the 26 group lol (theres' 26/26 and 40/26)
```{r}
long_NTs %>%
  #filter(ignore.reason == "NA") %>%
  filter(instar == "pupa") %>%
  group_by(pop, sex, minT) %>%
  calc.devsumm() %>%
  ggplot(aes(x = minT, y = avg.mass)) +
  geom_point() +
  geom_line(aes(lty = pop)) +
  y_err_mass(y_err=0.5) +
  facet_wrap(~sex) +
  theme_bw() +
  labs(title = "NT: min temperatures on pupal mass", caption = "NT pupa")
  # this breaks so much LOL
```

- tt.pup ~ meanT
```{r}
long_NTs %>%
  #filter(ignore.reason == "NA") %>%
  filter(instar == "pupa") %>%
  group_by(pop, sex, meanT) %>%
  calc.devsumm() %>%
  ggplot(aes(x = meanT, y = avg.tt)) +
  geom_point() +
  geom_line(aes(lty = pop)) +
  y_err_tt(y_err=0.5) +
  facet_wrap(~sex) +
  theme_bw() +
  labs(title = "NT: mean temperatures on time to pupation", caption = "NT pupa")
```

- pct.surv ~ meanT
```{r}
long_NTs %>%
  #filter(ignore.reason == "NA") %>%
  #filter(instar == "pupa") %>%
  #filter(sex != "NA") %>%
  group_by(pop, meanT) %>%
  summarise(n_all=n(),
            n_pmd = sum(final.fate == "pmd"),
            pct.surv = 100-round(n_pmd/n_all*100, digits = 1)) %>% 
  ggplot(aes(x = meanT, y = pct.surv)) +
  geom_point() +
  geom_line(aes(lty = pop)) +
  #facet_wrap(~sex) +
  theme_bw() +
  labs(title = "NT: mean temperatures on % survival to pupation", caption = "NT pupa")

```


# C2. visualise overview summ stats

going to make these graphs more like the ones from `temp_analyses` (expect code borrowing lol)

## - calc summ stats
```{r}
# subset + add some binaries for survival stuff later
NTs_all <- wide_all %>%
  filter.NTs2() %>%
  filter(final.fate != "misc" & final.fate != "accidental" & final.fate != "culled") %>%
  mutate(tt.pupa = jdate.pupa - jdate.hatch,
         status = case_when(final.fate == "pmd" ~ 1, 
                            TRUE ~ 0),
         tt.exit = jdate.exit - jdate.hatch,
         if.fluct = case_when(flucT == 0 ~ "N",
                              TRUE ~ "Y"),
         treatment2 = paste(minT, if.fluct, sep = "-")) # for km filtering later

# fix diurnal fluct
NTs_all$flucT[NTs_all$flucT == 0] <- 2.5 

# calc summ stats we're interested in
summary_NTs <- NTs_all %>%
  group_by(pop, meanT, flucT, minT, if.fluct) %>% 
  summarise(avg.tt = mean(na.omit(jdate.pupa - jdate.hatch)),
            se.tt = sd(na.omit(jdate.pupa - jdate.hatch))/sqrt(length(na.omit(jdate.pupa - jdate.hatch))),
            avg.mass = mean(na.omit(mass.pupa)),
            se.mass = sd(na.omit(mass.pupa)/sqrt(length(na.omit(mass.pupa)))),
            n_all = n(),
            n_pmd = sum(final.fate == "pmd"), 
            prop.survpup = round(1-(n_pmd/n_all), digits=2)) %>%
  mutate(fluct.grp = case_when(if.fluct == "Y" ~ "experimental (max: 40C)", TRUE ~ "control (max: ~28C)"))

```

## - plotting: by NTs

H: naively, if NTs are all that matters, then performance should just decrease as NT increases.

```{r response vars by min temp}
# is there a better way to just pull out the 26/26 ctrls...?
# need to go confirm if there is effect of sex,, (see old graphs)

# avg mass
summary_NTs %>% ggplot(aes(y = avg.mass, x = as.factor(minT), shape = fluct.grp)) +
  geom_point(size = 2) +  y_err_mass(y_err= 0.1) +
  scale_shape_manual(values=c(21, 16)) +
  facet_wrap(~pop) + theme_bw() +
  labs(title = "NTs: avg pupal mass", 
       y = "average pupal mass (mg)", 
       x = "minimum temperature (°C)", 
       #caption = "trts: ~26, 40/19, 40/26, 40/33",
       shape = "treatment group")

# avg tt pup
summary_NTs %>% ggplot(aes(y = avg.tt, x = as.factor(minT), shape = fluct.grp)) +
  geom_point(size = 2) +  y_err_tt(y_err= 0.1) +
  scale_shape_manual(values=c(21, 16)) +
  facet_wrap(~pop) + theme_bw() +
  labs(title = "NTs: avg time to pupation from hatching", 
       y = "average time to pupation (days)", 
       x = "minimum temperature (°C)", 
       #caption = "trts: ~26, 40/19, 40/26, 40/33",
       shape = "treatment group")
  # HUH fascinating LOL

# survival
summary_NTs %>% ggplot(aes(y = prop.survpup, x = as.factor(minT), shape = fluct.grp)) +
  geom_point() + geom_line(aes(group = if.fluct)) +
  facet_wrap(~pop) + theme_bw() +
  scale_shape_manual(values=c(21, 16)) +
  labs(title = "NTs: survival to pupation (incls LPI)", 
       y = "proportion survived to pupation", 
       x = "minimum temperature (°C)", 
       #caption = "trts: ~26, 40/19, 40/26, 40/33",
       shape = "treatment group")
  # not rly sure what a good way to show this one is... maybe just as a table?
```

```{r KM by min temp}
# combine pop + temp data into 1 grouping variable? (yes so we can separate out the 1 ctrl temp)
# NTs_all <- NTs_all %>%
#   mutate(treatment2 = paste(NTs_all$minT, NTs_all$if.fluct, sep = "-"))
  # going to add the mutate here to the main data filtering step!

# fit model
kmfit.byNT <- survfit(Surv(NTs_all$tt.exit, NTs_all$status) ~ treatment2, data = NTs_all)

# plot
ggsurvplot(fit = kmfit.byNT, data = NTs_all,
           conf.int = TRUE,
           palette = RYB)
  # hrmm ok lets try to separate out the pops...
  # altogether, seems like 19/33 are the worst when u combine everything

ggsurvplot(fit = kmfit.byNT, data = NTs_all,
           conf.int = TRUE,
           palette = RYB,
           facet.by = c("pop"),
           legend.labs = c("19C", "26C diurnal", "26C", "33C"),
           #risk.table = TRUE,
           legend.title = "min temp",
           xlab = "days since hatching")
  # good to know,, 40/26 and 26/26 are similar in lab animals but not in field animals

```
```{r sex differences?}
# do m/f plots look different?

# calc stats again
summary_NTs2 <- NTs_all %>%
  filter(sex != "NA") %>%
  group_by(pop, sex, meanT, flucT, minT, if.fluct) %>% 
  summarise(avg.tt = mean(na.omit(jdate.pupa - jdate.hatch)),
            se.tt = sd(na.omit(jdate.pupa - jdate.hatch))/sqrt(length(na.omit(jdate.pupa - jdate.hatch))),
            avg.mass = mean(na.omit(mass.pupa)),
            se.mass = sd(na.omit(mass.pupa)/sqrt(length(na.omit(mass.pupa)))),
            n_all = n(),
            n_pmd = sum(final.fate == "pmd"), 
            prop.survpup = round(1-(n_pmd/n_all), digits=2))


# avg mass - not rly
summary_NTs2 %>% ggplot(aes(y = avg.mass, x = as.factor(minT), color = if.fluct)) +
  geom_point(size = 2) +  y_err_mass(y_err= 0.1) +
  facet_wrap(pop~sex) + theme_bw() +
  labs(title = "NTs: avg pupal mass", 
       y = "average pupal mass (mg)", 
       x = "minimum temperature (°C)", 
       color = "fluctuating treatment?")

# avg tt pup - also not rly
summary_NTs2 %>% ggplot(aes(y = avg.tt, x = as.factor(minT), color = if.fluct)) +
  geom_point(size = 2) +  y_err_tt(y_err= 0.1) +
  facet_wrap(pop~sex) + theme_bw() +
  labs(title = "NTs: avg time to pupation from hatching", 
       y = "average time to pupation (days)", 
       x = "minimum temperature (°C)", 
       color = "fluctuating treatment?")

# survival figs dont work bc can only sex them if they live to pupation (sweats;;)
# but looking at the summary stats.. vaaaaaguely seems like there tends to be more F?
```
## - plotting: by meanT

H: naively, if mean T is all that matters, then "performance" should peak at ~33ish and then drop.

```{r response var by meanT}
# avg mass
summary_NTs %>% ggplot(aes(y = avg.mass, x = meanT, shape = fluct.grp)) +
  geom_point(size = 2) +  y_err_mass(y_err= 0.5) +
  facet_wrap(~pop) + theme_bw() +
  scale_shape_manual(values=c(21, 16)) +
  labs(title = "NTs: avg pupal mass", 
       y = "average pupal mass (mg)", 
       x = "mean temperature (°C)", 
       caption = "trts: 26±0, 29.5±10.5, 33±7, 36.5±3.5",
       shape = "treatment group")
  # 26/26 is sorta sameish in field, but does best in lab bugs

# avg tt pup
summary_NTs %>% ggplot(aes(y = avg.tt, x = meanT, shape = fluct.grp)) +
  geom_point(size = 2) +  y_err_tt(y_err= 0.5) +
  facet_wrap(~pop) + theme_bw() +
  scale_shape_manual(values=c(21, 16)) +
  labs(title = "NTs: avg time to pupation from hatching", 
       y = "average time to pupation (days)", 
       x = "mean temperature (°C)", 
       caption = "trts: 26±0, 29.5±10.5, 33±7, 36.5±3.5",
       shape = "treatment group")
  # field: tt goes down as mean T increases. lab: same except that goes up a lot at 28ish

# survival
summary_NTs %>% ggplot(aes(y = prop.survpup, x = meanT, shape = fluct.grp)) +
  geom_point() +
  facet_wrap(~pop) + theme_bw() +
  scale_shape_manual(values=c(21, 16)) +
  labs(title = "NTs: survival to pupation (incl LPI)", 
       y = "proportion survived to pupation", 
       x = "mean temperature (°C)", 
       caption = "trts: 26±2.5, 29.5±10.5, 33±7, 36.5±3.5",
       shape = "treatment group")
  # F: 26/26 is best. gets better as meanT increases
  # L: all over the place lol
  # imo this fig will look better with the flucts...
```

```{r KM by mean temp}
# fit model
kmfit.byminT <- survfit(Surv(NTs_all$tt.exit, NTs_all$status) ~ meanT, data = NTs_all)

# plot
ggsurvplot(fit = kmfit.byminT, data = NTs_all,
           conf.int = TRUE,
           palette = RYB)
  # hrmm ok lets try to separate out the pops...

ggsurvplot(fit = kmfit.byminT, data = NTs_all,
           conf.int = TRUE,
           palette = RYB,
           facet.by = c("pop"),
           legend.labs = c("26C diurnal", "29.5C", "33C", "36.5C"),
           #risk.table = TRUE,
           legend.title = "mean temp",
           xlab = "days since hatching")

```
(let's keep going w the other figs and ignore the potential sex differences for now bc it doesnt seem that major, based on the graphs where x = min T)

## - plotting: by flucT

H: naively, if fluct T is all that matters, then "performance" should decrease as fluct gets larger.

```{r response var by flucT}
# avg mass
summary_NTs %>% ggplot(aes(y = avg.mass, x = flucT, color = as.factor(minT))) +
  geom_point(size = 2) +  y_err_mass(y_err= 0.5) +
  facet_wrap(~pop) + theme_bw() +
  scale_color_manual(values = RYB) +
  labs(title = "NTs: avg pupal mass", 
       y = "average pupal mass (mg)", 
       x = "fluctuation temperature (°C)",
       color = "minimum temperature (°C)")
  # F/L: smaller if any fluct at all. in F, range is slightly bigger with bigger fluct (L is consistent range). L is generally larger than F at all sizes.

# avg tt pup
summary_NTs %>% ggplot(aes(y = avg.tt, x = flucT, color = as.factor(minT))) +
  geom_point(size = 2) +  y_err_tt(y_err= 0.5) +
  facet_wrap(~pop) + theme_bw() +
  scale_color_manual(values = RYB) +
  labs(title = "NTs: avg time to pupation from hatching", 
       y = "average time to pupation (days)", 
       x = "fluctuation temperature (°C)",
       color = "minimum temperature (°C)")
  # F/L: v shape lol. they're kinda the same times which is interesting bc the masses r so differnt

# survival
summary_NTs %>% ggplot(aes(y = prop.survpup, x = flucT, color = as.factor(minT))) +
  geom_point() +
  facet_wrap(~pop) + theme_bw() +
  scale_color_manual(values = RYB) +
  labs(title = "NTs: survival to pupation", 
       y = "proportion survived to pupation", 
       x = "fluctuation temperature (°C)",
       color = "minimum temperature (°C)",
       caption = "incls LPI")
  # F: less surv as fluct increases. L: all over the place lol

# might be worth looking into some sex differences here! (later...)
```
```{r KM by fluct temp}
# fit model
kmfit.byflucT <- survfit(Surv(NTs_all$tt.exit, NTs_all$status) ~ flucT, data = NTs_all)

# plot
ggsurvplot(fit = kmfit.byflucT, data = NTs_all,
           conf.int = TRUE,
           palette = RYB)
  # hrmm ok lets try to separate out the pops...
  # generally the non-flucts r doing great lol

ggsurvplot(fit = kmfit.byflucT, data = NTs_all,
           conf.int = TRUE,
           palette = RYB,
           facet.by = c("pop"),
           legend.labs = c("±0", "±3.5", "±7", "±10.5"),
           #risk.table = TRUE,
           legend.title = "fluctuation",
           xlab = "time in days")
  # sigh. lots to think about here. why is the 10.5 so good in the lab lmao (see below -- add in the mean)

ggsurvplot(fit = kmfit.byflucT, data = NTs_all,
           conf.int = TRUE,
           palette = RYB,
           facet.by = c("pop"),
           legend.labs = c("26±2.5", "36.5±3.5", "33±7", "29.5±10.5"),
           #risk.table = TRUE,
           legend.title = "treatment",
           xlab = "days since hatching")

```

overall i think this is all saying that pop/fluct/min/mean(?) all have an effect! (temp effects depend on pop..?) still not quite sure how to parse out "parameterising" temperature tho... (define it by fluct only? min T? meanT? etc?)

clearly it's like ~at some point~/in combo with other factors, a certain min is bad, mean is bad, fluct is bad, etc etc... maybe compare with the 2x2s (sweat smile)

## - plotting: lab bugs on TB/LD

just looking at pupation/time since the ctrl analyses suggest those are the things that are mostly diff btwn them.

```{r recalc dev stats}
summary_NTs3 <- NTs_all %>%
  filter(pop == "lab") %>%
  group_by(diet, meanT, flucT, minT, if.fluct) %>% 
  summarise(avg.tt = mean(na.omit(jdate.pupa - jdate.hatch)),
            se.tt = sd(na.omit(jdate.pupa - jdate.hatch))/sqrt(length(na.omit(jdate.pupa - jdate.hatch))),
            avg.mass = mean(na.omit(mass.pupa)),
            se.mass = sd(na.omit(mass.pupa)/sqrt(length(na.omit(mass.pupa)))),
            n_all = n(),
            n_pmd = sum(final.fate == "pmd"), 
            prop.survpup = round(1-(n_pmd/n_all), digits=2)) %>%
  mutate(fluct.grp = case_when(if.fluct == "Y" ~ "experimental (max: 40C)", TRUE ~ "control (max: ~28C)"))
```


```{r by min T}
# avg tt pup
summary_NTs3 %>% 
  ggplot(aes(y = avg.tt, x = as.factor(minT), shape = fluct.grp)) +
  geom_point(size = 2) +  y_err_tt(y_err= 0.1) +
  scale_shape_manual(values=c(21, 16)) +
  facet_wrap(~diet) + theme_bw() +
  labs(title = "NTs: avg time to pupation from hatching", 
       y = "average time to pupation (days)", 
       x = "minimum temperature (°C)", 
       #caption = "trts: ~26, 40/19, 40/26, 40/33",
       shape = "treatment group")

# survival
summary_NTs3 %>% ggplot(aes(y = prop.survpup, x = as.factor(minT), shape = fluct.grp)) +
  geom_point() + geom_line(aes(group = if.fluct)) +
  facet_wrap(~diet) + theme_bw() +
  scale_shape_manual(values=c(21, 16)) +
  labs(title = "NTs: survival to pupation (incls LPI)", 
       y = "proportion survived to pupation", 
       x = "minimum temperature (°C)", 
       #caption = "trts: ~26, 40/19, 40/26, 40/33",
       shape = "treatment group")

```
```{r by mean T}
# avg tt pup
summary_NTs3 %>% ggplot(aes(y = avg.tt, x = meanT, shape = fluct.grp)) +
  geom_point(size = 2) +  y_err_tt(y_err= 0.5) +
  facet_wrap(~diet) + theme_bw() +
  scale_shape_manual(values=c(21, 16)) +
  labs(title = "NTs: avg time to pupation from hatching", 
       y = "average time to pupation (days)", 
       x = "mean temperature (°C)", 
       caption = "trts: 26±0, 29.5±10.5, 33±7, 36.5±3.5",
       shape = "treatment group")

# survival
summary_NTs3 %>% ggplot(aes(y = prop.survpup, x = meanT, shape = fluct.grp)) +
  geom_point() +
  facet_wrap(~diet) + theme_bw() +
  scale_shape_manual(values=c(21, 16)) +
  labs(title = "NTs: survival to pupation (incl LPI)", 
       y = "proportion survived to pupation", 
       x = "mean temperature (°C)", 
       caption = "trts: 26±2.5, 29.5±10.5, 33±7, 36.5±3.5",
       shape = "treatment group")
```

```{r by flucT}
# avg tt pup
summary_NTs3 %>% ggplot(aes(y = avg.tt, x = flucT, color = as.factor(minT))) +
  geom_point(size = 2) +  y_err_tt(y_err= 0.5) +
  facet_wrap(~diet) + theme_bw() +
  scale_color_manual(values = RYB) +
  labs(title = "NTs: avg time to pupation from hatching", 
       y = "average time to pupation (days)", 
       x = "fluctuation temperature (°C)",
       color = "minimum temperature (°C)")

# survival
summary_NTs3 %>% ggplot(aes(y = prop.survpup, x = flucT, color = as.factor(minT))) +
  geom_point() +
  facet_wrap(~diet) + theme_bw() +
  scale_color_manual(values = RYB) +
  labs(title = "NTs: survival to pupation", 
       y = "proportion survived to pupation", 
       x = "fluctuation temperature (°C)",
       color = "minimum temperature (°C)",
       caption = "incls LPI")
```

# // C3. revisualise with better lab controls (240124 followups)

purpose: based on the results by visualising effect of diet + per meeting followups, going to redo the plotting by NTs figs with the lab bugs on lab diet removed, so that diet isn't a variable in the analyses. (i.e. only differences between bugs should be temp treatment and pop. everyone's eating TB)

## - data prep

```{r}
# refilter NTs without the lab bugs on lab diet
NTs_all2 <- wide_all %>%
  filter.NTs2() %>%
  filter(final.fate != "misc" & final.fate != "accidental" & final.fate != "culled") %>%
  filter(!(pop == "lab" & diet == "LD")) %>%
  mutate(tt.pupa = jdate.pupa - jdate.hatch,
         status = case_when(final.fate == "pmd" ~ 1, 
                            TRUE ~ 0),
         tt.exit = jdate.exit - jdate.hatch,
         if.fluct = case_when(flucT == 0 ~ "N",
                              TRUE ~ "Y"),
         treatment2 = paste(minT, if.fluct, sep = "-")) # for survival filtering

# fix diurnal fluct
NTs_all2$flucT[NTs_all2$flucT == 0] <- 2.5 

# calc summ stats we're interested in
summary_NTs2 <- NTs_all2 %>%
  group_by(pop, meanT, flucT, minT, if.fluct) %>% 
  summarise(avg.tt = mean(na.omit(jdate.pupa - jdate.hatch)),
            se.tt = sd(na.omit(jdate.pupa - jdate.hatch))/sqrt(length(na.omit(jdate.pupa - jdate.hatch))),
            avg.mass = mean(na.omit(mass.pupa)),
            se.mass = sd(na.omit(mass.pupa)/sqrt(length(na.omit(mass.pupa)))),
            n.all = n(),
            n.pmd = sum(final.fate == "pmd"), 
            n.surv = n.all - n.pmd, 
            prop.survpup = round(1-(n.pmd/n.all), digits=2)) %>%
  mutate(fluct.grp = case_when(if.fluct == "Y" ~ "experimental (max: 40C)", TRUE ~ "control (max: ~28C)"))
```
we'll just focus on NTs as the input variable for the redo graphs bc the other 2 are just different ways of grouping :p

## - plotting: by NTs

```{r big 3 responses}
# avg mass
summary_NTs2 %>% 
  filter(if.fluct == "Y") %>% # to view w/o ctrl grp
  ggplot(aes(y = avg.mass, x = as.factor(minT), shape = fluct.grp)) +
  geom_point(size = 2) +  y_err_mass(y_err= 0.1) +
  #scale_shape_manual(values=c(21, 16)) +
  facet_wrap(~pop) + theme_bw() +
  geom_text(aes(label = n.surv), vjust = -1.1, hjust = -0.5) +
  labs(title = "NTs: avg pupal mass", 
       y = "average pupal mass (mg)", 
       x = "minimum temperature (°C)", 
       caption = "all tobacco diet, max T = 40C",
       shape = "treatment group")

# avg tt pup
summary_NTs2 %>% 
  filter(if.fluct == "Y") %>% # to view w/o ctrl grp
  ggplot(aes(y = avg.tt, x = as.factor(minT), shape = fluct.grp)) +
  geom_point(size = 2) +  y_err_tt(y_err= 0.1) +
  #scale_shape_manual(values=c(21, 16)) +
  facet_wrap(~pop) + theme_bw() +
  geom_text(aes(label = n.surv), vjust = -1.1, hjust = -0.5) +
  labs(title = "NTs: avg time to pupation from hatching", 
       y = "average time to pupation (days)", 
       x = "minimum temperature (°C)", 
       caption = "all tobacco diet, max T = 40C",
       shape = "treatment group")

# survival
summary_NTs2 %>% 
  filter(if.fluct == "Y") %>% # to view w/o ctrl grp
  ggplot(aes(y = prop.survpup, x = as.factor(minT), shape = fluct.grp)) +
  geom_point(size=2) + geom_line(aes(group = if.fluct)) +
  facet_wrap(~pop) + theme_bw() +
  #scale_shape_manual(values=c(21, 16)) +
  geom_text(aes(label = n.all), vjust = -1.5, hjust = -0.9) +
  labs(title = "NTs: survival to pupation (incls LPI)", 
       y = "proportion survived to pupation", 
       x = "minimum temperature (°C)", 
       caption = "all tobacco diet, max T = 40C; n = starting bugs",
       shape = "treatment group"
       ) +
  ylim(c(0, 0.8))

# wow these sample sizes/survival rates fuckn suck LOL
```

wow these sample sizes suck. anyway moving on

```{r KM curves all}
# first, KM curve with the control grp included

# add fit
kmfit.byNT2 <- survfit(Surv(NTs_all2$tt.exit, NTs_all2$status) ~ treatment2, data = NTs_all2)

# rough plot
ggsurvplot(fit = kmfit.byNT2, data = NTs_all2,
           conf.int = TRUE,
           palette = RYB)

# add labels
ggsurvplot(fit = kmfit.byNT2, data = NTs_all2,
           conf.int = TRUE,
           palette = RYB,
           facet.by = c("pop"),
           legend.labs = c("19C", "26C diurnal", "26C", "33C"),
           legend.title = "min temp",
           xlab = "days since hatching")
  # lmao... whats happening to my 1 guy in the lab minT = 33 group..
```

```{r KM curves expt only}
# plot without the ctrl group for slightly easier viz

# filter and fit
NTs_all2a <- filter(NTs_all, if.fluct == "Y")
  
kmfit.byNT2a <- survfit(Surv(NTs_all2a$tt.exit, NTs_all2a$status) ~ treatment2, data = NTs_all2a)

# plot
ggsurvplot(fit = kmfit.byNT2a, data = NTs_all2a,
           conf.int = TRUE,
           palette = RYB,
           facet.by = c("pop"),
           legend.labs = c("19C", "26C", "33C"),
           legend.title = "min temp",
           xlab = "days since hatching")
```

# D. modeling

## - data prep

(do this once you redo the viz)

for the analyses, drop the control group (i think i need to filter out the bugs on LD too...)

```{r}
NTs_expt <- NTs_all %>%
  filter(treatment != 260)
```


## - (skipping) mass pup

skipping mass for now bc that doesn't seem to be too affected generally by treatment (or at least, no big surprises)

## - ttpup

let's assume that generally, pop matters. which of our main temperature variables are important to/significant in predicting ttpup?

```{r}
mod.tt <- lm(tt.pup ~ minT*pop, data = NT)
```

# followups list

1. see 240124 mtg stuff → this is mostly going to be addressed in the `C3` header
  1. but basically need check for same diet comparisons, redo the n='s, redo some figs w/o the control... maybe some other stuff where i take out the control group...
  1. some of this is currently being worked on in: `C3. visualise with better lab controls (240124 followups)`