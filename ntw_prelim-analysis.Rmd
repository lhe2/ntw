---
title: "NTW prelim data analysis"
output: html_notebook
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, echo = TRUE)

library(dplyr)
library(ggplot2)
library(tidyr)
library(survival) # for kaplan-meier/survival objects
library(cmprsk) # bc i think that's what this is lol
library(survminer) # maybe, for visualisation
library(survey)
```

# TODO & information

here is code for some analysis of preliminary NTW experiments. as usual i keep making 50 different new files for things bc im indecisive about how to do things

TODO list: (search `// TODO`)

* [done] create `daysto.` columns (from hatching) for all instars/development timepoints
* [sorta done] consolidate todo items up here lol (then redistribute to below... or vice versa)
* separate processing code from analysis code lowkey bc i just want to import a fresh .csv instead of doing this 80 times, and then less things to change if i change the filenames again
  * yeet the .nb.ntml file lol


TODO / statistics to measure:


* [!!!] lowkey double check that #s are right due to what we discovered with the na_drop!!!
* [done] log average weight at instars
  * h/m considerations... (esp for grp B)
  * from.E considerations... (only pick 0 and 1?)
  * for clarity, should come up w better naming system for the adults/larva + groupings
* [done for A, B] average length of instars
* [doneish] survival
  * kaplan meier curves -- see:
    * https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/
    * https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html#Packages 
* [done] A vs B comparisons (26 constant)
  * [done] pool relevant A+B individuals --> then stats again?
* who got stuck
* pupa development (looking @ % none? idr what i originally meant here)
* dv coloring (with B only)
* graph a bunch of growth lines + avg growth
* [in prog] plot time vs mass (dot plot w/ error bars on both sides)


experiment groups:

* A: 2x2 of mean temp = 26 or 33, with 0 degC fluct or 7 degC fluct
* B: 
  * redoing 337 from hatching (A)
  * 2x2(ish) of entering 260 or 337 treatment at different times (hatch, 3rd, 4th)

# load packages (use the setup chunk instead)

```{r load libraries}
# library(dplyr)
# library(ggplot2)
# library(tidyr)

# for some reason this broke on 230321 so now use the setup chunk

#library(data.table) #for setDT (forget why i was thinking about this one)
#library(survival) # for kaplan-meier
```

# load in data and clean, labels

outputs

* data_all, data_notes, data (surv to pup)
  * maybe rename data to data_ec (surv to eclosion)
* data_A, data_B

```{r data preprocess + clean}
data_all <- read.csv("~/Documents/repos/_not-public/1_data/ntw_data/development_v2.csv", header = T) # change to this bc v1 is missing some info

# remove na lines introduced during import
data_all <- mutate_all(data_all, na_if, "")
data_all <- data_all[rowSums(is.na(data_all)) != ncol(data_all),]

# filter out things that didnt hatch at 26C
data_all <- data_all %>%
    filter(!(from.E == 2 | (from.E == 0 & (treatment == 337 | treatment == 330 | treatment == 267))))

# save wordier notes elsewhere and remove from analysis dataset
data_notes <- select(data_all, c("from.E", "treatment", "ID", "expt.group", "pupa.deformities", "final.fate", "notes"))
data_pup <- select(data_all, -c("notes", "pupa.deformities", "mass.died", "time.in.approx")) 
  # not sure if 'notes' column will mess things up

# create julian date columns, additional column fixing and creation
data_all <- data_all %>% mutate(across(starts_with("date."),  as.Date, format = "%m/%d/%y")) %>%
  mutate(across(starts_with("date."), format, "%j", .names = "j{.col}")) %>%
  mutate(across(starts_with("jdate."), as.numeric),
         across(starts_with("mass."), as.numeric),
         treatment = as.character(treatment),
         trt.stage = as.character(paste(treatment,instar.enter, sep = "-")), # treatment @ instar
         grp.trt = paste(expt.group, trt.stage, sep = "-"), # round @ treatment
         meanT = ifelse((treatment=="260" | treatment=="267"), 26, 33),
         fluct = ifelse((treatment == "260" | treatment == "330"), 0, 7))

#data_all$trt.stage <- factor(data_all$trt.stage, levels = c("260-hatch", "267-hatch", "330-hatch", "337-hatch", "337-3rd", "337-4th"))

# keep individuals that survived to pupation
#data_pup <- data_all %>% filter(reason.pmd == "" | reason.pmd == "pupa" | reason.pmd == "toast" )
data_pup <- data_all %>% filter(final.fate == "accidental" | final.fate == "eclose" | final.fate == "pupa")
  # omit the LPs? -> currently yes

# pivot and make subsets
long <- data_pup %>% select(-(starts_with("date."))) %>%
                 pivot_longer(cols = starts_with(c("jdate", "mass", "h")),
                        names_to = c(".value", "instar"),
                        #names_sep = ".",
                        values_drop_na = TRUE,
                        names_pattern = ("([a-z]*)\\.(\\d*[a-z]*)")) %>%
                 rename(molt.status = h) %>%
                 drop_na(jdate) # drops NA's if an individual didnt reach a certain stage

long <- long[long$instar != "in",] # from 'instar.in.trt'?
long$instar <- factor(long$instar, c("hatch", "2nd", "3rd", "4th", "5th", "stuck", "wander", "15", "pupa", "eclose"))

# create subsets
data_A <- long[long$expt.group == "A",]
data_B <- long[long$expt.group == "B",]

# defining factors, labels
# A: effect of temp (treatment)
A_trts = c("260-hatch", "267-hatch", "330-hatch", "337-hatch")
# A_hex = c("#abd9e9","#2c7bb6", "#fdae61", "#d7191c")
# A_colors <- c("260-hatch"="#abd9e9","267-hatch"="#2c7bb6", "330-hatch"="#fdae61", "337-hatch"="#d7191c")
A_labels <- c("260-hatch"="26°C", "267-hatch"="26±7°C", "330-hatch"="33°C", "337-hatch"="33±7°C")
A_hex = c("#00C2D1","#1929B3", "#F9C639", "#710A36")
A_colors <- c("260-hatch"="#00C2D1","267-hatch"="#1929B3", "330-hatch"="#F9C639", "337-hatch"="#710A36")



# B: effect of temp:instar (trt.stage)
B_trts = c("260-hatch", "337-hatch", "337-3rd", "337-4th") # manually set factor levels
# B_hex = c("#abd9e9", "#fdbe85", "#fd8d3c", "#d94701")
# B_colors = c("260-hatch"="#abd9e9", "337-4th"="#fdbe85", "337-3rd"="#fd8d3c", "337-hatch"="#d94701")
B_labels = c("260-hatch"="26°C @ hatch","337-hatch"="33±7°C @ hatch", "337-3rd"="33±7°C @ 3rd", "337-4th"="33±7°C @ 4th")
B_hex = c("#00C2D1", "#710A36", "#C23C1E", "#F3922B")
B_colors = c("260-hatch"="#00C2D1", "337-hatch"="#710A36", "337-3rd"="#C23C1E", "337-4th"="#F3922B")
#CD133F

all_trts <- c("260-hatch", "267-hatch", "330-hatch", "337-hatch", "337-3rd", "337-4th")

```

# AB pooled

## AB2 pooled mass&dev analysis

[done!!!!!] want to look at mass/dev time simultaneously on y/x axes respectively

* need to calc: log.se.mass, se.days.to
  * can use the lstats_AB and astats_AB

```{r prep data for AB stats}
# larva/adult mass @ instars
  # pupa/adults need to be separated from the larva before summarising bc of sex differences

# take out things that didn't hatch @ 26C
# AB2_lmass <- long %>%
#   filter(!(from.E == 0 & (treatment == 337 | treatment == 330 | treatment == 267)))

# these 2 should work bc i fixed "long"
  # just in case, try the na.omit thing on everything
AB2_lmass <- long %>%
  filter(instar == "3rd" | instar == "4th" | instar == "5th" | instar == "wander") %>%
  group_by(instar, trt.stage) %>%
  mutate(logmass = log(na.omit(mass))) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.logmass = mean(na.omit(logmass)),
            se.logmass = sd(na.omit(logmass))/sqrt(length(na.omit(logmass))),
            n=n())

AB2_amass <- long %>% 
  group_by(trt.stage, sex, instar) %>%
  filter(instar == "pupa" | instar == "eclose") %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            n=n())

# calculate development time (instar duration), then split into larva/adults + summarise
AB2_devtime <- data_pup %>% 
  select(-starts_with(c("h", "date", "mass", "reason."))) %>%
  mutate("2nd" = jdate.2nd - jdate.hatch,
         "3rd" = jdate.3rd - jdate.hatch,
         "4th" = jdate.4th - jdate.hatch,
         "5th" = jdate.5th - jdate.hatch,
         wander = jdate.wander - jdate.hatch,
         pupa = jdate.pupa - jdate.wander,
         #eclose = jdate.eclose - jdate.15
         eclose = jdate.eclose - jdate.pupa) %>%
  select(-starts_with("jdate.")) %>%
  pivot_longer (cols = c("2nd", "3rd", "4th", "5th", "wander", "pupa", "eclose"), # pivot differences by stage
                names_to = "instar",
                values_to = "days.to") %>%
  na.omit(days.to)

AB2_ldev <- AB2_devtime %>% 
  filter(instar == "3rd" | instar == "4th" | instar == "5th" | instar == "wander") %>%
  group_by(trt.stage, instar) %>%
  summarise(avg.daysto = mean(na.omit(days.to)),
            se.daysto = sd(na.omit(days.to))/sqrt(length(na.omit(days.to))))

AB2_adev <- AB2_devtime %>% 
  filter(instar == "pupa" | instar == "eclose") %>%
  group_by(trt.stage, sex, instar) %>%
  summarise(avg.daysto = mean(na.omit(days.to)),
            se.daysto = sd(na.omit(days.to))/sqrt(length(na.omit(days.to))))


# merge into larval/adult stats
#lstats_AB2 <- merge(lmass_AB2, ldev_AB2, cols = c("trt.stage", "instar")) 
AB2_lstats <- merge(AB2_lmass, AB2_ldev, all = T) 
AB2_astats <- merge(AB2_amass, AB2_adev, all = T)


# create subsets for plotting effect of temp and temp @ instar
# temp effect subsets
AB2_ltemps <- AB2_lstats %>% filter(trt.stage != "337-3rd" & trt.stage != "337-4th")
AB2_atemps <- AB2_astats %>% filter(trt.stage != "337-3rd" & trt.stage != "337-4th")

# temp+instar effects subsets
AB2_linstar <- AB2_lstats %>% filter(trt.stage != "267-hatch" & trt.stage != "330-hatch")
AB2_linstar$trt.stage <- factor(AB2_linstar$trt.stage, levels = c("260-hatch", "337-hatch", "337-3rd", "337-4th"))
AB2_ainstar <- AB2_astats %>% filter(trt.stage != "267-hatch" & trt.stage != "330-hatch")
AB2_ainstar$trt.stage <- factor(AB2_ainstar$trt.stage, levels = c("260-hatch", "337-hatch", "337-3rd", "337-4th"))

# AB2_linstar2 <- AB2_lstats %>% filter(trt.stage != "267-hatch")
# AB2_ainstar2 <- AB2_astats %>% filter(trt.stage != "267-hatch")


```


  
## AB2 pooled mass&dev plots  

* [done] add 33 constant to tempxinstar..

```{r AB2 plots}
# I REALLY HOPE THESE ARE DONE....


### plots comparing effect of temps ###
# larval mass/dev
AB2_ltemps %>% 
  ggplot(aes(x = avg.daysto, y = avg.logmass, shape=instar, color=trt.stage)) +
  geom_point(size=3, alpha=0.75) +
  scale_shape_manual(values=c(16, 17, 15, 18))+
  geom_line(aes(group = trt.stage)) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.logmass - se.logmass, ymax = avg.logmass + se.logmass)) +
  labs(title = "(temp) avg larval growth", x = "days since hatching", y = "avg log(mass (mg))", color = "treatment") +
  scale_color_manual(labels=A_labels, values = A_colors) + theme_bw()

# adult mass/dev
AB2_atemps %>% 
  ggplot(aes(x = avg.daysto, y = avg.mass, color=trt.stage, shape=instar)) +
  geom_point(size=3, alpha = 0.75) +
  geom_line(aes(group = trt.stage)) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.mass - se.mass, ymax = avg.mass + se.mass)) +
  facet_wrap(~sex) +
  labs(title = "(temp) avg adult growth", y = "avg mass (mg)", x = "days since last stage", color = "treatment") +
  scale_color_manual(values = A_colors, labels=A_labels) + theme_bw()

### plots comparing effect of temp x instar ###
# larval mass/dev
  # hard to see shapes...
AB2_linstar %>% 
  ggplot(aes(x = avg.daysto, y = avg.logmass, shape=instar, color=trt.stage)) +
  geom_point(size=3, alpha = 0.75) +
  scale_shape_manual(values=c(16, 17, 15, 18))+
  geom_line(aes(group = trt.stage)) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.logmass - se.logmass, ymax = avg.logmass + se.logmass)) +
  labs(title = "(instar) avg larval growth", x = "days since hatching", y = "avg log(mass (mg))", color = "treatment") +
  scale_color_manual(labels = B_labels, values = B_colors) + theme_bw()
    ## looks kinda wrong w rerun analyses? (lines dont seem like they grouped right..)

# adult mass/dev
AB2_ainstar %>% 
  ggplot(aes(x = avg.daysto, y = avg.mass, shape=instar, color=trt.stage)) +
  geom_point(size=3, alpha = 0.75) +
  geom_line(aes(group = trt.stage)) +
  facet_wrap(~sex) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.mass - se.mass, ymax = avg.mass + se.mass)) +
  scale_color_manual(labels = B_labels, values = B_colors) + theme_bw() +
  labs(title = "(instar) avg adult growth", y = "avg mass (mg)", x = "days since last stage", color="treatment")

```


## alt analysis for y=measurement, x=mean temp

we're blending all the adults here for now lol

```{r INPROG}
# do one for pupa combined and separated pupa?


## tbh i need to do this w/ instar as a color lol there is too much!
## gotta do funky pivots... we'll figure tht out tomorrow

# calculate times to instar
data_more <- data_all %>%
  mutate(timeto.3rd = jdate.3rd-jdate.hatch,
         timeto.4th = jdate.4th-jdate.hatch,
         timeto.5th = jdate.5th-jdate.hatch,
         timeto.wander = jdate.wander-jdate.hatch,
         timeto.pupa = jdate.pupa-jdate.hatch,
         timeto.eclose = jdate.eclose-jdate.hatch)

long_more <- data_more %>% select(-(starts_with(c("date.", "jdate.")))) %>%
                 pivot_longer(cols = starts_with(c("timeto", "mass", "h")),
                        names_to = c(".value", "instar"),
                        #names_sep = ".",
                        values_drop_na = TRUE,
                        names_pattern = ("([a-z]*)\\.(\\d*[a-z]*)")) %>%
                 rename(molt.status = h)
                 # drop_na(jdate) # drops NA's if an individual didnt reach a certain stage

sumstats_all <- long_more %>%
  mutate(mass = mass/1000) %>% # convert to g
  mutate(log.mass = log(mass)) %>% # u get neg values if using mass_g
  filter(final.fate != "misc") %>% 
  filter(instar != "stuck" & instar != "2nd" & instar != "died") %>%
  group_by(meanT, fluct, instar.enter, instar) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.logmass = mean(na.omit(log.mass)),
            se.logmass = sd(na.omit(log.mass))/sqrt(length(na.omit(log.mass))),
            avg.time = mean(na.omit(timeto)),
            se.time = sd(na.omit(timeto))/sqrt(length(na.omit(timeto))),
            n=n())

sumstats_all$instar <- factor(sumstats_all$instar, levels=c("3rd", "4th", "5th", "wander", "pupa", "eclose"))

```

## alt plots
```{r alt analysis plots}

sumstats_temp <- filter(sumstats_all, instar.enter == "hatch")
sumstats_instar <- filter(sumstats_all, meanT == "33")

### temp mass
sumstats_temp %>%
  ggplot(aes(x = meanT, y = avg.mass)) +
  geom_line(aes(lty=factor(fluct))) +
  geom_point(aes(shape = factor(fluct)), size=2.5) +
  geom_errorbar(aes(ymin = avg.mass - se.mass, ymax = avg.mass + se.mass), width = 0.15) +
  facet_wrap(~instar, scales = "free") +
  theme_bw() +
  labs(y = "temp: mass at instar (mg)", lty = "fluctuation", shape = "fluctuation")

### temp time
sumstats_temp %>%
  ggplot(aes(x = meanT, y = avg.time)) +
  geom_line(aes(lty=factor(fluct))) +
  geom_point(aes(shape = factor(fluct)), size=2.5) +
  geom_errorbar(aes(ymin = avg.time - se.time, ymax = avg.time + se.time), width = 0.15) +
  theme_bw() +
  facet_wrap(~instar, scales = "free") +
  labs(y = "temp: time to instar (days)", lty = "fluctuation", shape = "fluctuation")

### instar mass
sumstats_instar %>%
  ggplot(aes(x = fluct, y = avg.mass, color = instar.enter)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = avg.mass - se.mass, ymax = avg.mass + se.mass), width = 0.15) +
  facet_wrap(~instar, scales = "free") +
  theme_bw() +
  labs(y = "instar: mass at instar (mg)", color = "instar entered")

### instar time
sumstats_instar %>%
  ggplot(aes(x = fluct, y = avg.time, color = instar.enter)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = avg.time - se.time, ymax = avg.time + se.time), width = 0.15) +
  theme_bw() +
  facet_wrap(~instar, scales = "free") +
  labs(y = "instar: time to instar (days)", color = "instar entered")

```
## alt adult plots
```{r}
# calc summary stats
sumstats_ad <- long_more %>%
  mutate(mass = mass/1000) %>% # convert to g
  filter(final.fate != "misc" & sex != "unk") %>% 
  filter(instar == "pupa" | instar == "eclose") %>%
  group_by(meanT, fluct, instar.enter, instar, sex) %>%
  summarise(avg.mass = mean(na.omit(mass)),
            se.mass = sd(na.omit(mass))/sqrt(length(na.omit(mass))),
            avg.time = mean(na.omit(timeto)),
            se.time = sd(na.omit(timeto))/sqrt(length(na.omit(timeto))),
            n=n())

sumstats_ad$instar <- factor(sumstats_ad$instar, levels=c("3rd", "4th", "5th", "wander", "pupa", "eclose"))

sumstats_aTemp <- filter(sumstats_ad, instar.enter == "hatch")
sumstats_aInstar <- filter(sumstats_ad, meanT == "33")

# plots
### temp mass
sumstats_aTemp %>%
  ggplot(aes(x = meanT, y = avg.mass, color = sex)) +
  geom_line(aes(lty=factor(fluct))) +
  geom_point(aes(shape = factor(fluct)), size=2.5) +
  geom_errorbar(aes(ymin = avg.mass - se.mass, ymax = avg.mass + se.mass), width = 0.15) +
  facet_wrap(~instar, scales = "free") +
  theme_bw() +
  labs(y = "temp: mass at instar (mg)", lty = "fluctuation", shape = "fluctuation")

### temp time
sumstats_aTemp %>%
  ggplot(aes(x = meanT, y = avg.time, color=sex)) +
  geom_line(aes(lty=factor(fluct))) +
  geom_point(aes(shape = factor(fluct)), size=2.5) +
  geom_errorbar(aes(ymin = avg.time - se.time, ymax = avg.time + se.time), width = 0.15) +
  theme_bw() +
  facet_wrap(~instar, scales = "free") +
  labs(y = "temp: time to instar (days)", lty = "fluctuation", shape = "fluctuation")

jitter <- position_dodge(width=0.5)

### instar mass
sumstats_aInstar %>%
  ggplot(aes(x = fluct, y = avg.mass, color = instar.enter)) +
  #geom_line() +
  geom_point(aes(shape = sex), size = 2.5, position = jitter) +
  geom_errorbar(aes(ymin = avg.mass - se.mass, ymax = avg.mass + se.mass), width = 0.15, position = jitter) +
  facet_wrap(instar~sex, scales = "free") +
  theme_bw() +
  labs(y = "instar: mass at instar (mg)", color = "instar entered")

### instar time
sumstats_aInstar %>%
  ggplot(aes(x = fluct, y = avg.time, color = instar.enter)) +
  #geom_line() +
  geom_point(aes(shape = sex), size = 2, position = jitter) +
  geom_errorbar(aes(ymin = avg.time - se.time, ymax = avg.time + se.time), width = 0.15, position = jitter) +
  theme_bw() +
  facet_wrap(instar~sex, scales = "free") +
  labs(y = "instar: time to instar (days)")
```







# overall survivorship/kill curves

* who died? (pmd) pre or post 3rd? did all slow growers die?
  * want to add columns for this!
  * how to grp trts? (by mean/fluct/instar? or mean-fluct/instar?)
* visualise: curve + do stacked bars (for an overview)?



## kaplan-meier curves

* b/g reading
  * general ideas https://datatab.net/tutorial/survival-analysis
      * prob use cox to account for instar entered, trt, stuck in 5th
        * http://www.sthda.com/english/wiki/cox-proportional-hazards-model 
        * https://rstudio-pubs-static.s3.amazonaws.com/5896_8f0fed2ccbbd42489276e554a05af87e.html 
* probably use [this](https://dk81.github.io/dkmathstats_site/rvisual-kaplan-meier.html)
  * https://argoshare.is.ed.ac.uk/healthyr_book/recode-the-data-1.html 
    * look into [cox.zph](https://argoshare.is.ed.ac.uk/healthyr_book/cox-proportional-hazards-regression.html) for stuck?


variables needed

* id, trt, etc (group curves by trt?)
* time to pmd/event (death as LP, P, L)
* censorship for other events (stuck)

### attempt 2

```{r compting risk survival coding attempt 2}
# redo of orig KM analysis
  # censor out eclosed + toasted individuals
  # redo fate codes
  # subset later into temp/temp+instar trts...?
  # change analysis times - to pupation? to wandering? (start at hatch? in trt?)
    # so need to determine when the general exit day was

## hard code fate data in R

# levels(as.factor(data_all$reason.pmd))
  # double check what the possible outcomes are
  # ""         "empty"    "LP"       "pmd"      "pupa"     "squished" "toast"  

## reference: making new columns for survival analyses. censoring is different based on what the endpoint is
# dfs: surv_ec, surv_pup, surv_wander
# columns: dins (instar died), dstage (life stage died), censor = for KM, date.exit = depends on endpt

# hardcoding final outcomes + addtl info (overall)
  # hardcode up to 4th instar survival -- rest is based on endpt
surv2 <- data_all %>%
  filter(final.fate != "misc") %>% # remove accidental deaths from overall analysis
  mutate(dins = case_when(is.na(date.2nd) ~ 1, # died as 1st instar
                          is.na(date.3rd) ~ 2,
                          is.na(date.4th) ~ 3,
                          reason.pmd != "toast" & is.na(date.5th) ~ 4,
                          reason.pmd == "toast" ~ 99)) # the toasted ones

# test:  test2 <- filter(surv_ec, dstage == 5)

# subset: endpoint = eclosion
surv_ec <- surv2 %>%
  mutate(dins = case_when(reason.pmd != "toast" & is.na(date.pupa) & is.na(date.LP) ~ 5, # died as 5th instar
                          !is.na(date.LP) ~ 6, # died as LPI
                          !is.na(date.pupa) & is.na(date.eclose) ~ 7, # died as pupa
                          reason.pmd == "toast" ~ 99, # toasted
                          TRUE ~ 0), # eclosed
         censor = ifelse((dins == 0 | dins == 99), 0, 1), # 0 = to eclosion, 1 = died
         dstage = case_when(dins == 1 | dins == 2 | dins == 3 | dins == 4 | dins == 5 ~ 1,
                            dins == 6 ~ 2, # LP
                            dins == 7 ~ 3, # P
                            dins == 0 | dins == 99 ~ 0), # censor eclosion or toast
         date.exit = case_when(dstage == 1 ~ date.pmd, # exit time if to eclosion
                               dstage == 2 ~ date.LP,
                               dstage == 3 ~ as.Date(jdate.15+10, format = "%m/%d/%y", origin = date.hatch),
                               dins == 99 ~ date.pmd,
                               dins == 0 ~ date.eclose),
         subset = "to.ec")


# subset: endpoint = pupation
surv_pup <- surv2 %>%
  mutate(dins = case_when(reason.pmd != "toast" & is.na(date.pupa) & is.na(date.LP) ~ 5, # died as 5th instar
                          !is.na(date.LP) ~ 6, # died as LPI
                          reason.pmd == "toast" ~ 99, # toasted
                          TRUE ~ 0), # pupated
         censor = ifelse((dins == 0 | dins == 99), 0, 1), # 0 = to pupation, 1 = died
         dstage = case_when(dins == 1 | dins == 2 | dins == 3 | dins == 4 | dins == 5 ~ 1, # died larva
                            dins == 6 ~ 2, # died LP
                            dins == 0 | dins == 99 ~ 0), # censor pupation or toast
         date.exit = case_when(dstage == 1 ~ date.pmd, # exit time if to pupation
                               dstage == 2 ~ date.LP,
                               !is.na(date.pupa) & is.na(date.eclose) ~ as.Date(jdate.15+10, format = "%m/%d/%y", origin = date.hatch),
                               dins == 99 ~ date.pmd,
                               dins == 0 ~ date.pupa),
         subset = "to.pup")

# subset: endpoint = wandering
surv_wand <- surv2 %>%
  mutate(dins = case_when(reason.pmd != "toast" & is.na(date.wander) ~ 5, # died pre-wandering,
                          reason.pmd == "toast" ~ 99, # toasted
                          TRUE ~ 0), # wandered
         censor = ifelse((dins == 0 | dins == 99), 0, 1), # 0 = to wandering, 1 = died
         dstage = case_when(dins == 1 | dins == 2 | dins == 3 | dins == 4 | dins == 5 ~ 1, # died larva
                            dins == 0 | dins == 99 ~ 0), # censor wandering or toast
         date.exit = case_when(dstage == 1 ~ date.pmd, # exit time if to wandering
                               dins == 99 ~ date.pmd,
                               dins == 0 ~ date.wander),
         subset = "to.wand")
          # could try coalesce() here next time


# merge into 1 df for convenience
surv3 <- do.call("rbind", list(surv_ec, surv_pup, surv_wand))
#surv3$subset <- levels(c()) (maybe change levels)

# calculate exit times
surv3 <- surv3 %>%
  mutate(timeto.exit.hatch = as.numeric(format.Date(date.exit, format = "%j")) - jdate.hatch,
         timeto.exit.intrt = as.numeric(format.Date(date.exit, format = "%j")) - jdate.in.trt)
         
```

```{r surv subset sanity checks}
## sanity check - look at events
table(surv_ec$dins, surv_ec$censor)
  #      0   1
  # 0  157   0
  # 5    0  13
  # 6    0   2
  # 7    0   4
  # 99  24   0

table(surv_ec$dstage, surv_ec$censor)
  #     0   1
  # 0 181   0
  # 1   0  13
  # 2   0   2
  # 3   0   4


table(surv_pup$dins, surv_pup$censor)
  #      0   1
  # 0  161   0
  # 5    0  13
  # 6    0   2
  # 99  24   0

table(surv_pup$dstage, surv_pup$censor)
  #     0   1
  # 0 185   0
  # 1   0  13
  # 2   0   2
         

table(surv_wand$dins, surv_wand$censor)
  #      0   1
  # 0  165   0
  # 5    0  11
  # 99  24   0

table(surv_wand$dstage, surv_wand$censor)
  #     0   1
  # 0 189   0
  # 1   0  11

```


### making some models
```{r making some models}
## looking at effect of temp
temp_survwand <- surv_wand %>%
  filter(dins == 0 & (trt.stage == "260-hatch" | trt.stage == "267-hatch" | trt.stage == "330-hatch" | trt.stage == "337-hatch"))

masswander1 <- lm(mass.wander ~ meanT*fluct, data = temp_survwand)
masswander2 <- lm(mass.wander ~ treatment, data = temp_survwand)

anova(masswander1)
summary(masswander1)

anova(masswander2)
summary(masswander2)

# library(rstatix)
# pwc1 <- temp_survwand %>% tukey_hsd(mass.wander~as.factor(fluct))
# pwc2 <- temp_survwand %>% tukey_hsd(mass.wander~as.factor(meanT))
# pwc3 <- temp_survwand %>% tukey_hsd(mass.wander~treatment)
  # 26-0 and 26-7 aren't sig diff; 33-0 and 33-7 aren't sig diff



## looking at effect of temp:instar
tempins_survwand <- surv_wand %>%
  filter(dins == 0 & (trt.stage == "260-hatch" | trt.stage == "337-hatch" | trt.stage == "337-3rd" | trt.stage == "337-4th"))

masswander3 <- lm(mass.wander ~ meanT*fluct*instar.enter, data = tempins_survwand)
masswander4 <- lm(mass.wander ~ treatment*instar.enter, data = tempins_survwand)
masswander5 <- lm(mass.wander ~ trt.stage, data = tempins_survwand)

anova(masswander3)
summary(masswander3)

anova(masswander4)
summary(masswander4)

anova(masswander5)
summary(masswander5)

tempins_survwand %>% tukey_hsd(mass.wander~trt.stage)
tempins_survwand %>% tukey_hsd(mass.wander~treatment)
tempins_survwand %>% tukey_hsd(mass.wander~instar.enter)

```


### plotting attempt 2
```{r survival plotting try 2...}

# //TODO -- figure out how to facet... i think just filter the trts out of surv3

# subseting the data into the diff expts for KM analyses

all_labels <- c("260-hatch"="26°C @ hatch", "267-hatch"="26±7°C @ hatch", "330-hatch"="33°C @ hatch","337-hatch"="33±7°C @ hatch", "337-3rd"="33±7°C @ 3rd", "337-4th"="33±7°C @ 4th")
temp_labels <- c("260-hatch"="26°C @ hatch", "267-hatch"="26±7°C @ hatch", "330-hatch"="33°C @ hatch","337-hatch"="33±7°C @ hatch")

#surv3$trt.stage <- factor(surv3$trt.stage, levels = c("260-hatch"="26°C @ hatch", "267-hatch"="26±7°C @ hatch", "330-hatch"="33°C @ hatch","337-hatch"="33±7°C @ hatch", "337-3rd"="33±7°C @ 3rd", "337-4th"="33±7°C @ 4th"))
#surv3$trt.stage <- factor(surv3$trt.stage, levels=c("260-hatch", "267-hatch", "330-hatch", "337-hatch", "337-3rd", "337-4th"))


surv_temp <- surv3 %>% 
  #filter(trt.stage %in% c("260-hatch", "267-hatch", "330-hatch", "337-hatch"))
  filter(trt.stage == "260-hatch" | trt.stage == "267-hatch" | trt.stage == "330-hatch" | trt.stage == "337-hatch")

# trying to make the legend.labs work...
# surv_temp2 <- surv_temp %>% 
#   mutate(trt.stageo = ordered(trt.stage, A_trts)) %>% as_tibble()
  # idt this is needed bc i figured out the hex labels



# temp only effects
sobj_temp<- Surv(surv_temp$timeto.exit.hatch, surv_temp$censor)
sfit_temp<- survfit(sobj_temp ~ trt.stage, data = surv_temp)

ggsurvplot(fit = sfit_temp, data=surv_temp,
           xlab = "days from hatching", ylab = "survival probability",
           title = "temp x survival from hatching",
           facet.by = "subset",
           palette = A_hex, 
           legend.title = "treatment", legend.labs = A_labels) # palette and labels need to just be what u wanna replace fml
           # how to change the facet labels?



# temp x instar effects
surv_ins <- surv3 %>% 
  filter(trt.stage == "260-hatch" | trt.stage == "337-hatch" | trt.stage == "337-3rd" | trt.stage == "337-4th")

# from hatching
sobj_inshatch<- Surv(surv_ins$timeto.exit.hatch, surv_ins$censor)
sfit_inshatch<- survfit(sobj_inshatch ~ trt.stage, data = surv_ins)

ggsurvplot(fit = sfit_inshatch, data=surv_ins,
           xlab = "days from hatching", ylab = "survival probability",
           title = "temp:instar x survival from hatching", 
           facet.by = "subset",
           palette = B_hex, 
           legend.title = "treatment-stage entered", legend.labs = B_labels)

# from entering expt
sobj_insenter<- Surv(surv_ins$timeto.exit.intrt, surv_ins$censor)
sfit_insenter<- survfit(sobj_insenter ~ trt.stage, data = surv_ins)

  # i want free x axes.. -> okay maybe this is moot
ggsurvplot(fit = sfit_insenter, data = surv_ins,
           xlab = "days from entering treatment", ylab = "survival probability",
           title = "temp:instar x survival from entering treatment",
           facet.by = "subset",
           #linetype = c("strata"),
           #scales = "free", # this works in ggplot....
           censor.shape = "|",
           risk.table = T,
           #conf.int = T,
           palette = B_hex, 
           #p.val = T,
           legend.title = "treatment-stage entered", legend.labs = B_labels)



### just do graphs for pupation bc all of them is kinda ugly
  # conf ints make them un-viewable

surv_inspup <- filter(surv_ins, subset == "to.pup")
surv_temppup <- filter(surv_temp, subset == "to.pup")

sfit_inspup_hatch <- survfit(Surv(surv_inspup$timeto.exit.hatch, surv_inspup$censor) ~ trt.stage, data = surv_inspup)
sfit_inspup_intrt <- survfit(Surv(surv_inspup$timeto.exit.intrt, surv_inspup$censor) ~ trt.stage, data = surv_inspup)
sfit_temppup <- survfit(Surv(surv_temppup$timeto.exit.hatch, surv_temppup$censor) ~ trt.stage, data = surv_temppup)

ggsurvplot(fit = sfit_temppup, data = surv_temppup,
           xlab = "days from hatching", ylab = "survival probability",
           title = "(temp) survival from hatching to pupation",
           #conf.int = T,           
           censor.shape = "|",
           palette = A_hex,
           legend.title = "treatment", legend.labs = A_labels)

ggsurvplot(fit = sfit_inspup_hatch, data = surv_inspup,
           xlab = "days from hatching", ylab = "survival probability",
           title = "(instar) survival from hatching to pupation",
           #conf.int = T,
           censor.shape = "|",
           palette = B_hex,
           legend.title = "treatment-stage entered", legend.labs = B_labels)

ggsurvplot(fit = sfit_inspup_intrt, data = surv_inspup,
           xlab = "days from entering treatment", ylab = "survival probability",
           title = "(instar) survival from entering treatment to pupation",
           #conf.int = T,
           censor.shape = "|",
           palette = B_hex,
           legend.title = "treatment-stage entered", legend.labs = B_labels)

```

# joel data overlay analysis

## data prep

```{r prep 2015 v 2013}
# read in new data
data_fluct2015 <- read.csv("~/Documents/repos/_not-public/1_data/others/KS2015-JExpBiol_Msexta.MeanFlucTempExp.2014.csv", header = T, sep = ",")

data_fluct2015$year <- c("y2015")

# make my data look like 2015 data: 
# remove extra columns, calculate times to instars, add surv5th and survPup columns, mass from mg to g
data_fluct2023 <- data_all %>%
  select(c(ID, meanT, fluct, instar.enter, trt.stage, starts_with("mass."), sex, starts_with("date."), starts_with("jdate."), final.fate)) %>%
  filter(final.fate != "misc") %>% # remove accidental deaths from overall analysis
  mutate(time.5th = jdate.5th-jdate.hatch,
         time.pupa = jdate.pupa-jdate.hatch,
         surv.5th = ifelse(is.na(jdate.5th) & final.fate != "pmd", "N", "Y"),
         surv.pupa = ifelse(is.na(jdate.pupa), "N", "Y"),
         year = c("y2023"),
         mass.3rd = mass.3rd/1000,
         mass.4th = mass.4th/1000,
         mass.5th = mass.5th/1000,
         mass.pupa = mass.pupa/1000)

# match columns and stack
data_fluct2023$ID <- as.character(data_fluct2023$ID)
data_fluct2023$sex <- toupper(data_fluct2023$sex)
names(data_fluct2015)[3:24] <- tolower(names(data_fluct2015)[3:24])
data_fluct2023 <- data_fluct2023 %>% rename(meanTemp = meanT, fluctTemp = fluct)
data_fluct2015 <- data_fluct2015 %>% rename(meanTemp = meantemp, fluctTemp = flucttemp)

commonCols <- intersect(colnames(data_fluct2015), colnames(data_fluct2023))
data_flucts <- bind_rows(data_fluct2015[, commonCols], data_fluct2023[, commonCols])


# summmary stats
sumstats_flucts <- data_flucts %>%
  group_by(year, meanTemp, fluctTemp) %>%
  summarise(avg.mass5th = mean(na.omit(mass.5th)),
            se.mass5th = sd(na.omit(mass.5th))/sqrt(length(na.omit(mass.5th))),
            avg.time5th = mean(na.omit(time.5th)), 
            se.time5th = sd(na.omit(time.5th))/sqrt(length(na.omit(time.5th))),
            avg.masspupa = mean(na.omit(mass.pupa)), 
            se.masspupa = sd(na.omit(mass.pupa))/sqrt(length(na.omit(mass.pupa))),
            avg.timepupa = mean(na.omit(time.pupa)), 
            se.timepupa = sd(na.omit(time.pupa))/sqrt(length(na.omit(time.pupa))))

```

## plotting

```{r plotting 2015 v 2023}

# time to 5th
sumstats_flucts %>%
  ggplot(aes(x = meanTemp, y = avg.time5th, color = year, group = interaction(year, fluctTemp))) +
  geom_line(aes(lty=factor(fluctTemp))) +
  geom_point(aes(shape = factor(fluctTemp)), size=2.5) +
  geom_errorbar(aes(ymin = avg.time5th - se.time5th, ymax = avg.time5th + se.time5th), width = 0.15) +
  theme_bw() +
  labs(y = "time to 5th (days)", lty = "fluctuation", shape = "fluctuation")

# mass 5th
sumstats_flucts %>%
  ggplot(aes(x = meanTemp, y = avg.mass5th, color = year, group = interaction(year, fluctTemp))) +
  geom_line(aes(lty=factor(fluctTemp))) +
  geom_point(aes(shape = factor(fluctTemp)), size=2.5) +
  geom_errorbar(aes(ymin = avg.mass5th - se.mass5th, ymax = avg.mass5th + se.mass5th), width = 0.15) +
  theme_bw() +
  labs(y = "mass at 5th (g)", lty = "fluctuation", shape = "fluctuation")


# time to pupa
sumstats_flucts %>%
  ggplot(aes(x = meanTemp, y = avg.timepupa, color = year, group = interaction(year, fluctTemp))) +
  geom_line(aes(lty=factor(fluctTemp))) +
  geom_point(aes(shape = factor(fluctTemp)), size=2.5) +
  geom_errorbar(aes(ymin = avg.timepupa - se.timepupa, ymax = avg.timepupa + se.timepupa), width = 0.15) +
  theme_bw() +
  labs(y = "time to pupation (days)", lty = "fluctuation", shape = "fluctuation")

# mass pupa
sumstats_flucts %>%
  ggplot(aes(x = meanTemp, y = avg.masspupa, color = year, group = interaction(year, fluctTemp))) +
  geom_line(aes(lty=factor(fluctTemp))) +
  geom_point(aes(shape = factor(fluctTemp)), size=2.5) +
  geom_errorbar(aes(ymin = avg.masspupa - se.masspupa, ymax = avg.masspupa + se.masspupa), width = 0.15) +
  theme_bw() +
  labs(y = "mass at pupation (g)", lty = "fluctuation", shape = "fluctuation")
  

```




# code dump

- most moved to archive doc
- initial KM/survival coding attempts and plotting got moved to archive

## old 2015 attempt

```{r}
# # first attempt
# sumstats_old <- data_all %>%
#   filter(final.fate != "misc") %>% # remove accidental deaths from overall analysis
#   group_by(meanT, fluct, instar.enter) %>%
#   mutate(time.2nd = jdate.2nd-jdate.hatch,
#          time.3rd = jdate.3rd-jdate.hatch,
#          time.4th = jdate.4th-jdate.hatch,
#          time.5th = jdate.5th-jdate.hatch,
#          time.pupa = jdate.pupa-jdate.hatch,
#          time.wander = jdate.wander-jdate.hatch,
#          surv.5th = ifelse(is.na(jdate.5th) & final.fate != "pmd", "N", "Y"),
#          surv.pupa = ifelse(is.na(jdate.pupa), "N", "Y"),
#          surv.wander = ifelse(is.na(jdate.wander), "N", "Y")) %>%
#   summarise(avg.mass3rd = mean(na.omit(mass.3rd)),
#             se.mass3rd = sd(na.omit(mass.3rd))/sqrt(length(na.omit(mass.3rd))),
#             avg.time3rd = mean(na.omit(time.3rd)),
#             se.time3rd = sd(na.omit(time.3rd))/sqrt(length(na.omit(time.3rd))),
#             avg.mass4th = mean(na.omit(mass.4th)),
#             se.mass4th = sd(na.omit(mass.4th))/sqrt(length(na.omit(mass.4th))),
#             avg.time4th = mean(na.omit(time.4th)),
#             se.time4th = sd(na.omit(time.4th))/sqrt(length(na.omit(time.4th))),
#             avg.mass5th = mean(na.omit(mass.5th)),
#             se.mass5th = sd(na.omit(mass.5th))/sqrt(length(na.omit(mass.5th))),
#             avg.time5th = mean(na.omit(time.5th)),
#             se.time5th = sd(na.omit(time.5th))/sqrt(length(na.omit(time.5th))),
#             avg.masswander = mean(na.omit(mass.wander)),
#             se.masswander = sd(na.omit(mass.wander))/sqrt(length(na.omit(mass.wander))),
#             avg.timewander = mean(na.omit(time.wander)),
#             se.timewander = sd(na.omit(time.wander))/sqrt(length(na.omit(time.wander))),
#             avg.masspupa = mean(na.omit(mass.pupa)),
#             se.masspupa = sd(na.omit(mass.pupa))/sqrt(length(na.omit(mass.pupa))),
#             avg.timepupa = mean(na.omit(time.pupa)),
#             se.timepupa = sd(na.omit(time.pupa))/sqrt(length(na.omit(time.pupa))),
#             n=n())
# 
# sumstats_tempold <- filter(sumstats_old, instar.enter == "hatch")
# sumstats_instarold <- filter(sumstats_old, meanT == "33")
# 
# # mass 3rd
# sumstats_tempold %>%
#   ggplot(aes(x = meanT, y = avg.mass3rd)) +
#   geom_line(aes(lty=factor(fluct))) +
#   geom_point(aes(shape = factor(fluct)), size=2.5) +
#   geom_errorbar(aes(ymin = avg.mass3rd - se.mass3rd, ymax = avg.mass3rd + se.mass3rd), width = 0.15) +
#   theme_bw() +
#   labs(y = "mass at 3rd (mg)", lty = "fluctuation", shape = "fluctuation")
# 
# # time to 3rd
# sumstats_tempold %>%
#   ggplot(aes(x = meanT, y = avg.time3rd)) +
#   geom_line(aes(lty=factor(fluct))) +
#   geom_point(aes(shape = factor(fluct)), size=2.5) +
#   geom_errorbar(aes(ymin = avg.time3rd - se.time3rd, ymax = avg.time3rd + se.time3rd), width = 0.15) +
#   theme_bw() +
#   labs(y = "time to 3rd (days)", lty = "fluctuation", shape = "fluctuation")
```



# comparing A vs B

* to compare batch effects
* maybe do combining of A+B here [this is done in the AB pool analyses]

## AvB analysis

```{r analysis A vs B}
## I THINK THIS IS OK/DONE NOW

AvB_lgrowth <- long %>% 
    filter((trt.stage == "260-hatch" | trt.stage == "337-hatch") &
           (instar == "3rd" | instar == "4th" | instar == "5th" | instar == "wander")) %>%
    group_by(grp.trt) %>%
    mutate(logmass = log(mass))

AvB_agrowth <- long %>% 
  filter((trt.stage == "260-hatch" | trt.stage == "337-hatch") &
          (instar == "pupa" | instar == "eclose")) %>%
  group_by(grp.trt, sex)


AvB_devtime <- data_pup %>%
  filter((trt.stage == "337-hatch" | trt.stage == "260-hatch") & (expt.group == "A" | expt.group == "B")) %>%
  mutate(grp.trt = paste(expt.group, trt.stage, sep = "-")) %>%
  select(-starts_with(c("h", "date", "mass", "reason."))) %>%
  mutate("2nd" = jdate.2nd - jdate.hatch,
         "3rd" = jdate.3rd - jdate.hatch,
         "4th" = jdate.4th - jdate.hatch,
         "5th" = jdate.5th - jdate.hatch,
         wander = jdate.wander - jdate.hatch,
         pupa = jdate.pupa - jdate.wander,
         #eclose = jdate.eclose - jdate.15
         eclose = jdate.eclose - jdate.pupa) %>%
  select(-starts_with("jdate.")) %>%
  pivot_longer (cols = c("2nd", "3rd", "4th", "5th", "wander", "pupa", "eclose"), # pivot differences by stage
                names_to = "stage",
                values_to = "days.to",
                values_drop_na = T) %>%
  group_by(grp.trt, stage)

AvB_ldev <- filter(AvB_devtime, stage == "3rd" | stage == "4th" | stage == "5th" | stage == "wander")
AvB_adev <- filter(AvB_devtime, stage == "pupa" | stage == "eclose")

# merge stats into larva/adult subsets
AvB_lstats <- merge(AvB_lgrowth, AvB_ldev, all = T) %>%
  rename(mass.instar = instar, # mass
         duration.instar = stage) # time

AvB_astats <- merge(AvB_agrowth, AvB_adev, all = T) %>%
  rename(mass.instar = instar, # mass
         duration.instar = stage) # time


### for plotting mass & dev simultaneously ###
AvB_lstats2 <- AvB_devtime %>% 
  filter(stage == "3rd" | stage == "4th" | stage == "5th" | stage == "wander") %>%
  rename(instar = stage) %>%
  merge(AvB_lgrowth, all=T) %>%
  group_by(grp.trt, instar) %>%
  summarise(avg.logmass = mean(logmass),
            se.logmass = sd(logmass)/sqrt(length(logmass)),
            avg.mass = mean(mass),
            se.mass = sd(mass)/sqrt(length(mass)),
            avg.daysto = mean(days.to),
            se.daysto = sd(days.to)/sqrt(length(days.to)),
            n=n())

AvB_astats2 <- AvB_devtime %>% 
  filter(stage == "pupa" | stage == "eclose") %>%
  rename(instar = stage) %>%
  #na.omit(jdate) %>%
  merge(AvB_agrowth, all=T) %>%
  group_by(grp.trt, instar, sex) %>%
  summarise(avg.mass = mean(mass),
            se.mass = sd(mass)/sqrt(length(mass)),
            avg.daysto = mean(days.to),
            se.daysto = sd(days.to)/sqrt(length(days.to)),
            n=n())

```

## AvB plotting

(should do a proper test? compare the distributions/means?)

```{r plotting A vs B}
## I THINK THESE ARE DONE NOW (but go look at them again)
  # would be worth also plotting mass&dev simultaneously for these...

# define factors, levels
AvB_lstats$grp.trt <- factor(AvB_lstats$grp.trt, c("A-260-hatch", "B-260-hatch", "A-337-hatch", "B-337-hatch"))
AvB_astats$grp.trt <- factor(AvB_astats$grp.trt, c("A-260-hatch", "B-260-hatch", "A-337-hatch", "B-337-hatch"))
AB_colors <- c("A-260-hatch"="#abd9e9", "B-260-hatch"="#2c7bb6", "A-337-hatch"="#fdae61", "B-337-hatch"="#d7191c")
AB_labels <- c("A-260-hatch"="A 26°C", "B-260-hatch"="B 26°C","A-337-hatch"="A 33±7°C", "B-337-hatch"="B 33±7°C")


## larval instar masses
# done
AvB_lstats %>% ggplot(aes(y = logmass)) + geom_boxplot(aes(fill = grp.trt)) +
  labs(title = "(AvB) mass at start of instar", x = "instar", y = "log(mass (mg))", fill = "group-treatment") +
  scale_fill_manual(labels = AB_labels, values = AB_colors) + theme_bw() +
  facet_grid(~mass.instar, switch="x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.spacing = unit(0, "lines"))


## adult masses
  # havent rly looked at this yet
AvB_amass_plot <- AvB_astats %>%
  filter(grp.trt !="A-337-hatch") %>%
  ggplot(aes(x = mass.instar, y = mass))

AvB_amass_plot + geom_boxplot(aes(fill = grp.trt)) + facet_wrap(~sex) +
  labs(title = "(AvB) adult masses", y = "mass (mg)", x = "stage") +
  scale_fill_manual(labels = AB_labels, values = AB_colors, drop = TRUE) + theme_bw()


## dev time (larval)
# done
AvB_ldev_plot <- AvB_lstats %>% 
  ggplot(aes(y = days.to))

AvB_ldev_plot + geom_boxplot(aes(fill = grp.trt)) + 
  labs(title = "(AvB) larval instar development times", x = "stage", y = "days after hatching", fill = "group-treatment") +
  scale_fill_manual(labels = AB_labels, values = AB_colors) + theme_bw() +
  facet_grid(~duration.instar, switch="x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.spacing = unit(0, "lines"))



## dev time (post-pupation)
  # havent looked at this yet
AvB_adev_plot <- AvB_astats %>% 
  filter(grp.trt != "A-337-hatch") %>%
  ggplot(aes(x = duration.instar, y = days.to))

AvB_adev_plot + geom_boxplot(aes(fill = grp.trt)) +
  labs(title = "(AvB) post-pupation development times", x = "stage", y = "days after previous stage", fill="group-treatment") +
  scale_fill_manual(labels = AB_labels, values = AB_colors, drop = T) + theme_bw()




### combined mass & dev plots ###
# the lines are ugly but the plots look ok otherwise

AvB_lstats2 %>% ggplot(aes(y = avg.logmass, x = avg.daysto, color = grp.trt, shape = instar)) +
  geom_point() + 
  #geom_line(aes(group = grp.trt)) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.logmass - se.logmass, ymax = avg.logmass + se.logmass)) +
  labs(title = "(AvB) larval instar development times", x = "days after hatching", y = "log(mass (mg))", 
       color = "group-treatment", shape = "instar") +
  scale_fill_manual(labels = AB_labels, values = AB_colors) + theme_bw()

# colors arent right?
AvB_astats2 %>% filter(grp.trt != "A-337-hatch") %>%
  ggplot(aes(y = avg.mass, x = avg.daysto, color = grp.trt, shape = instar)) +
  geom_point() + facet_wrap(~sex) +
  #geom_line(aes(group = grp.trt)) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.mass - se.mass, ymax = avg.mass + se.mass)) +
  labs(title = "(AvB) adult development times", x = "days after previous stage", y = "mass (mg)", 
       color = "group-treatment", shape = "instar") +
  scale_fill_manual(labels = AB_labels, values = AB_colors, drop=T) + theme_bw()


#### 230504 imo this looks better once the not hatched @ 26C are dropped

```




