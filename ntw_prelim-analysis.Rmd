---
title: "NTW prelim data analysis"
output: html_notebook
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, include = FALSE)
```

# information

here is code for some analysis of preliminary NTW experiments. as usual i keep making 50 different new files for things bc im indecisive about how to do things

TODO list: (search `// TODO`)

* [done] create `daysto.` columns (from hatching) for all instars/development timepoints


statistics to measure:

* [done] log average weight at instars
  * h/m considerations... (esp for grp B)
* [done] average length of instars
* survival
* A vs B comparisons (26 constant)
* who got stuck
* pupa development


experiment groups:

* A: 2x2 of mean temp = 26 or 33, with 0 degC fluct or 7 degC fluct
* B: 
  * redoing 337 from hatching (A)
  * 2x2(ish) of entering 260 or 337 treatment at different times (hatch, 3rd, 4th)

# load packages

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
#library(data.table) #for setDT
```

# load in data and clean
```{r}
data_all <- read.csv("~/Documents/projects/data/ntw_data/development.csv", header = T)

# save wordier notes elsewhere and remove from analysis dataset
data_notes <- select(data_all, c("from.E", "treatment", "ID", "expt.group", "pupa.deformities", "notes"))
data <- select(data_all, -c("notes", "mass.toast", "pupa.deformities", "mass.died")) # not sure if 'notes' column will mess things up

# remove individuals that didn't survive to pupation
data <- data %>% filter(reason.pmd == "" | reason.pmd == "pupa" | reason.pmd == "toast")

# create julian date columns
data <- data %>% mutate(across(starts_with("date."),  as.Date, format = "%m/%d/%y")) %>%
  mutate(across(starts_with("date."), format, "%j", .names = "j{.col}")) %>%
  #relocate(starts_with("jdate."), .after = starts_with("date.")) %>%
  mutate(across(starts_with("jdate."), as.numeric))

# pivot and make subsets
long <- data %>% select(-(starts_with("date."))) %>%
                 pivot_longer(cols = starts_with(c("jdate", "mass", "h")),
                        names_to = c(".value", "instar"),
                        #names_sep = ".",
                        values_drop_na = TRUE,
                        names_pattern = ("([a-z]*)\\.(\\d*[a-z]*)")) %>%
                 rename(molt.status = h)

long <- long[long$instar != "in",] # from 'instar.in.trt'?

# create subsets
data_A <- long[long$expt.group == "A",]
data_B <- long[long$expt.group == "B",]

```

# pt A analysis

```{r}
# growth_A <- data_A %>% group_by(treatment) %>%
#   summarise(n = n(),
#             log.avg.mass.3rd = mean(log(mass.3rd), na.rm=T), sd.mass.3rd = sd(log(mass.3rd), na.rm=T),
#             log.avg.mass.4th = mean(log(mass.4th), na.rm=T), sd.mass.4rd = sd(log(mass.4th), na.rm=T),
#             log.avg.mass.5th = mean(log(mass.5th), na.rm=T), sd.mass.5th = sd(log(mass.5th), na.rm=T),
#             log.avg.mass.wander = mean(log(mass.wander), na.rm=T), sd.mass.wander = sd(log(mass.wander), na.rm=T))

# works!!
growth_A <- data_A %>% group_by(treatment, instar) %>%
  filter(instar == "3rd" | instar == "4th" | instar == "5th" | instar == "wander") %>%
  summarise(n = n(),
            avg.log.mass = mean(log(mass), na.rm = T),
            sd.log.mass = sd(log(mass), na.rm = T))

# works!!
adultmass_A <- data_A %>% group_by(treatment, sex) %>%
  filter(instar == "pupa" | instar == "adult") %>%
  summarise(n=n(),
            avg.log.mass = mean(mass, na.rm = T),
            sd.log.mass = sd(mass, na.rm = T))

# works? maybe needs pivot_wider?
devtime_A <- data %>% filter(expt.group == "A") %>%
  select(-starts_with(c("h", "date", "mass", "reason."))) %>%
  mutate("2nd" = jdate.2nd - jdate.hatch,
         "3rd" = jdate.3rd - jdate.hatch,
         "4th" = jdate.4th - jdate.hatch,
         "5th" = jdate.5th - jdate.hatch,
         wander = jdate.wander - jdate.hatch,
         pupate = jdate.pupate - jdate.wander,
         eclose = jdate.eclose - jdate.15) %>%
  select(-starts_with("jdate.")) %>%
  pivot_longer (cols = c("2nd", "3rd", "4th", "5th", "wander", "pupate", "eclose"), # pivot differences by stage
                names_to = "stage",
                values_to = "days.to",
                values_drop_na = T) %>%
  group_by(treatment, stage) %>%
  summarise(n = n(),
            avg.diff = mean(days.to, na.rm = T),
            sd.diff = sd(days.to, na.rm = T))

# works, needs better names though...
stats_A <- merge(growth_A, devtime_A, by=c("treatment", "n")) %>%
  rename(instar.mass = instar, # mass
         instar.duration = stage) # time
```

# make dfs plottable

```{r}


```


# pt A plotting

```{r}
# larval masses (combine w/ adults?)

#massA_plot <- ggplot(data = stats_A)


```


# pt B analysis

* check for batch effects (260 and 337)
  * merge 260A and 337A with B if its ok
* similar analyses for these groups as in A




# overall survivorship

* who died? (pmd) pre or post 3rd? did all slow growers die?
