---
title: "NTW prelim data analysis"
output: html_notebook
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, echo = TRUE)

library(dplyr)
library(ggplot2)
library(tidyr)
library(survival) # for kaplan-meier/survival objects
library(cmprsk) # bc i think that's what this is lol
#library(survminer) # maybe, for visualisation
```

# information & todo

here is code for some analysis of preliminary NTW experiments. as usual i keep making 50 different new files for things bc im indecisive about how to do things

TODO list: (search `// TODO`)

* [done] create `daysto.` columns (from hatching) for all instars/development timepoints
* consolidate todo items up here lol (then redistribute to below... or vice versa)


TODO / statistics to measure:


* [!!!] lowkey double check that #s are right due to what we discovered with the na_drop!!!
* [done] log average weight at instars
  * h/m considerations... (esp for grp B)
  * from.E considerations... (only pick 0 and 1?)
  * for clarity, should come up w better naming system for the adults/larva + groupings
* [done for A, B] average length of instars
* [doneish] survival
  * kaplan meier curves -- see:
    * https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/
    * https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html#Packages 
* [done] A vs B comparisons (26 constant)
  * [done] pool relevant A+B individuals --> then stats again?
* who got stuck
* pupa development (looking @ % none? idr what i originally meant here)
* dv coloring (with B only)
* graph a bunch of growth lines + avg growth
* [in prog] plot time vs mass (dot plot w/ error bars on both sides)


experiment groups:

* A: 2x2 of mean temp = 26 or 33, with 0 degC fluct or 7 degC fluct
* B: 
  * redoing 337 from hatching (A)
  * 2x2(ish) of entering 260 or 337 treatment at different times (hatch, 3rd, 4th)

# load packages (use the setup chunk instead)

```{r load libraries}
# library(dplyr)
# library(ggplot2)
# library(tidyr)

# for some reason this broke on 230321 so now use the setup chunk

#library(data.table) #for setDT (forget why i was thinking about this one)
#library(survival) # for kaplan-meier
```

# load in data and clean, labels

outputs

* data_all, data_notes, data (surv to pup)
  * maybe rename data to data_ec (surv to eclosion)
* data_A, data_B

```{r quick load data}
load(file="dfs.RData")
```

```{r data preprocess + clean}
data_all <- read.csv("~/Documents/projects/data/ntw_data/development.csv", header = T)

# save wordier notes elsewhere and remove from analysis dataset
data_notes <- select(data_all, c("from.E", "treatment", "ID", "expt.group", "pupa.deformities", "final.fate", "notes"))
data_pup <- select(data_all, -c("notes", "mass.toast", "pupa.deformities", "mass.died", "time.in.approx")) 
  # not sure if 'notes' column will mess things up

# create julian date columns, additional column fixing
data_all <- data_all %>% mutate(across(starts_with("date."),  as.Date, format = "%m/%d/%y")) %>%
  mutate(across(starts_with("date."), format, "%j", .names = "j{.col}")) %>%
  mutate(across(starts_with("jdate."), as.numeric),
         across(starts_with("mass."), as.numeric),
         treatment = as.character(treatment),
         trt.stage = as.character(paste(treatment,instar.enter, sep = "-")), # treatment @ instar
         grp.trt = paste(expt.group, trt.stage, sep = "-")) # round @ treatment

# keep individuals that survived to pupation
data_pup <- data_all %>% filter(reason.pmd == "" | reason.pmd == "pupa" | reason.pmd == "toast" )
  # omit the LPs? -> currently yes

# pivot and make subsets
long <- data_pup %>% select(-(starts_with("date."))) %>%
                 pivot_longer(cols = starts_with(c("jdate", "mass", "h")),
                        names_to = c(".value", "instar"),
                        #names_sep = ".",
                        values_drop_na = TRUE,
                        names_pattern = ("([a-z]*)\\.(\\d*[a-z]*)")) %>%
                 rename(molt.status = h) %>%
                 drop_na(jdate) # drops NA's if an individual didnt reach a certain stage

long <- long[long$instar != "in",] # from 'instar.in.trt'?
long$instar <- factor(long$instar, c("hatch", "2nd", "3rd", "4th", "5th", "stuck", "wander", "pupa", "eclose", "pmd"))

# create subsets
data_A <- long[long$expt.group == "A",]
data_B <- long[long$expt.group == "B",]

# defining factors, labels
# A: effect of temp (treatment)
A_colors <- c("260-hatch"="#abd9e9","267-hatch"="#2c7bb6", "330-hatch"="#fdae61", "337-hatch"="#d7191c")
A_labels <- c("260-hatch"="26°C", "267-hatch"="26±7°C", "330-hatch"="33°C", "337-hatch"="33±7°C")

# B: effect of temp:instar (trt.stage)
B_trts = c("260-hatch", "337-4th", "337-3rd", "337-hatch") # manually set factor levels
B_colors = c("260-hatch"="#abd9e9", "337-4th"="#fdbe85", "337-3rd"="#fd8d3c", "337-hatch"="#d94701")
B_labels = c("260-hatch"="26°C @ hatch", "337-4th"="33±7°C @ 4th", "337-3rd"="33±7°C @ 3rd", "337-hatch"="33±7°C @ hatch")

  # addtl subset to include 33 constant (5 groups)
B5_trts = c("260-hatch", "330-hatch", "337-4th", "337-3rd", "337-hatch")
B5_colors = c("260-hatch"="#abd9e9", "330-hatch"="#ffddaa", "337-4th"="#fdae6b", "337-3rd"="#e6550d", "337-hatch"="#a63603")
B5_labels = c("260-hatch"="26°C @ hatch", "330-hatch" = "33°C @ hatch","337-4th"="33±7°C @ 4th", "337-3rd"="33±7°C @ 3rd", "337-hatch"="33±7°C @ hatch")

# save all this as .RData file (delete later)
#save(data_all, data_notes, data, long, data_A, data_B, A_colors, A_labels, B_trts, B_colors, B_labels, file="dfs.RData")

```

# comparing A vs B

* to compare batch effects
* maybe do combining of A+B here [this is done in the AB pool analyses]

## AvB analysis

```{r analysis A vs B}
## I THINK THIS IS OK/DONE NOW

AvB_lgrowth <- long %>% 
    filter((trt.stage == "260-hatch" | trt.stage == "337-hatch") &
           (instar == "3rd" | instar == "4th" | instar == "5th" | instar == "wander")) %>%
    group_by(grp.trt) %>%
    mutate(logmass = log(mass))

AvB_agrowth <- long %>% 
  filter((trt.stage == "260-hatch" | trt.stage == "337-hatch") &
          (instar == "pupa" | instar == "eclose")) %>%
  group_by(grp.trt, sex)


AvB_devtime <- data_pup %>%
  filter((trt.stage == "337-hatch" | trt.stage == "260-hatch") & (expt.group == "A" | expt.group == "B")) %>%
  mutate(grp.trt = paste(expt.group, trt.stage, sep = "-")) %>%
  select(-starts_with(c("h", "date", "mass", "reason."))) %>%
  mutate("2nd" = jdate.2nd - jdate.hatch,
         "3rd" = jdate.3rd - jdate.hatch,
         "4th" = jdate.4th - jdate.hatch,
         "5th" = jdate.5th - jdate.hatch,
         wander = jdate.wander - jdate.hatch,
         pupa = jdate.pupa - jdate.wander,
         #eclose = jdate.eclose - jdate.15
         eclose = jdate.eclose - jdate.pupa) %>%
  select(-starts_with("jdate.")) %>%
  pivot_longer (cols = c("2nd", "3rd", "4th", "5th", "wander", "pupa", "eclose"), # pivot differences by stage
                names_to = "stage",
                values_to = "days.to",
                values_drop_na = T) %>%
  group_by(grp.trt, stage)

AvB_ldev <- filter(AvB_devtime, stage == "3rd" | stage == "4th" | stage == "5th" | stage == "wander")
AvB_adev <- filter(AvB_devtime, stage == "pupa" | stage == "eclose")

# merge stats into larva/adult subsets
AvB_lstats <- merge(AvB_lgrowth, AvB_ldev, all = T) %>%
  rename(mass.instar = instar, # mass
         duration.instar = stage) # time

AvB_astats <- merge(AvB_agrowth, AvB_adev, all = T) %>%
  rename(mass.instar = instar, # mass
         duration.instar = stage) # time


### for plotting mass & dev simultaneously ###
AvB_lstats2 <- AvB_devtime %>% 
  filter(stage == "3rd" | stage == "4th" | stage == "5th" | stage == "wander") %>%
  rename(instar = stage) %>%
  merge(AvB_lgrowth, all=T) %>%
  group_by(grp.trt, instar) %>%
  summarise(avg.logmass = mean(logmass),
            se.logmass = sd(logmass)/sqrt(length(logmass)),
            avg.mass = mean(mass),
            se.mass = sd(mass)/sqrt(length(mass)),
            avg.daysto = mean(days.to),
            se.daysto = sd(days.to)/sqrt(length(days.to)),
            n=n())

AvB_astats2 <- AvB_devtime %>% 
  filter(stage == "pupa" | stage == "eclose") %>%
  rename(instar = stage) %>%
  #na.omit(jdate) %>%
  merge(AvB_agrowth, all=T) %>%
  group_by(grp.trt, instar, sex) %>%
  summarise(avg.mass = mean(mass),
            se.mass = sd(mass)/sqrt(length(mass)),
            avg.daysto = mean(days.to),
            se.daysto = sd(days.to)/sqrt(length(days.to)),
            n=n())

```

## AvB plotting

(should do a proper test? compare the distributions/means?)

```{r plotting A vs B}
## I THINK THESE ARE DONE NOW (but go look at them again)
  # would be worth also plotting mass&dev simultaneously for these...

# define factors, levels
AvB_lstats$grp.trt <- factor(AvB_lstats$grp.trt, c("A-260-hatch", "B-260-hatch", "A-337-hatch", "B-337-hatch"))
AvB_astats$grp.trt <- factor(AvB_astats$grp.trt, c("A-260-hatch", "B-260-hatch", "A-337-hatch", "B-337-hatch"))
AB_colors <- c("A-260-hatch"="#abd9e9", "B-260-hatch"="#2c7bb6", "A-337-hatch"="#fdae61", "B-337-hatch"="#d7191c")
AB_labels <- c("A-260-hatch"="A 26°C", "B-260-hatch"="B 26°C","A-337-hatch"="A 33±7°C", "B-337-hatch"="B 33±7°C")


## larval instar masses
# done
AvB_lstats %>% ggplot(aes(y = logmass)) + geom_boxplot(aes(fill = grp.trt)) +
  labs(title = "(AvB) mass at start of instar", x = "instar", y = "log(mass (mg))", fill = "group-treatment") +
  scale_fill_manual(labels = AB_labels, values = AB_colors) + theme_bw() +
  facet_grid(~mass.instar, switch="x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.spacing = unit(0, "lines"))


## adult masses
  # havent rly looked at this yet
AvB_amass_plot <- AvB_astats %>%
  filter(grp.trt !="A-337-hatch") %>%
  ggplot(aes(x = mass.instar, y = mass))

AvB_amass_plot + geom_boxplot(aes(fill = grp.trt)) + facet_wrap(~sex) +
  labs(title = "(AvB) adult masses", y = "mass (mg)", x = "stage") +
  scale_fill_manual(labels = AB_labels, values = AB_colors, drop = TRUE) + theme_bw()


## dev time (larval)
# done
AvB_ldev_plot <- AvB_lstats %>% 
  ggplot(aes(y = days.to))

AvB_ldev_plot + geom_boxplot(aes(fill = grp.trt)) + 
  labs(title = "(AvB) larval instar development times", x = "stage", y = "days after hatching", fill = "group-treatment") +
  scale_fill_manual(labels = AB_labels, values = AB_colors) + theme_bw() +
  facet_grid(~duration.instar, switch="x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.spacing = unit(0, "lines"))



## dev time (post-pupation)
  # havent looked at this yet
AvB_adev_plot <- AvB_astats %>% 
  filter(grp.trt != "A-337-hatch") %>%
  ggplot(aes(x = duration.instar, y = days.to))

AvB_adev_plot + geom_boxplot(aes(fill = grp.trt)) +
  labs(title = "(AvB) post-pupation development times", x = "stage", y = "days after previous stage", fill="group-treatment") +
  scale_fill_manual(labels = AB_labels, values = AB_colors, drop = T) + theme_bw()




### combined mass & dev plots ###
# the lines are ugly but the plots look ok otherwise

AvB_lstats2 %>% ggplot(aes(y = avg.logmass, x = avg.daysto, color = grp.trt, shape = instar)) +
  geom_point() + 
  #geom_line(aes(group = grp.trt)) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.logmass - se.logmass, ymax = avg.logmass + se.logmass)) +
  labs(title = "(AvB) larval instar development times", x = "days after hatching", y = "log(mass (mg))", 
       color = "group-treatment", shape = "instar") +
  scale_fill_manual(labels = AB_labels, values = AB_colors) + theme_bw()

# colors arent right?
AvB_astats2 %>% filter(grp.trt != "A-337-hatch") %>%
  ggplot(aes(y = avg.mass, x = avg.daysto, color = grp.trt, shape = instar)) +
  geom_point() + facet_wrap(~sex) +
  #geom_line(aes(group = grp.trt)) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.mass - se.mass, ymax = avg.mass + se.mass)) +
  labs(title = "(AvB) adult development times", x = "days after previous stage", y = "mass (mg)", 
       color = "group-treatment", shape = "instar") +
  scale_fill_manual(labels = AB_labels, values = AB_colors, drop=T) + theme_bw()


```

# AB pooled

## AB2 pooled mass&dev analysis

[done!!!!!] want to look at mass/dev time simultaneously on y/x axes respectively

* need to calc: log.se.mass, se.days.to
  * can use the lstats_AB and astats_AB

```{r}
# larva/adult mass @ instars
  # pupa/adults need to be separated from the larva before summarising bc of sex differences

# these 2 should work bc i fixed "long"
AB2_lmass <- long %>% 
    filter(instar == "3rd" | instar == "4th" | instar == "5th" | instar == "wander") %>%
    group_by(instar, trt.stage) %>%
    mutate(logmass = log(mass)) %>%
    summarise(avg.mass = mean(mass),
              se.mass = sd(mass)/sqrt(length(mass)),
              avg.logmass = mean(logmass),
              se.logmass = sd(logmass)/sqrt(length(logmass)),
              n=n())

AB2_amass <- long %>% group_by(trt.stage, sex, instar) %>%
    filter(instar == "pupa" | instar == "eclose") %>%
    summarise(avg.mass = mean(mass),
              se.mass = sd(mass)/sqrt(length(mass)),
              n=n())

# calculate development time (instar duration), then split into larva/adults + summarise
AB2_devtime <- data_pup %>% 
  select(-starts_with(c("h", "date", "mass", "reason."))) %>%
  mutate("2nd" = jdate.2nd - jdate.hatch,
         "3rd" = jdate.3rd - jdate.hatch,
         "4th" = jdate.4th - jdate.hatch,
         "5th" = jdate.5th - jdate.hatch,
         wander = jdate.wander - jdate.hatch,
         pupa = jdate.pupa - jdate.wander,
         #eclose = jdate.eclose - jdate.15
         eclose = jdate.eclose - jdate.pupa) %>%
  select(-starts_with("jdate.")) %>%
  pivot_longer (cols = c("2nd", "3rd", "4th", "5th", "wander", "pupa", "eclose"), # pivot differences by stage
                names_to = "instar",
                values_to = "days.to") %>%
  na.omit(days.to)

AB2_ldev <- AB2_devtime %>% 
  filter(instar == "3rd" | instar == "4th" | instar == "5th" | instar == "wander") %>%
  group_by(trt.stage, instar) %>%
  summarise(avg.daysto = mean(days.to),
            se.daysto = sd(days.to)/sqrt(length(days.to)))

AB2_adev <- AB2_devtime %>% 
  filter(instar == "pupa" | instar == "eclose") %>%
  group_by(trt.stage, sex, instar) %>%
  summarise(avg.daysto = mean(days.to),
            se.daysto = sd(days.to)/sqrt(length(days.to)))


# merge into larval/adult stats
#lstats_AB2 <- merge(lmass_AB2, ldev_AB2, cols = c("trt.stage", "instar")) 
AB2_lstats <- merge(AB2_lmass, AB2_ldev, all = T) 
AB2_astats <- merge(AB2_amass, AB2_adev, all = T)


# create subsets for plotting effect of temp and temp @ instar
# temp effect subsets
AB2_ltemps <- AB2_lstats %>% filter(trt.stage != "337-3rd" & trt.stage != "337-4th")
AB2_atemps <- AB2_astats %>% filter(trt.stage != "337-3rd" & trt.stage != "337-4th")

# temp+instar effects subsets
AB2_linstar <- AB2_lstats %>% filter(trt.stage == "260-hatch" | trt.stage == "337-hatch" | trt.stage == "337-3rd" | trt.stage == "337-4th")
AB2_ainstar <- AB2_astats %>% filter(trt.stage == "260-hatch" | trt.stage == "337-hatch" | trt.stage == "337-3rd" | trt.stage == "337-4th")

AB2_linstar2 <- AB2_lstats %>% filter(trt.stage != "267-hatch")
AB2_ainstar2 <- AB2_astats %>% filter(trt.stage != "267-hatch")


```


  
## AB2 pooled mass&dev plots  

* [done] add 33 constant to tempxinstar..

```{r}
# I REALLY HOPE THESE ARE DONE....


### plots comparing effect of temps ###
# larval mass/dev
AB2_ltemps %>% 
  ggplot(aes(x = avg.daysto, y = avg.logmass, shape=instar, color=trt.stage)) +
  geom_point() +
  geom_line(aes(group = trt.stage), alpha = 0.5) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.logmass - se.logmass, ymax = avg.logmass + se.logmass)) +
  labs(title = "(temp) avg larval growth", x = "days since hatching", y = "avg log(mass (mg))", color = "treatment") +
  scale_color_manual(labels=A_labels, values = A_colors) + theme_bw()

# adult mass/dev
AB2_atemps %>% 
  ggplot(aes(x = avg.daysto, y = avg.mass, color=trt.stage)) +
  geom_point() +
  geom_line(aes(group = trt.stage), alpha=0.5) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.mass - se.mass, ymax = avg.mass + se.mass)) +
  facet_wrap(~sex) +
  labs(title = "(temp) avg adult growth", y = "avg mass (mg)", x = "days since last stage") +
  scale_color_manual(values = A_colors, labels=A_labels) + theme_bw()

### plots comparing effect of temp x instar ###
# larval mass/dev
  # hard to see shapes...
AB2_linstar %>% 
  ggplot(aes(x = avg.daysto, y = avg.logmass, shape=instar, color=trt.stage)) +
  geom_point(size=2, alpha = 0.5) +
  geom_line(aes(group = trt.stage), alpha = 0.5) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.logmass - se.logmass, ymax = avg.logmass + se.logmass)) +
  labs(title = "(temp x instar) avg larval growth", x = "days since hatching", y = "avg log(mass (mg))", color = "treatment") +
  scale_color_manual(labels = B_labels, values = B_colors) + theme_bw()

# adult mass/dev
AB2_ainstar %>% 
  ggplot(aes(x = avg.daysto, y = avg.mass, shape=instar, color=trt.stage)) +
  geom_point(size=2, alpha = 0.5) +
  geom_line(aes(group = trt.stage), alpha = 0.5) +
  facet_wrap(~sex) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.mass - se.mass, ymax = avg.mass + se.mass)) +
  scale_color_manual(labels = B_labels, values = B_colors) + theme_bw() +
  labs(title = "(temp x instar) avg adult growth", y = "avg mass (mg)", x = "days since last stage")


# B+1 larval mass/dev
AB2_linstar2 %>% 
  ggplot(aes(x = avg.daysto, y = avg.logmass, shape=instar, color=trt.stage)) +
  geom_point(size=2, alpha = 0.5) +
  geom_line(aes(group = trt.stage), alpha = 0.5) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.logmass - se.logmass, ymax = avg.logmass + se.logmass)) +
  labs(title = "(temp x instar) avg larval growth", x = "days since hatching", y = "avg log(mass (mg))", color = "treatment") +
  scale_color_manual(labels = B5_labels, values = B5_colors) + theme_bw()


# B+1 adult mass/dev
AB2_ainstar2 %>% 
  ggplot(aes(x = avg.daysto, y = avg.mass, shape=instar, color=trt.stage)) +
  geom_point(size=2, alpha = 0.5) +
  geom_line(aes(group = trt.stage), alpha = 0.5) +
  facet_wrap(~sex) +
  geom_errorbarh(aes(xmin= avg.daysto - se.daysto, xmax = avg.daysto + se.daysto)) +
  geom_errorbar(aes(ymin = avg.mass - se.mass, ymax = avg.mass + se.mass)) +
  scale_color_manual(labels = B5_labels, values = B5_colors) + theme_bw() +
  labs(title = "(temp x instar) avg adult growth", y = "avg mass (mg)", x = "days since last stage")



```




# overall survivorship/kill curves

* who died? (pmd) pre or post 3rd? did all slow growers die?
  * want to add columns for this!
  * how to grp trts? (by mean/fluct/instar? or mean-fluct/instar?)
* visualise: curve + do stacked bars (for an overview)?

## pmd analysis (defunct, do KM instead)

leaving this here for reference, but use KM to look at the data instead

```{r defunct! all pmd stats & plots}
# probably finished

data_pmd <- data_all %>% select(-c("notes", "mass.toast", "pupa.deformities", "mass.died")) %>%
  filter(reason.pmd != "toast", reason.pmd != "squished", reason.pmd != "empty") %>%
  mutate(trt.stage = paste(treatment,instar.enter, sep = "-")) %>%
  group_by(trt.stage, reason.pmd) %>% # grouping by expt.group is wonky (summing is weird)
  summarise(n=n())

data_pmd[data_pmd==""] <- "survived"

# summary table
pmd_stats <- data_pmd %>% pivot_wider(names_from = reason.pmd, values_from = n) %>%
  group_by(trt.stage) %>%
  replace(is.na(.), 0) %>%
  mutate(n = sum(c(survived, pupa, pmd, LP))) %>% select(-survived) %>%
  mutate(pct.pupa = round(pupa/n*100, digits = 1),
         pct.larva = round(pmd/n*100, digits = 1),
         pct.LPI = round(LP/n*100, digits = 1),
         "total pct" = sum(c(pct.pupa, pct.larva, pct.LPI))) %>%
  rename(larva = pmd, LPI = LP)

# individuals (need to manually reorg table to see better)
individial_pmd <- data_all %>% select(-c("notes", "mass.toast", "pupa.deformities", "mass.died")) %>%
  filter(reason.pmd == "pmd" | reason.pmd == "LP" | reason.pmd == "pupa") %>%
  mutate(trt.stage = paste(treatment,instar.enter, sep = "-"), .before = 1) %>%
  mutate(across(starts_with("date."),  as.Date, format = "%m/%d/%y")) %>%
  mutate(across(starts_with("date."), format, "%j", .names = "j{.col}")) %>%
  #relocate(starts_with("jdate."), .after = starts_with("date.")) %>% # this is not working lol
  mutate(across(starts_with("jdate."), as.numeric),
         "2nd" = jdate.2nd - jdate.hatch,
         "3rd" = jdate.3rd - jdate.hatch,
         "4th" = jdate.4th - jdate.hatch,
         "5th" = jdate.5th - jdate.hatch,
         #stuck = jdate.stuck - jdate.hatch,
         #was.stuck = ifelse(date.stuck != "", "1", "NA", #not working like i want it to lol
         wander = jdate.wander - jdate.hatch,
         pupate = jdate.pupate - jdate.wander) %>%
  rename("days.to.2nd" = "2nd", "days.to.3rd" = "3rd","days.to.4th" = "4th","days.to.5th" = "5th", "days.to.wander" = wander,"days.to.pupate" = pupate) %>%
  select(-starts_with(c("jdate.", "h.", "date.", "from.", "instar.", "time.")), -c("treatment", "dv", "mass.adult"))

```

## kaplan-meier curves

* b/g reading
  * general ideas https://datatab.net/tutorial/survival-analysis
      * prob use cox to account for instar entered, trt, stuck in 5th
        * http://www.sthda.com/english/wiki/cox-proportional-hazards-model 
        * https://rstudio-pubs-static.s3.amazonaws.com/5896_8f0fed2ccbbd42489276e554a05af87e.html 
* probably use [this](https://dk81.github.io/dkmathstats_site/rvisual-kaplan-meier.html)
  * https://argoshare.is.ed.ac.uk/healthyr_book/recode-the-data-1.html 
    * look into [cox.zph](https://argoshare.is.ed.ac.uk/healthyr_book/cox-proportional-hazards-regression.html) for stuck?


variables needed

* id, trt, etc (group curves by trt?)
* time to pmd/event (death as LP, P, L)
* censorship for other events (stuck)

```{r survival coding}
## calculate time to event and recode events

  # can hardcode fates into here so dont have to be in exel (using recode())

# calculate date of exit and other columns
surv <- data_all %>% 
  filter(fate.code != "99") %>% # remove accidental deaths
  mutate(timeto.exit = jdate.exit-jdate.hatch,
         meantemp = ifelse((treatment=="260" | treatment=="267"), 26, 33),
         fluct = ifelse((treatment == "260" | treatment == "330"), 0, 7),
         devent = ifelse(final.fate=="eclose", 0, 1), # 1 if died
         devent2 = ifelse(final.fate=="eclose", NA, fate.code), #testing smth
         fate.code = ifelse(final.fate=="eclose", 0, 1)) # to filter out eclosion later

# recode censoring: censoring indicators for each type of failure
surv$fail1 <- ifelse(surv$fate.code=="1" & surv$devent=="1", 1, 0)
surv$fail2 <- ifelse(surv$fate.code=="2" & surv$devent=="1", 1, 0)
surv$fail3 <- ifelse(surv$fate.code=="3" & surv$devent=="1", 1, 0)
surv$fail4 <- ifelse(surv$fate.code=="4" & surv$devent=="1", 1, 0)
surv$fail5 <- ifelse(surv$fate.code=="5" & surv$devent=="1", 1, 0)
surv$fail6 <- ifelse(surv$fate.code=="6" & surv$devent=="1", 1, 0)
surv$fail7 <- ifelse(surv$fate.code=="7" & surv$devent=="1", 1, 0)
surv$fail8 <- ifelse(surv$fate.code=="8" & surv$devent=="1", 1, 0) #idk how to handle these yet

# censor data
surv$censor <- NA
surv$dcode <- ifelse(is.na(surv$fate.code)==T, 0, surv$fate.code) # filter eclosed
surv$censor[which(surv$fail1==0&surv$fail2==0&surv$fail3==0&surv$fail4==0&surv$fail5==0&surv$fail6==0&surv$fail7==0&surv$fail8==0)] <- 0 # eclosed
surv$censor[which(surv$fail1==1|surv$fail2==1|surv$fail3==1|surv$fail4==1|surv$fail5==1|surv$fail6==1|surv$fail7==1&surv$fail8==0)] <- 1 # died at some point
surv$censor[which(surv$fail1==0&surv$fail2==0&surv$fail3==0&surv$fail4==0&surv$fail5==0&surv$fail6==0&surv$fail7==0&surv$fail8==1)] <- 2 # toasted

## look at events 
# (death, eclose, or toast)
table(surv$censor, surv$devent)

# (types of death)
table(surv$devent2, surv$dcode)
```

```{r survival plots}



```



# code dump

things im not using anymore but can reference. recently added stuff is at the top

## old AB pooled analyses (use the mass/dev combined ones instead)


### AB1 pooled analysis

```{r AB pool analysis}
# doing this some groups seem fine to combine
  # // TO DO: futzing around but i think actually keep the grouping separate LOL (i.e. dont list 100 treatments tgt)
    # i totally cannot remember what this means lol
# stealing code from AvB

# larva/adult mass @ instars
  # pupa/adults need to be separated from the larva bc of sex differences
AB_lmass <- long %>% group_by(trt.stage) %>%
    filter(instar == "3rd" | instar == "4th" | instar == "5th" | instar == "wander") %>%
    mutate(log.mass = log(mass))

AB_amass <- long %>% group_by(trt.stage, sex) %>%
  filter(instar == "pupa" | instar == "adult")

# calculate development time (instar duration), split into larva/adults
AB_devtime <- data_pup %>% 
  select(-starts_with(c("h", "date", "mass", "reason."))) %>%
  mutate("2nd" = jdate.2nd - jdate.hatch,
         "3rd" = jdate.3rd - jdate.hatch,
         "4th" = jdate.4th - jdate.hatch,
         "5th" = jdate.5th - jdate.hatch,
         wander = jdate.wander - jdate.hatch,
         pupate = jdate.pupa - jdate.wander,
         #eclose = jdate.eclose - jdate.15
         eclose = jdate.eclose - jdate.pupa) %>%
  select(-starts_with("jdate.")) %>%
  pivot_longer (cols = c("2nd", "3rd", "4th", "5th", "wander", "pupate", "eclose"), # pivot differences by stage
                names_to = "stage",
                values_to = "days.to",
                values_drop_na = T) %>%
  group_by(trt.stage, stage) %>%
  mutate(se.daysto = sd(days.to)/sqrt(length(days.to)),
         avg.daysto = mean(days.to))

AB_ldev <- AB_devtime %>% filter(stage == "3rd" | stage == "4th" | stage == "5th" | stage == "wander")
AB_adev <- AB_devtime %>% filter(stage == "pupate" | stage == "eclose")


# merge into larval/adult stats
  ## doublecheck this is where log mass goes for the mass/dev simultaneoous LOL
AB_lstats <- merge(AB_lmass, AB_ldev, all = T) %>%
  group_by(trt.stage, instar) %>% mutate(se.logmass = sd(log.mass)/sqrt(length(log.mass)),
                                         avg.logmass = mean(log.mass)) %>%
  rename(instar.mass = instar, # mass @ start of instar
         instar.duration = stage) # duration of instar 

AB_astats <- merge(AB_amass, AB_adev, all = T) %>%
  group_by(trt.stage, instar) %>% mutate(se.mass = sd(mass)/sqrt(length(mass)),
                                         avg.mass = mean(mass)) %>%
  rename(instar.mass = instar,
         instar.duration = stage)


# create subsets for plotting effect of temp and temp @ instar
# temp effect subsets
AB_ltemps <- AB_lstats %>% filter(instar.enter == "hatch")
AB_atemps <- AB_astats %>% filter(instar.enter == "hatch")

# temp+instar effects subsets
AB_linstar <- AB_lstats %>% filter(trt.stage == "260-hatch" | trt.stage == "337-hatch" | trt.stage == "337-3rd" | trt.stage == "337-4th")
AB_ainstar <- AB_astats %>% filter(trt.stage == "260-hatch" | trt.stage == "337-hatch" | trt.stage == "337-3rd" | trt.stage == "337-4th")

```


### AB1 pooled plots

* todo: need to fix the adult ones (check subsetting + variables)

```{r AB pool plotting}
# using code from AvB
# I THINK THESE ARE DONE? (need to reexport plots) -> but also want to view them at the same time so this might be defunct once that one (AB pooled 2) is working


### plots comparing effect of temps ###
# larval masses
AB_ltemps %>% ggplot(aes(y = log.mass)) + geom_boxplot(aes(fill = treatment)) +
  labs(title = "(temp) mass at start of instar", x = "instar", y = "log(mass (mg))") +
  scale_fill_manual(labels = A_labels, values = A_colors) + theme_bw() +
  facet_grid(~instar.mass, switch="x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.spacing = unit(0, "lines"))

# adult masses
AB_atemps %>% filter(sex != "") %>% # omit pt B unpupated ones
  ggplot(aes(x = factor(instar.mass, level = c("pupa", "adult")), y = mass)) + geom_boxplot(aes(fill = treatment)) + facet_wrap(~sex) +
  labs(title = "(temp) adult masses", y = "mass (mg)", x = "stage") +
  scale_fill_manual(values = A_colors, labels=A_labels) + theme_bw()

# larval dev time
AB_ltemps %>% ggplot(aes(y = days.to)) + geom_boxplot(aes(fill = treatment)) +
  labs(title = "(temp) larval instar development times", x = "stage", y = "days after hatching") +
  scale_fill_manual(labels = A_labels, values = A_colors) + theme_bw() +
  facet_grid(~instar.duration, switch="x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.spacing = unit(0, "lines"))

# adult dev time
AB_atemps %>% ggplot(aes(x = factor(instar.duration, levels = c("pupate", "eclose")), y = days.to)) + geom_boxplot(aes(fill = treatment)) +
  labs(title = "(temp) post-pupation development times", x = "stage", y = "days after previous stage") +
  scale_fill_manual(labels = A_labels, values = A_colors) + theme_bw()

### plots comparing effect of temp x instar ###
# larval masses
AB_linstar %>% ggplot(aes(y = log.mass)) + geom_boxplot(aes(fill = factor(trt.stage, level= B_trts))) +
  labs(title = "(temp x instar) mass at start of instar", x = "instar", y = "log(mass (mg))", fill = "treatment") +
  scale_fill_manual(labels = B_labels, values = B_colors) + theme_bw() +
  facet_grid(~instar.mass, switch="x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.spacing = unit(0, "lines"))

# adult masses
AB_ainstar %>% ggplot(aes(x = factor(instar.mass, level = c("pupa", "adult")), y = mass)) +
  geom_boxplot(aes(fill = factor(trt.stage, level= B_trts))) + facet_wrap(~sex) +
  scale_fill_manual(labels = B_labels, values = B_colors) + theme_bw() +
  labs(title = "(temp x instar) adult masses", y = "mass (mg)", x = "stage", fill = "treatment")

# larval dev
AB_linstar %>% filter(instar.duration == "2nd" | instar.duration == "3rd" | instar.duration == "4th" | instar.duration == "5th" | instar.duration == "wander") %>%
  ggplot(aes(y = days.to)) + geom_boxplot(aes(fill = factor(trt.stage, level = B_trts))) +
  labs(title = "(temp x instar) larval instar development times", x = "stage", y = "days after hatching", fill = "treatment") +
  scale_fill_manual(labels = B_labels, values = B_colors) + theme_bw() +
  facet_grid(~instar.duration, switch="x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.spacing = unit(0, "lines"))


# dev time (post-pupation)
AB_ainstar %>% ggplot(aes(x = factor(instar.duration, levels = c("pupate", "eclose")), y = days.to)) + geom_boxplot(aes(fill = trt.stage)) +
  labs(title = "(temp x instar) post-pupation development times", x = "stage", y = "days after previous stage", fill = "treatment") +
  scale_fill_manual(labels = B_labels, values = B_colors) + theme_bw()

```





## old A + B isolated analyses (use the AB pooled one instead!!!!)

### (old) A only (temps)

#### pt A analysis

```{r A stats}
# for boxplot
A_growth <- data_A %>% group_by(treatment, instar) %>%
    filter(instar == "3rd" | instar == "4th" | instar == "5th" | instar == "wander") %>%
    mutate(log.mass = log(mass))

# for boxplot (lots of extra data but its fine)
A_adultmass <- data_A %>% group_by(treatment, sex) %>%
  filter(instar == "pupa" | instar == "adult")

# for boxplot (pivot wider later for some reason?)
A_devtime <- data %>% filter(expt.group == "A") %>%
  select(-starts_with(c("h", "date", "mass", "reason."))) %>%
  mutate("2nd" = jdate.2nd - jdate.hatch,
         "3rd" = jdate.3rd - jdate.hatch,
         "4th" = jdate.4th - jdate.hatch,
         "5th" = jdate.5th - jdate.hatch,
         wander = jdate.wander - jdate.hatch,
         pupate = jdate.pupate - jdate.wander,
         #eclose = jdate.eclose - jdate.15,
         eclose = jdate.eclose - jdate.pupate) %>%
  select(-starts_with("jdate.")) %>%
  pivot_longer (cols = c("2nd", "3rd", "4th", "5th", "wander", "pupate", "eclose"), # pivot differences by stage
                names_to = "stage",
                values_to = "days.to",
                values_drop_na = T) %>%
  group_by(treatment, stage)


A_stats <- merge(A_growth, A_devtime, all = T) %>%
  rename(instar.mass = instar, # mass
         instar.duration = stage) # time
```

#### pt A plotting

todo:

* [done, not B] larval growth/dev (maybe combine w/ part B at some point)
* [done] adult masses

```{r A plots}
## larval instar masses

massA_plot <- ggplot(data = stats_A2, aes(x = instar.mass, y = log.mass))

# this is okay
# massA_plot + geom_boxplot(aes(fill = treatment)) +
#   labs(title = "mass at start of instar", x = "instar", y = "log(mass (mg))") +
#   scale_fill_manual(values = A_colors) + theme_bw()
#   # // TODO: rename treatments/key

ggplot(data = stats_A2, aes(y = log.mass)) + geom_boxplot(aes(fill = treatment)) +
  labs(title = "(T) mass at start of instar", x = "instar", y = "log(mass (mg))") +
  scale_fill_manual(labels = A_labels, values = A_colors) + theme_bw() +
  facet_grid(~instar.mass, switch="x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.spacing = unit(0, "lines"))


## adult masses

adultA_plot <- ggplot(data = adultmass_A2, aes(x = factor(instar, level = c("pupa", "adult")), y = mass))

adultA_plot + geom_boxplot(aes(fill = treatment)) + facet_wrap(~sex) +
  labs(title = "adult masses", y = "mass (mg)", x = "stage") +
  scale_fill_manual(values = A_colors) + theme_bw()
  # // TODO: rename treatments/key


## dev time (larval)
# done
devA.l_plot <- stats_A2 %>% filter(instar.duration == "2nd" | instar.duration == "3rd" | instar.duration == "4th" | instar.duration == "5th" | instar.duration == "wander") %>%
  ggplot(aes(x = instar.duration, y = days.to))

# devA.l_plot + geom_boxplot(aes(fill = treatment)) +
#   labs(title = "larval instar development times", x = "stage", y = "days after hatching") +
#   scale_fill_manual(values = A_colors) + theme_bw()

stats_A2 %>% filter(instar.duration == "2nd" | instar.duration == "3rd" | instar.duration == "4th" | instar.duration == "5th" | instar.duration == "wander") %>%
  ggplot(aes(y = days.to)) + geom_boxplot(aes(fill = treatment)) +
  labs(title = "larval instar development times", x = "stage", y = "days after hatching") +
  scale_fill_manual(labels = A_labels, values = A_colors) + theme_bw() +
  facet_grid(~instar.duration, switch="x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.spacing = unit(0, "lines"))



## dev time (post-pupation)
# done
devA.a_plot <- stats_A2 %>% filter(instar.duration == "eclose" | instar.duration == "pupate") %>%
  ggplot(aes(x = factor(instar.duration, levels = c("pupate", "eclose")), y = days.to))

devA.a_plot + geom_boxplot(aes(fill = treatment)) +
  labs(title = "post-pupation development times", x = "stage", y = "days after previous stage") +
  scale_fill_manual(labels = A_labels, values = A_colors) + theme_bw()

```

### (old) B only (temp x stage)

* todo: look at this as a 2x2 (@ hatch, @ 3rd)

#### pt B analysis

* [see below] check for batch effects (260 and 337)
  * [done] merge 260A and 337A with B if its ok
* [done?] similar analyses for these groups as in A

```{r B stats}
# just copied over code from pt A and replaced w Bs
growth_B <- data_B %>% group_by(trt.stage) %>%
    filter(instar == "3rd" | instar == "4th" | instar == "5th" | instar == "wander") %>%
    mutate(log.mass = log(mass))

adultmass_B <- data_B %>% group_by(trt.stage, sex) %>%
  filter(instar == "pupa" | instar == "adult") %>%
  mutate(log.mass = log(mass))

devtime_B <- data %>% filter(expt.group == "B") %>%
  select(-starts_with(c("h", "date", "mass", "reason."))) %>%
  mutate("2nd" = jdate.2nd - jdate.hatch,
         "3rd" = jdate.3rd - jdate.hatch,
         "4th" = jdate.4th - jdate.hatch,
         "5th" = jdate.5th - jdate.hatch,
         wander = jdate.wander - jdate.hatch,
         pupate = jdate.pupate - jdate.wander,
         #eclose = jdate.eclose - jdate.15
         eclose = jdate.eclose - jdate.pupate) %>%
  select(-starts_with("jdate.")) %>%
  pivot_longer (cols = c("2nd", "3rd", "4th", "5th", "wander", "pupate", "eclose"), # pivot differences by stage
                names_to = "stage",
                values_to = "days.to",
                values_drop_na = T) %>%
  group_by(trt.stage, stage)

stats_B <- merge(growth_B, devtime_B, all = T) %>%
  rename(instar.mass = instar, # mass
         instar.duration = stage) # time
```

#### B plotting

(this will be the same as A)

```{r B plots}
## larval masses
massB_plot <- ggplot(data = stats_B, aes(x = instar.mass, y = log.mass))

# this is okay
# massB_plot + geom_boxplot(aes(fill = factor(trt.stage, level= B_trts))) +
#   labs(title = "mass at start of instar", x = "instar", y = "log(mass (mg))", fill = "treatment") +
#   scale_fill_manual(values = B_colors) + theme_bw()

ggplot(data = stats_B, aes(y = log.mass)) + geom_boxplot(aes(fill = factor(trt.stage, level= B_trts))) +
  labs(title = "mass at start of instar", x = "instar", y = "log(mass (mg))", fill = "treatment") +
  scale_fill_manual(labels = B_labels, values = B_colors) + theme_bw() +
  facet_grid(~instar.mass, switch="x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.spacing = unit(0, "lines"))


## adult masses
adultB_plot <- ggplot(data = adultmass_B, aes(x = factor(instar, level = c("pupa", "adult")), y = mass))

adultB_plot + geom_boxplot(aes(fill = factor(trt.stage, level= B_trts))) + facet_wrap(~sex) +
  labs(title = "adult masses", y = "mass (mg)", x = "stage", fill = "treatment") +
  scale_fill_manual(labels = B_labels, values = B_colors) + theme_bw()

## dev time (larval)
# done
devB.l_plot <- stats_B %>% filter(instar.duration == "2nd" | instar.duration == "3rd" | instar.duration == "4th" | instar.duration == "5th" | instar.duration == "wander") %>%
  ggplot(aes(x = instar.duration, y = days.to))

# devB.l_plot + geom_boxplot(aes(fill = factor(trt.stage, level = B_trts))) +
#   labs(title = "larval instar development times", x = "stage", y = "days after hatching", fill = "treatment") +
#   scale_fill_manual(labels = B_labels, values = B_colors) + theme_bw()

stats_B %>% filter(instar.duration == "2nd" | instar.duration == "3rd" | instar.duration == "4th" | instar.duration == "5th" | instar.duration == "wander") %>%
  ggplot(aes(y = days.to)) + geom_boxplot(aes(fill = factor(trt.stage, level = B_trts))) +
  labs(title = "larval instar development times", x = "stage", y = "days after hatching", fill = "treatment") +
  scale_fill_manual(labels = B_labels, values = B_colors) + theme_bw() +
  facet_grid(~instar.duration, switch="x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.spacing = unit(0, "lines"))
  # // TODO: take out the stuck ones...?


## dev time (post-pupation)

# not working bc adults arent in here lol
devB.a_plot <- stats_B %>% filter(instar.duration == "eclose" | instar.duration == "pupate") %>%
  ggplot(aes(x = factor(instar.duration, levels = c("pupate", "eclose")), y = days.to))

devB.a_plot + geom_boxplot(aes(fill = treatment)) +
  labs(title = "post-pupation development times", x = "stage", y = "days after previous stage") +
  scale_fill_manual(labels = B_labels, values = B_colors) + theme_bw()
```



