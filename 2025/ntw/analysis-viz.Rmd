---
title: "ntw 2025 data viz"
date: "2025-12-01"
---

# # preamble & loading

data viz for ntw 2025

```{r set pathfinding}
here::i_am("2025/ntw/analysis-viz.Rmd")
library(here)
```

```{r load libraries}
library(tidyverse)
library(patchwork) # for plot_layout
# library(survival) # for fitting surv
# library(survminer) # for plotting surv
```

```{r load data and helpers}
source(here::here("set-paths.R"))
source(here(bin_paths$y25$ntw, "utils.R"))

load(here(bin_paths$y25$ntwdata, "wrangled.RData"))
```

# # overall dev

## survival to pup
```{r}
dfs_dev_ss$surv_outcomes %>%
  FilterOutLabTB() %>%
  ggplot(aes(y = prop.pup,
             x = as.factor(trt),
             col = as.factor(year),
             group = year)) +
  geom_point() +
  geom_line(aes(lty = as.factor(year))) +
  geom_errorbar(aes(ymax = prop.pup + se.pup,
                    ymin = prop.pup - se.pup),
                width = 0.25) +
  # geom_text(aes(label = n),
  #           hjust = -0.2, vjust = -.2,
  #           show.legend = FALSE) +
  facet_wrap(~pop) +
  labs(y = "survived to pupation",
       x = "treatment",
       col = "year", lty = "year") +
  scale_x_discrete(labels = c("26-26", "40-19", "40-26", "40-33")) +
  #scale_color_brewer(palette = "Greens") +
  scale_color_brewer(palette = "Dark2") +
  theme_bw()
```
## pup development

```{r}
dfs_dev_ss$pup_dev_bysex %>%
  FilterOutLabTB() %>%
  filter(trt != 260) %>%
  mutate(trt = as.factor(trt),
         year = as.factor(year)) %>%
  ggplot(aes(y = avg.mass, x = trt,
             col = year,
             group = interaction(year)
             )) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymax = avg.mass + se.mass, ymin = avg.mass - se.mass),
                width = 0.3) + # remove if including ctrl
  geom_text(aes(label = n),
            vjust = -0.5, hjust = -0.5, size = 3.5,
            position = position_jitter(width = 0.2, height = 0.3, seed = 1),
            show.legend = FALSE) +
  facet_grid(pop~sex) +
  labs(y = "pupal mass (g)", 
       caption = "mean±se")


dfs_dev_ss$pup_dev%>%
  FilterOutLabTB() %>%
  #filter(trt != 260) %>%
  mutate(trt = as.factor(trt)) %>%
  ggplot(aes(y = avg.mass, x = trt,
             lty = pop, col = pop,
             group = pop,
             ))+
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymax = avg.mass + se.mass, ymin = avg.mass - se.mass),
                width = 0.3, lty = "solid") +
  geom_text(aes(label = n),
            vjust = -0.2, hjust = -0.3,
            show.legend = FALSE) +
  facet_grid(~year) # LMAO.. rip the lab response

```


## dev trajectories 

```{r}
# dev by year
.plotfun <- function(x){
  x %>%
  FilterOutLabTB() %>% 
  filter(instar %in% c("3rd", "4th", "5th", "wander")) %>% #View()
  ggplot(aes(y = avg.logmass,
             x = avg.tt,
             col = as.factor(year))) +
  geom_point() +
  geom_line() +
  # hard to see with these lol bc theyre pretty close
  # geom_errorbar(aes(ymax = avg.logmass + se.logmass,
  #                   ymin = avg.logmass - se.logmass,
  #                   width = CalcErrWd(avg.tt))) +
  # geom_errorbarh(aes(xmax = avg.tt + se.tt,
  #                    xmin = avg.tt - se.tt,
  #                    height = CalcErrHt(avg.logmass))) +
  facet_grid(pop ~ trt) +
  #scale_color_brewer(palette = "Greens") +
  scale_color_brewer(palette = "Dark2") +
  theme_bw()
}

dfs_dev_ss$dev_outcomes_nopmd %>%
  .plotfun() +
  labs(title = "development trajectories (pup'd only)",
       caption = "mean ± se",
       y = "log(mass mg)", x = "dev time (days)",
       col = "year",
       )


dfs_dev_ss$dev_outcomes_wpmd %>%
  .plotfun() +
  labs(title = "development trajectories (with pmd)",
       caption = "mean ± se",
       y = "log(mass mg)", x = "dev time (days)",
       col = "year",
       )
```

```{r}
# dev by trt
.plotfn <- function(x){
  x %>%
  FilterOutLabTB() %>% 
  filter(instar %in% c("3rd", "4th", "5th", "wander")) %>% 
  ggplot(aes(y = avg.logmass,
             x = avg.tt,
             col = as.factor(trt))) +
  geom_point() +
  geom_line() +
  # hard to see with these lol bc theyre pretty close
  # geom_errorbar(aes(ymax = avg.logmass + se.logmass,
  #                   ymin = avg.logmass - se.logmass,
  #                   width = CalcErrWd(avg.tt))) +
  # geom_errorbarh(aes(xmax = avg.tt + se.tt,
  #                    xmin = avg.tt - se.tt,
  #                    height = CalcErrHt(avg.logmass))) +
  facet_grid(pop ~ year) +
  #scale_color_brewer(palette = "Greens") +
  scale_color_manual(values = hcl.colors(6, "Viridis", rev = TRUE))
}

dfs_dev_ss$dev_outcomes_nopmd %>%
  .plotfn() +
  labs(title = "development trajectories (pups only)",
       caption = "mean ± se",
       y = "log(mass mg)", x = "dev time (days)",
       col = "treatment",
  )

dfs_dev_ss$dev_outcomes_wpmd %>%
  .plotfn() +
  labs(title = "development trajectories (all)",
       caption = "mean ± se",
       y = "log(mass mg)", x = "dev time (days)",
       col = "treatment",
       )
```

## supernumerary

```{r}
dfs_dev_ss$sup_outcomes %>% 
  FilterOutLabTB() %>%
  filter(status == "surv") %>%
  ggplot(aes(y = p,
             x = interaction(trt),
             fill = sup)) +
  geom_col() +
  geom_text(data = . %>% distinct(interaction(year, trt, pop), .keep_all = TRUE), 
            aes(label = N), y = 0.1) +
  facet_grid(pop~year) +
  labs(title = "# instars before pupation",
       y = "proportion survived", x = "trt",
       fill = "extra instars",
       caption = "N = total entered") +
  guides(x = guide_axis(angle = 45)) +
  scale_fill_brewer(palette = "Blues", direction = -1,
                    labels = c("0", "1", "2", "3", "died")) +
  scale_x_discrete(labels = c("26-26", "40-19", "40-26", "40-33")) +
  #scale_fill_discrete(labels = c("0", "1", "2", "3", "died")) +
  theme_bw()
```

# # tents

## btwn yrs 

```{r}
# both yrs
dfs_tents_ss$eggs_nocol %>%
  FilterForLabEggs() %>%
  mutate(mate.trt = as.factor(mate.trt),
         mate.type = factor(mate.type, 
                            levels = c("within", "between"))
         ) %>%
  ggplot(aes(y = p.eggs.hatched, x = n.eggs.coll,
             col = mate.trt, shape = mate.hs)) +
  geom_point() +
  geom_errorbar(aes(ymax = p.eggs.hatched + se.eggs.hatched,
                    ymin = p.eggs.hatched - se.eggs.hatched),
                width = 100) +
  # x err bar is too small to notice for 2025
  facet_wrap(mate.type ~ year) +
  #labs(x = "total eggs collected") +
  scale_color_brewer(palette = "Dark2")
```

```{r}
# sep years
.plotfn <- function(x){
  x %>%
    FilterForLabEggs() %>%
    mutate(mate.trt = as.factor(mate.trt),
           mate.type = factor(mate.type, 
                              levels = c("within", "between"))
    ) %>%
    ggplot(aes(y = p.eggs.hatched, x = n.eggs.coll,
               col = mate.trt, shape = mate.hs)) +
    geom_point(size = 2) +
    geom_errorbar(aes(ymax = p.eggs.hatched + se.eggs.hatched,
                      ymin = p.eggs.hatched - se.eggs.hatched),
                  width = CalcErrWd(x = dfs_tents_ss$eggs_nocol$n.eggs.coll, 
                                    pct = 0.05)) +
    # x err bar is too small to notice so omit
    geom_text(aes(label = n.f.total),
              hjust = 1.25, vjust = -1.3,
              show.legend = FALSE) + 
    scale_color_brewer(palette = "Dark2") +
    facet_wrap(~ mate.type)
}

dfs_tents_ss$eggs_nocol %>%
  filter(year == 2023) %>%
  .plotfn() +
  labs(caption = "2023") 

dfs_tents_ss$eggs_nocol %>%
  filter(year == 2025) %>%
  .plotfn() +
  labs(caption = "2025")
```

## effect of col bugs in 2025
```{r}
## testing effect of including the col or not for 2025
.plotfn <- function(x){
  x %>%
   FilterForLabEggs() %>%
  mutate(mate.trt = as.factor(mate.trt),
         mate.type = factor(mate.type, 
                            levels = c("within", "between"))
         ) %>%
    ### SPECIFIC FOR THESE PLOTS ###
    filter(mate.type == "within",
           #mate.trt == 260
           ) %>%
    ###############################
   ggplot(aes(y = p.eggs.hatched, x = n.eggs.coll,
             col = mate.trt, 
             shape = mate.col
             )) +
  geom_point(size = 2) +
    geom_text(aes(label = n.f.total),
            hjust = 1.25, vjust = -1.3, show.legend = FALSE) + 
  geom_errorbar(aes(ymax = p.eggs.hatched + se.eggs.hatched,
                    ymin = p.eggs.hatched - se.eggs.hatched),
                width = CalcErrWd(x = dfs_tents_ss$eggs_nocol$n.eggs.coll,
                                  pct = 0.025)
                ) +
  facet_wrap(~mate.type) +
    scale_color_brewer(palette = "Dark2") +
    #ylim(c(0, 0.58)) + #### to keep axes same for these plots
    labs(shape = "sex of col bug")
}

p1 <- 
  dfs_tents_ss$eggs_nocol %>%
  mutate(mate.col = "na") %>%
  filter(year == "2025") %>%
  .plotfn() +
  labs(caption = "mate.type and mate.pop = lab for col") +
  scale_shape_manual(values = 16) +
  guides(shape = FALSE)

p2 <- 
dfs_tents_ss$eggs_matecol %>%
  mutate(mate.col = replace_na(mate.col, "na")) %>%
  filter(year == "2025") %>%
  .plotfn() +
  labs(caption = "mate.type = col") +
  scale_shape_manual(values = c(17, 15, 16)) +
  guides(shape = FALSE)

p3 <- 
dfs_tents_ss$eggs_allcol %>%
  mutate(mate.col = replace_na(mate.col, "na")) %>%
  filter(year == "2025") %>%
  .plotfn() +
  labs(caption = "mate.type and mate.pop for\nlab/col are distinct") +
  scale_shape_manual(values = c(3, 17, 15, 16))

p1
p2
p3
```
```{r}
# patchworking...
(p1 + p2 + p3) +
  plot_layout(guides = "collect", axes = "collect",
              #ncol = 1, nrow = 3, widths = c(1:2)
              ) &
  #guides(col = guide_legend(nrow = 2, byrow = TRUE)) &
  ylim(c(0, 0.58)) &
  theme(legend.position = "top", #legend.box = "vertical",
        legend.margin = margin()) &
  
  plot_annotation(title = "effect of parsing col ctrls") 

```



