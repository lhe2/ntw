---
title: "2025 TDT data cleaning"
date: "2025-06-14"
---

# 0. roadmap

1. load data & packages; pre-filtering
2. column formatting + rearrangement
3. save output into `2025/data/`

re-run script whenever the gsheets gets updated


TODO

- [ ] check if `dh.<timept>` and `jdate` stuff are consistent/same as each other LOL...


# 1. load data & packages

```{r message = FALSE}
library(tidyr)
library(purrr)
library(dplyr)
library(lubridate) # for handling time stuff
library(googlesheets4)

here::i_am("2025/tdt/cleaning.Rmd")
library(here)

source(here::here("set-paths.R"))
```

googlesheets import

```{r}
# need to correct dates (add 2025)
raw <- read_sheet("https://docs.google.com/spreadsheets/d/1rxZSI-8ubhMkeM2Sh1xNi5IKF0Vt_BDFItAg_Ak476M/edit?gid=1826657546#gid=1826657546", 
                  sheet = "jun 2025 pilot",
                  col_types = "c",
                  na = c("#VALUE!")) %>%
  drop_na() %>%
  na_if("--") %>% na_if("")

data <- raw %>% 
  rename(trt = treatment) %>%
  mutate(trt.recover = case_when(trt.type == "ctrl" ~ NA_character_,
                                 TRUE ~ trt.recover)) %>%
  select(-c(trt.type, starts_with("dv"))) %>%
  mutate(across(starts_with("date."), ~ stringr::str_c("2025/", .))) # didnt add "2025" to dates so add here
```

# 2. content fixing and standardising

filtering

```{r}
# pull out accidentally culled before 3rd (fate = 2, instar.exit < 3)
data <- data %>%
  filter(!(fate == 2 & instar.exit < 3) | is.na(fate)) # retain is.na(fate) for things still developing

data[, 'notes'] <- lapply(data[, 'notes'], gsub, pattern=",", replacement = "&") 
  # replaces commas w/ &'s to avoid csv breakage after export
```

value fixing

```{r}
# match time data to hatch.time for some bugs bc otherwise things dont align nice:
  # R2 d2 pm expt bugs recover time (returned late)
  # R3 d2 26C bugs enter time (entered late)
data <- data %>%
  mutate(time.return = case_when(date.hatch == "2025/7/7" & trt > 200 & 
                                   !is.na(date.return) ~ as.character(time.hatch),
                                 TRUE ~ as.character(time.return))) %>%
  mutate(time.enter = case_when(date.hatch == "2025/7/25" & trt == 26 ~ "12:00",
                                TRUE ~ as.character(time.enter)))
```


column formatting & date-time fixing

```{r}
# basic column type conversions/standardising
data <- data %>%
    mutate(across(c(trt, trt.enter, trt.recover, trt.duration, id, instar.exit, fate,
                    starts_with("mass")), as.numeric))
    #mutate(across(starts_with("date."), as.Date, format = "%m/%d")) # breaks cuz no %Y
    #mutate(across(starts_with("time."), hm)) # breaks parsing bc converts to "HH MM SS"

# recalculate the actual decimal hrs bc gsheets does it differently from R
# (see dump script for testing)
data <- data %>%
  # date-time formatting
  mutate(dh.hatch = as_datetime(paste(date.hatch, time.hatch), format = "%Y/%m/%d %H:%M"),
         dh.enter = as_datetime(paste(date.enter, time.enter), format = "%Y/%m/%d %H:%M"),
         dh.recover = as_datetime(paste(date.recover, time.recover), format = "%Y/%m/%d %H:%M"),
         dh.return = as_datetime(paste(date.return, time.return), format = "%Y/%m/%d %H:%M"),
         dh.exit = case_when(
           !is.na(date.culled) ~ as_datetime(paste(date.culled, time.died), format = "%Y/%m/%d %H:%M"),
           !is.na(date.died) ~ as_datetime(paste(date.died, time.died), format = "%Y/%m/%d %H:%M")),
         ) %>% 
  # conversion of date-times (sec) to decimal days
  mutate(across(starts_with("dh."), ~ 
                  as.numeric(.)/(60*60*24)))

# TODO might need to keep "expt type" to separate out 40 ctrl from other "ctrls" ?
```


julian date conversions

```{r}
data <- data %>%
  mutate(across(starts_with("date."), as.Date, "%Y/%m/%d")) %>%
  mutate(across(starts_with("date."), as.Date, "%j", .names = "j{.col}")) %>%
  mutate(across(starts_with("jdate."), as.numeric)) %>%
  
  # consolidate died/culled cols into an "exit" col
  mutate(jdate.exit = case_when(!is.na(jdate.culled) ~ jdate.culled,
                                !is.na(jdate.died) ~ jdate.died)) %>%
  select(-c(jdate.died, jdate.culled))
```


# 3. saving output & tidying up

```{r}
# setup
today <- format(Sys.time(), "%y%m%d-%H%M")

#data <- mutate(data, across(starts_with("time."), as.character))
  # breaks write_csv if left as a `lubridate` object
```

```{r}
# export
write.csv(raw, file = paste0(here(bin_paths$y25$tdtdata), "/archive/", today, "_raw.csv"), row.names = FALSE)
write.csv(data, file = paste0(here(bin_paths$y25$tdtdata), "/archive/", today, "_clean-full.csv"), row.names = FALSE)

# extract the useful stuff
data <- data %>%
  select(c("cohort", "shelf", starts_with("trt"), "id", 
           starts_with(c("jdate", "mass", "dh")), "instar.exit", "fate", 
           "mass.return", "h.return"))

write.csv(data, file = paste0(here(bin_paths$y25$tdtdata), "/clean-working.csv"), row.names = FALSE)
```

remove troubleshooting objects

```{r}
rm(today, data, raw)
```
