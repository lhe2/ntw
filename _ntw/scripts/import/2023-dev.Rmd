---
title: "ntw_data_cleaning"
date: "2023-11-07"
---

about:
- imports and cleans ntw 2023 data (larval and tents) from googlesheets

notes:
- rerun this Rmd in entirety when the gsheets gets updated

# roadmap

1. load data & packages
2. cleaning: prefiltering, fix columns, add columns
3. save output

# loading
## - packages
```{r message = FALSE}
library(tidyverse)
library(googlesheets4)
#conflicts_prefer(dplyr::filter)

here::i_am("_ntw/scripts/import/2023-dev.Rmd")
library(here)
```

```{r}
# setup for export
today <- format(Sys.time(), "%y%m%d-%H%M")
```

## - gsheets data

note: 2024-07-02 updated gsheet with the field diapausers(?); should be the final update. as of now, has yet to be incorporated into cleaned data used for analyses (should look into "tossing" criteria before deleting this note)

```{r}
# before importing,
  # run cleaning macros (larva sheets)
  # check column/row alignment + proper sorting (adult sheets)

# larva data
dfs_raw <- list(
  field = read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet = "june field", col_types = "c") %>%
    mutate(src = "field"),
  
  labsu = read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet="june 2023 lab", col_types = "c") %>%
    mutate(src = "su"),
  
  labF1 = read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet="lab F1", col_types = "c") %>%
    mutate(src = "F1"),
  
  labsp = read_sheet("https://docs.google.com/spreadsheets/d/1dRgmeeCW1Ou5ayrtXnEL6NBKLB3Leo9ZHec7Y9AFhm0/edit#gid=188618561", sheet="consolidated + tidyed", col_types = "c") %>%
    mutate(src = "sp")
)
```


# consolidating

```{r}
# standardise some column formats and merge
df_all <- lapply(dfs_raw, \(x){
  x %>%
    mutate(across(starts_with("date."),  as.Date, format = "%m/%d/%y")) %>%
    mutate(mutate(across(starts_with("mass."), as.numeric)))
}) %>%
  data.table::rbindlist(fill = TRUE)
```

## - filtering & column renaming

remove bad individuals:
- individuals that didnt hatch at 26C/ctrl temps
- random deaths (squished/empty)
- bonus ctrl field bugs

```{r}
df_filtered <- df_all %>%
  filter(!(src == "sp" & (from.E == 2 | (from.E == 0 & (treatment %in% c(337, 330, 267))))),
         !(ID %in% c(1002, 1007, 1017)),
         treatment != "ctrl") %>%
  rename(trt = treatment,
         id = ID,
         date.LPI = date.LP)

# check: 
# df_filtered %>% filter(is.na(reason.ignore))
```

## - column/value formatting, other fixes


```{r}
# julian date formatting
df_cleaned <- df_filtered %>%
  mutate(across(starts_with("date."), as.Date, "%j", .names = "j{.col}")) %>%
  mutate(across(starts_with("jdate."), as.numeric))

# value standardising
df_cleaned$trt[df_cleaned$trt=="426"] <- "337" # match for consistency to the 2x2 expt; keep as char bc of "ctrl" trts
df_cleaned$instar.enter[df_cleaned$trt.stage == "1st"] <- "hatch" # change field 1sts to hatchlings
df_cleaned$final.fate[df_cleaned$final.fate == "LP"] <- "LPI"

# TODO: work this into scripts later
# add instar.enter levels
#df_cleaned$instar.enter <- factor(df_cleaned$instar.enter, levels = c("hatch", "1st", "3rd", "4th"))

# add in late dead pupa
df_cleaned <- df_cleaned %>%
  mutate(final.fate = case_when(!is.na(date.exit) & is.na(final.fate) ~ "pupa",
                                TRUE ~ as.character(final.fate)))
```

# column creation
## - development binaries
```{r}
# survival/development binaries
df_cleaned <- df_cleaned %>% mutate(
  if.stuck = case_when(is.na(date.stuck) ~ "N", 
                       TRUE ~ "Y"),
  if.pupa = case_when(is.na(date.LPI) & is.na(date.pupa) ~ "N", 
                      TRUE ~ "Y"),
  if.sup = case_when(is.na(date.6th) ~ "N", 
                     TRUE ~ "Y"),
  # type of sup
  sup = case_when(!is.na(date.7th) ~ 7, 
                  !is.na(date.6th) ~ 6, 
                  !is.na(date.pupa) | !is.na(date.LPI) ~ 0) # TODO: check... (used to be "TRUE ~ 0")
  )

# subdivide treatments
df_cleaned <- df_cleaned %>%
  mutate(trt = as.numeric(trt),
         trt.stage = as.character(paste(trt,instar.enter, sep = "-")), # treatment @ instar
         grp.trt = paste(expt.group, trt.stage, sep = "-")) # cohort & treatment

# mean/fluc Ts; correction for diurnal trts
df_cleaned <- df_cleaned %>%
  mutate(meanT = case_when(trt %in% c(260, 267) ~ 26,
                           trt %in% c(337, 330) ~ 33,
                           trt == 433 ~ 36.5,
                           trt == 419 ~ 29.5),
         flucT = case_when(trt %in% c(260, 330) ~ 0,
                           trt %in% c(267, 337) ~ 7,
                           trt == 433 ~ 3.5,
                           trt == 419 ~ 10.5),
         maxT = case_when(trt == 260 ~ 26,
                          trt %in% c(267, 337) ~ 33,
                          trt > 331 ~ 40),
         minT = case_when(trt == 260 ~ 26,
                          trt %in% c(267, 419) ~ 19,
                          trt == 337 ~ 26,
                          trt%in% c(433, 330) ~ 33)) %>%
  mutate(flucT = case_when(trt == 260 & 
                              expt.group %in% LETTERS[3:8] ~ 2.5,
                           TRUE ~ as.numeric(flucT)))
```

## - column creation for notes
```{r}
# indicate field/lab pops, diet, parents
df_cleaned <- df_cleaned %>%
  mutate(pop = case_when(location == "CC" ~ "field",
                         src == "F1" ~ "F1",
                         TRUE ~ "lab"),
         diet = case_when((expt.group == "F" | pop == "field") ~ "TB",
                          TRUE ~ "LD"),
         parent.tent = case_when(src == "F1" ~ as.character(parent.tent),
                                 TRUE ~ "parent"))

# fill in reason.ignore (optional reasons to ignore individs later when graphing/stats/etc)
  # indicate overly long-lived individuals: things that took > 25 days to die
df_cleaned <- df_cleaned %>% 
  mutate(reason.ignore = case_when(jdate.pmd-jdate.hatch > 25 ~ "slow larva",
                                   #jdate.eclose - jdate.pupa > 25 ~ "diapaused?",
                                   src == "F1" & id < 3036 ~ "early F1",
                                   expt.group == "E" & trt == 337 & id < 247 ~ "early field",
                                   #final.fate == "culled" & instar.culled == "pupa" ~ "winter culling",
                                   final.fate == "culled" & instar.culled != "pupa" ~ "culled larva",
                                   reason.pmd == "toast" ~ "hot larva",
                                   TRUE ~ as.character(reason.ignore)))

# check: 
# table(df_cleaned$reason.ignore)
```

# 3. save the output

```{r}
today <- format(Sys.time(), "%y%m%d")

# raw data
write.csv(df_all, file = paste0(here("_ntw/data/raw/2023/"), "raw_", today, ".csv"), row.names = FALSE) 

# MQs only
export <- df_cleaned %>% 
  filter(species == "MQ") %>%
  select(-c("species", "from.E", "location", starts_with(c("date", "h.")), "time.in.approx", "dv", "pupa.deformities", "mass.died", "toss.if", "old.date.pmd", "reason.pmd", "fate.code", "notes", "mass.stuck", ends_with(".culled"), "eclose-3"))

write.csv(export, file = here("_ntw/data/clean/2023/MQs.csv"), row.names = FALSE)
write.csv(export, file = paste0(here("_ntw/data/archive/2023/"), "MQs_", today, ".csv" ), row.names = FALSE)


# wordier notes
# export <- df_cleaned %>% select(c("trt", "id", "expt.group", "location", "date.collected", "date.stuck", "time.in.approx", "dv", "mass.died", "pupa.deformities", "notes", "reason.pmd", "reason.ignore", ends_with(".stuck"), ends_with(".culled")))
# 
# write.csv(export, file = here("_ntw/data/clean/2023-ntw-notes.csv"), row.names = FALSE)
# write.csv(export, file = paste0(here("_ntw/data/archive/2023/"), "ntw-notes_", today, ".csv" ), row.names = FALSE)
  
# cleaned up sexta
export <- df_cleaned %>%
  filter(is.na(species)) %>% 
  select(-c("species", "from.E", "location", starts_with(c("date", "h.")), "time.in.approx", "dv", "pupa.deformities", "mass.died", "toss.if", "old.date.pmd", "reason.pmd", "fate.code", "notes", "mass.stuck", ends_with(".culled"), "eclose-3"))

write.csv(export, file = here("_ntw/data/clean/2023/sexta.csv"), row.names = FALSE)
write.csv(export, file = paste0(here("_ntw/data/archive/2023/"), "sexta_", today, ".csv" ), row.names = FALSE)
```

## - cleanup

```{r}
rm(dfs_raw, df_all,
   df_cleaned, df_filtered, 
   today, export)
```
