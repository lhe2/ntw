---
title: "ntw 2025 data viz"
date: "2025-12-01"
---

# # preamble & loading

data viz for ntw 2025

```{r set pathfinding}
here::i_am("_ntw/scripts/analysis/viz-tents.Rmd")
library(here)
```

```{r load libraries and utils}
library(tidyverse)
library(patchwork) # for plot_layout
# library(survival) # for fitting surv
# library(survminer) # for plotting surv

source(here("_ntw/scripts/utils/analysis.R"))
source(here("_ntw/scripts/utils/analysis-viz.R"))
```

```{r load data, message = FALSE, warning=FALSE}
source(here("_ntw/scripts/R/wrangle-tents.R"))

# convert things into factors for ease of graphing
dfs_tents_ss <- dfs_tents_ss %>%
    lapply(., \(x){
    x %>%
      ungroup() %>%
      mutate(across(c("year", "mate.trt", starts_with("trt")), as.factor),
             mate.type = factor(mate.type, 
                                levels = c("within", "between")))
  })

```

# # tents

## hatch+laid btwn yrs 

```{r}
# both yrs
dfs_tents_ss$eggs_nocol %>%
  FilterForLabEggs() %>%
  ggplot(aes(y = p.hatch, x = n.total.coll, 
             col = mate.trt, shape = mate.hs)) +
  geom_point() +
  geom_errorbar(aes(ymax = p.hatch + se.hatch,
                    ymin = p.hatch - se.hatch),
                width = 100) +
  # x err bar is too small to notice for 2025
  facet_wrap(mate.type ~ year) +
  #labs(x = "total eggs collected") +
  scale_color_brewer(palette = "Dark2")
```

```{r}
# sep years
.plotfn <- function(x){
  x %>%
    FilterForLabEggs() %>%
    ggplot(aes(y = p.hatch, x = n.total.coll,
               col = mate.trt, shape = mate.hs)) +
    geom_point(size = 2) +
    geom_errorbar(aes(ymax = p.hatch + se.hatch,
                      ymin = p.hatch - se.hatch),
                  width = CalcErrWd(x = dfs_tents_ss$eggs_nocol$n.total.coll, 
                                    pct = 0.05)) +
    # x err bar is too small to notice so omit
    geom_text(aes(label = n.f.total),
              hjust = 1.25, vjust = -1.3,
              show.legend = FALSE) + 
    scale_color_brewer(palette = "Dark2") +
    facet_wrap(~ mate.type)
}

dfs_tents_ss$eggs_nocol %>%
  filter(year == 2023) %>%
  .plotfn() +
  labs(caption = "2023") 

dfs_tents_ss$eggs_nocol %>%
  filter(year == 2025) %>%
  .plotfn() +
  labs(caption = "2025")
```

## hatch+laid effect of col bugs in 2025
```{r}
## testing effect of including the col or not for 2025
.plotfn <- function(x){
  x %>%
   FilterForLabEggs() %>%
    ### SPECIFIC FOR THESE PLOTS ###
    filter(mate.type == "within",
           #mate.trt == 260
           ) %>%
    ###############################
   ggplot(aes(y = p.hatch, x = n.total.coll,
             col = mate.trt, 
             shape = mate.col
             )) +
  geom_point(size = 2) +
    geom_text(aes(label = n.f.total),
            hjust = 1.25, vjust = -1.3, show.legend = FALSE) + 
  geom_errorbar(aes(ymax = p.hatch + se.hatch,
                    ymin = p.hatch - se.hatch),
                width = CalcErrWd(x = dfs_tents_ss$eggs_nocol$n.total.coll,
                                  pct = 0.025)
                ) +
  facet_wrap(~mate.type) +
    scale_color_brewer(palette = "Dark2") +
    #ylim(c(0, 0.58)) + #### to keep axes same for these plots
    labs(shape = "sex of col bug")
}

p1 <- 
  dfs_tents_ss$eggs_nocol %>%
  mutate(mate.col = "na") %>%
  filter(year == "2025") %>%
  .plotfn() +
  labs(caption = "mate.type and mate.pop = lab for col") +
  scale_shape_manual(values = 16) +
  guides(shape = "none")

p2 <- 
dfs_tents_ss$eggs_matecol %>%
  mutate(mate.col = replace_na(mate.col, "na")) %>%
  filter(year == "2025") %>%
  .plotfn() +
  labs(caption = "mate.type = col") +
  scale_shape_manual(values = c(17, 15, 16)) +
  guides(shape = "none")

p3 <- 
dfs_tents_ss$eggs_allcol %>%
  mutate(mate.col = replace_na(mate.col, "na")) %>%
  filter(year == "2025") %>%
  .plotfn() +
  labs(caption = "mate.type and mate.pop for\nlab/col are distinct") +
  scale_shape_manual(values = c(3, 17, 15, 16))

p1
p2
p3
```
```{r}
# patchworking...
(p1 + p2 + p3) +
  plot_layout(guides = "collect", axes = "collect",
              #ncol = 1, nrow = 3, widths = c(1:2)
              ) &
  #guides(col = guide_legend(nrow = 2, byrow = TRUE)) &
  ylim(c(0, 0.58)) &
  theme(legend.position = "top", #legend.box = "vertical",
        legend.margin = margin()) &
  
  plot_annotation(title = "effect of parsing col ctrls") 

```

## eggs laid

```{r}
.plotfn <- function(x){
  x %>%
  FilterForLabEggs() %>% 
  ggplot(aes(#y = avg.coll.perf, 
             y = avg.sqrt.coll.perf,
             x = mate.trt,
             lty = mate.hs, shape = mate.hs,
             group = mate.hs,
             col = mate.hs
             # shape = mate.hs, lty = mate.type,
             # group = interaction(mate.hs, mate.type)
  )) + 
  # very overwhelming w error bars lol
  # geom_errorbar(aes(ymax = avg.coll.perf + se.coll.perf,
  #                   ymin = avg.coll.perf - se.coll.perf,),
  #               lty = "solid", width = 0.5) +
  # geom_errorbar(aes(ymax = avg.sqrt.coll.perf + se.sqrt.coll.perf,
  #                   ymin = avg.sqrt.coll.perf - se.sqrt.coll.perf),
  #               lty = "solid", width = 0.5) +
  # geom_text(aes(label = n.f.total),
  #           vjust = -0.5, hjust = -0.5, position = "jitter") +
  # geom_text(aes(label = paste0(n.cages.total, "C, ", n.f.total, "F")),
  #           vjust = -0.5, hjust = -0.5, 
  #           #position = "jitter"
  #           ) +
  geom_point(size=2) + geom_line() +
  facet_grid(~year) +
  theme_bw() +
  #scale_shape_manual(values = c(2, 0, 16)) +
  scale_color_brewer(palette = "Dark2") +
  #scale_linetype_manual(values = c(3, 2, 1)) +
  labs(col = "treated sex", lty = "treated sex", shape = "treated sex",
       caption = "meanÂ±se; lab only",
       y = "sqrt [eggs laid per female]", x = "treatment")
}

# connect "btwn" trts to 26-26
.plotfn2 <- function(x){
    list(
      geom_line(data = x %>%
                  #FilterForLabEggs(dfs_tents_ss$eggs_nocol) %>%
                  filter(trt.f %in% c(260, 419), mate.hs %in% c("both", "f"),
                         trt.m != 419) %>%
                  select(-mate.trt) %>%
                  rename(mate.trt = trt.f) %>% mutate(mate.hs = "f") #%>% View()
                #, color = "black"
                , aes(group = mate.hs), show.legend = FALSE,
                ),
        geom_line(data = x %>%
                    #FilterForLabEggs(dfs_tents_ss$eggs_nocol) %>%
                    filter(trt.m %in% c(260, 419), mate.hs %in% c("both", "m"),
                           trt.f != 419) %>%
                    select(-mate.trt) %>%
                    rename(mate.trt = trt.m) %>% mutate(mate.hs = "m") #%>% View()
                  ,
                  #aes(group = mate.trt), 
                  show.legend = FALSE)
      )
}

dfs_tents_ss$eggs_nocol %>%
  .plotfn() +
  .plotfn2(FilterForLabEggs(dfs_tents_ss$eggs_nocol)) +
  scale_x_discrete(labels = c("26-26", "40-19", "40-26", "40-33"))

dfs_tents_ss$eggs_nocol %>%
  filter(mate.trt != 260) %>%
  .plotfn() +
  scale_x_discrete(labels = c("40-19", "40-26", "40-33"))
  
```
## eggs hatched

```{r}
.plotfn <- function(x){
  x %>%
  FilterForLabEggs() %>% 
  ggplot(aes(y = p.hatch,
             x = mate.trt,
             lty = mate.hs, shape = mate.hs,
             group = interaction(mate.hs),
             col = mate.hs
  )) + 
  geom_errorbar(aes(ymax = p.hatch + se.hatch,
                    ymin = p.hatch - se.hatch,),
                lty = "solid", width = 0.25) +
      # geom_text(aes(label = paste0(n.cages.total, "C,", n.f.total, "F")),
      #       vjust = -0.5, hjust = -0.5, size = 3
      #       #position = "jitter"
      #       ) +
  geom_point(size=2) + geom_line() +
  facet_grid(~year) +
  theme_bw() +
  #scale_shape_manual(values = c(2, 0, 16)) +
  scale_color_brewer(palette = "Dark2") +
  #scale_linetype_manual(values = c(3, 2, 1)) +
  labs(col = "treated sex", lty = "treated sex", shape = "treated sex",
       caption = "bars = se; lab only",
       y = "proportion eggs hatched", x = "treatment")
}

dfs_tents_ss$eggs_nocol %>%
  .plotfn() +
  .plotfn2(FilterForLabEggs(dfs_tents_ss$eggs_nocol)) +
  scale_x_discrete(labels = c("26-26", "40-19", "40-26", "40-33"))

dfs_tents_ss$eggs_nocol %>%
  filter(mate.trt != 260) %>%
  .plotfn() +
  scale_x_discrete(labels = c("40-19", "40-26", "40-33"))
```


