---
title: "fertility analyses"
date: "2024-02-15"
---

purpose: looking at fertility stats

*roadmap:*
0. load data, pckgs
1. ...

*questions:*
- fertility
  - overall hatch rates per trt/tent? factors contributing to hatch rates?
  - which trts lead to hatching?
  - controls: how do expt compare to controls?
  - daily avg hatch rate
  - running avg of egg production
  - time btwn coll vs hatching?
  - sex diffs?

- longevity
  - time to ec? what are contributing factors?
  - survival post ec? what factors? (affected by time in 4C?)

# (**) 0. load data, helper fns
```{r message=FALSE}
source("./helpers_tents.R")
# map(other_helpers, ~discard(., .p = ~all))
  # working on it: https://stackoverflow.com/questions/63533428/in-r-remove-list-of-list-based-on-name

# etc
library(ggfortify) # qqplots
```
# 1. analyses hodgepodge

## A. (**) overall hatch rates

```{r calc stats & add other filter criteria}
summ_hatch <- data_tstats %>%
  group_by(#id.tent,
           trt.f, trt.m, pop,
           #trt.win, trt.btwn, 
           trt.type,
           trt.pair
           ) %>%
  summarise(n.tents = n_distinct(id.tent),
            n.collected = sum(n.coll, na.rm = TRUE),
            se.coll =  sd(na.omit(n.coll))/sqrt(length(na.omit(n.coll))),
            n.hatched = sum(n.tothatch, na.rm = TRUE),
            se.hatched = sd(na.omit(n.tothatch))/sqrt(length(na.omit(n.tothatch))),
            n.females = sum(n.new.f, na.rm = TRUE),
            #start = first(jdate), end = last(jdate),
            t.duration = max(jdate) - min(jdate),
            rate.hatch = n.hatched/n.collected,
            se.hatch = sqrt(rate.hatch*(1-rate.hatch)/n.collected),  # check ???
            rate.hatchperf = rate.hatch/n.females,
            se.hatch = sqrt(rate.hatchperf*(1-rate.hatchperf/n.collected)),
            rate.f = round(n.collected/n.females, digits = 1)
            ) %>%
  drop_na(trt.m) %>% # drop tents w/o males
  mutate(trt.win = case_when(trt.f == trt.m & trt.f == 260 ~ "26-26",
                             trt.f == trt.m & trt.f == 419 ~ "40-19",
                             trt.f == trt.m & trt.f == 426 ~ "40-26",
                             trt.f == trt.m & trt.f == 433 ~ "40-33"),
         trt.btwn = case_when(trt.type == "ctrl" ~ "26-26", 
                              (trt.type == "hs F" | trt.type == "hs M") & (trt.f == 419 | trt.m == 419) ~ "40-19",
                              (trt.type == "hs F" | trt.type == "hs M") & (trt.f == 426 | trt.m == 426) ~ "40-26",
                              (trt.type == "hs F" | trt.type == "hs M") & (trt.f == 433 | trt.m == 433) ~ "40-33"),
         # min.f = case_when(trt.f == 260 | trt.f == 426 ~ 26,
         #                   trt.f == 419 ~ 19,
         #                   trt.f == 433 ~ 33), 
         # min.m = case_when(trt.m == 260 | trt.m == 426 ~ 26,
         #                   trt.m == 419 ~ 19,
         #                   trt.m == 433 ~ 33),
         trt.parent = case_when(trt.f == 260 & trt.m == 260 ~ 260,
                                trt.f == 419 | trt.m == 419 ~ 419,
                                trt.f == 426 | trt.m == 426 ~ 426,
                                trt.f == 433 | trt.m == 433 ~ 433),
         # trt.combo = paste0(trt.f, "-", trt.m),
         # min.combo = paste0(min.f, "-", min.m)
         )

# idk if im doing se of a proportion correctly (per meggan's graphs)
  # https://stats.stackexchange.com/questions/266442/standard-error-for-proportion-with-small-sample-size

```

### - plots

```{r}
# todo: 
# - better temp trt labeling & legend labeling (make consistent)
# - get rid of x error bar stubs


#RYB <- c("#324DA0", "#acd2bb", "#f1c363", "#a51122")

summ_hatch %>%
  filter(#pop == "lab" &
           !is.na(trt.win)) %>%
  ggplot(aes(y = rate.hatch, x = n.collected, #color = trt.combo,
             color = trt.win,
             fill = trt.pair, shape = pop)) +
  geom_point(size = 2.5) +
  y_err_hrate(err = 50) + 
  #x_err_ncoll(0.005) + # not worth including lol
  theme_bw() +
  scale_color_manual(
                     values = RYB) +
  # scale_shape_manual(values = c(21, 23)) +
  #scale_shape_manual(values = c(1, 16)) + # revisit this lol i give up
  scale_shape_manual(values = c(16, 18)) + 
  # scale_fill_manual(values = c("white", "black"),
  #                   labels = c("ct F + ct M" = "control (26C day)",
  #                              "hs F + hs M" = "exptl (40C day)")) +
  labs(title = "hatch rates: within treatment",
       y = "hatch proportion",
       x = "total eggs laid",
       #color = "parent min temp",
       color = "temp trt",
       shape = "population",
       #fill = "parent trt"
       ) +
  guides(fill = "none") +
  ylim(c(0,0.20))
  
summ_hatch %>%
  filter(#pop == "lab" & (trt.pair == "ct F + hs M" | trt.pair == "hs F + ct M")
         !is.na(trt.btwn) & pop == "lab") %>%
  ggplot(aes(y = rate.hatch, x = n.collected, #color = as.factor(trt.parent), 
             color = trt.btwn,
             shape = trt.type
             #shape = trt.pair
             )) +
  geom_point(size = 2) +
  y_err_hrate(err = 50) + 
  theme_bw() +
  scale_color_manual(values = RYB,
  #                    # values = c("#acd2bb", "#f1c363", "#a51122"),
  #                    # labels = c("419" = "19",
  #                    #            "426" = "26",
  #                    #            "433" = "33")
                     ) +
  # scale_shape_manual(values = c(15, 17),
  #                    labels = c("ct F + hs M" = "exptl M", 
  #                               "hs F + ct M" = "exptl F")) +
  scale_shape_discrete(labels = c("ctrl female/ctrl male",
                                "HS female/ctrl male",
                                "ctrl female/HS male")) +
  labs(title = "hatch rates: btwn treatments",
       y = "hatch proportion",
       x = "total eggs laid",
       #color = "parental min temp (C)",
       color = "temp trt",
       shape = "parent trt",
       caption = "lab only") +
  ylim(c(0,0.20))  

# summ_hatch %>%
#   filter(pop == "field") %>%
#   ggplot(aes(y = rate.hatch, x = n.collected, color = trt.combo, shape = trt.pair)) +
#   geom_point(size = 2) +
#   theme_bw() +
#   scale_color_manual(labels = c("260-260" = "26 (26C day)",
#                                 "419-419" = "19",
#                                 "426-426" = "26 (40C day)",
#                                 "433-433" = "33"), 
#                      values = RYB) +
#   scale_shape_manual(values = c(1, 16),
#                      labels = c("ct F + ct M" = "control (26C day)", 
#                                 "hs F + hs M" = "exptl (40C day)")) +
#   labs(title = "field: within trt hatch rates",
#        y = "hatch proportion",
#        x = "total eggs",
#        color = "parent min temp (C)",
#        shape = "trt conditions") +
#   ylim(c(0,0.25))

summ_hatch %>%
  filter(rate.hatch > 0) %>%
  ggplot(aes(y = rate.hatch, x = n.collected, color = as.factor(trt.parent), shape = trt.pair)) +
  geom_point(size = 2) +
  y_err_hrate(err = 50) + 
  theme_bw() +
  scale_color_manual(values = c("#324DA0", "#acd2bb", "#a51122"),
                     labels = c("260" = "26-26",
                                "419" = "40-19",
                                "433" = "40-33")
                     ) +
  scale_shape_manual(values = c(1, 17, 16), # todo: make consistent w the other one
                       # labels = c("ct F + ct M" = "ctrl (26Â°C day)",
                       #            "hs F + ct M" = "exptl F", 
                       #            "hs F + hs M" = "exptl (40Â°C day)")
                     ) +
  labs(title = "hatch rates: trts with hatchlings only",
       y = "hatch proportion",
       x = "total eggs laid",
       #color = "parental min temp (C)",
       color = "temp trt",
       shape = "parent trt",
       caption = "lab only") +
  ylim(c(0,0.20))  
```

### (**) - modeling: hatch rates

```{r calc stats}
summ_hatchall <- data_tstats %>%
  replace(is.na(.), 0) %>%
  group_by(id.tent) %>%
  mutate(jdate.rel = jdate - first(jdate)) %>%
  group_by(jdate.rel) %>%
  mutate(n.tothatch.pertent = sum(n.tothatch),
         n.coll.pertent = sum(n.coll)) %>%
  ungroup() %>%
  group_by(trt.f, trt.m, pop) %>%
  mutate(n.tothatch.overall = sum(n.tothatch),
         n.coll.overall = sum(n.coll),
         #n.duration.overall = jdate-first(jdate),
         # below borrowed from LB hatching stuff
         n.collected = sum(n.coll),
         n.hatched = sum(n.tothatch),
         n.females = sum(n.new.f),
         prop.hatch = n.hatched/n.collected,
         rate.collf = n.collected/n.females,
         lt.hprop = log(prop.hatch + 1)) 
  
summ_hatchmod <- summ_hatchall %>%
  filter(n.tothatch.overall > 0)
  
```

trying a bunch!

```{r}
mod.hatch <- glm(n.tothatch.overall ~ 
                   as.factor(trt.f) + as.factor(trt.m) + #pop +
                   n.coll.pertent,
                 data = summ_hatchmod,
                 family = poisson)
  # Warning: glm.fit: fitted rates numerically 0 occurred

# unfiltered:
summary(mod.hatch) # (***) for trt.f = 419, 433; (*) for n.coll.pertent. AIC = 12347
anova(mod.hatch) # nothing matters zzzzzz

# filtered:
summary(mod.hatch) # (***) for all trts. AIC = 1055.7
anova(mod.hatch) # nothing matters!
```
try dropping `n.coll` from the model

```{r}
mod.hatch2 <- glm(n.tothatch.overall ~ 
                   as.factor(trt.f) + as.factor(trt.m) 
                  #+ pop
                  ,
                 data = summ_hatchmod,
                 family = poisson)
  # Warning: glm.fit: fitted rates numerically 0 occurred

# unfiltered:
summary(mod.hatch2) # AIC = 12350 (very slightly worse...)
anova(mod.hatch2) # nothing matters still ðŸ‘

# filtered:
summary(mod.hatch2) # AIC = 1053.7 (slightly better model)
anova(mod.hatch2) # nothin matters!!!
```

look at random effects: 

```{r}
mod.hatch3 <- lme4::lmer(n.tothatch.overall ~ 
                           as.factor(trt.f) + as.factor(trt.m) + #pop +
                           #n.coll.pertent + 
                           (1|id.tent),
                         data = summ_hatchmod,
                         #family = poisson
                         )
  # doesnt work w/ unfiltered data: 
    # "Error in eval_f(x, ...) : Downdated VtV is not positive definite"
  # w/ filtered: model fails to converge

summary(mod.hatch3) # res = 1e-27, # obs = 166, # id.tent grps = 11
anova(mod.hatch3) # nothin matters!!!
```


## B. daily laying rate

### - (**) calcs
```{r calculate}
# calculate # of currently ovipositing females
summ_rate <- data_tstats %>%
  mutate_at(c(6:13), ~replace_na(., 0)) %>% #
  group_by(id.tent) %>%
  mutate(jdate.rel = jdate - first(jdate)) %>%
  ungroup() %>%
  group_by(id.tent, trt.f, trt.m, pop, trt.type, jdate.rel) %>%
  arrange(jdate.rel, .by_group = TRUE) %>%
  mutate(#n.laying = n.curr.f + n.died.f, .after = "n.curr.f",
         n.ovi = dplyr::lag(n.curr.f, default = first(n.curr.f)) + n.died.f, .after = "n.curr.f") %>%
  ungroup()

# where n.ovipositing females = 0 but n.collected > 0, add the # collected to the day before
# first, figure out the rows
cond <- (summ_rate$n.coll > 0 & summ_rate$n.ovi == 0)
summ_rate %>%
  mutate(index = as.numeric(rownames(.)), .before = 1) %>%
  subset(cond | lead(cond) | lead(cond, n=2)) # %>%
  #View()
rm(cond)

# edit values
summ_rate$n.coll[c(55, 66, 73, 115, 152, 210)] <- 1
summ_rate$n.coll[c(56, 67, 75, 116, 153, 211)] <- 0

## todo: cut out the lags (when there's no F)

# calculate daily hatch rate per tent and per trt  -- see followup

   # (moved to respective sections)
  # how to include se for rate? -- see meggan?

# additional modifications to make the math(?) right:
# remove 0's
summ_rate_zeros <- summ_rate
summ_rate <- summ_rate %>%
  filter(!(n.coll == 0 & n.ovi == 0))

# TODO: keep a version where we dont use this LOL for checking residuals

```


 - plot per tent

```{r}
summ_rate_pertent <- summ_rate %>%
  group_by(id.tent, trt.f, trt.m, pop, trt.type, jdate.rel) %>%
  summarise(n.tents = n(),
            rate.pertent = n.coll/n.ovi/n.tents,
            n.ovi.pertent = sum(n.ovi)) %>%
  replace(is.na(.), 0) %>%
  mutate(trt.btwn = case_when(trt.type == "ctrl" ~ "26-26", 
                              (trt.type == "hs F" | trt.type == "hs M") & (trt.f == 419 | trt.m == 419) ~ "40-19",
                              (trt.type == "hs F" | trt.type == "hs M") & (trt.f == 426 | trt.m == 426) ~ "40-26",
                              (trt.type == "hs F" | trt.type == "hs M") & (trt.f == 433 | trt.m == 433) ~ "40-33"),
    # trt.btwn = case_when(trt.f == trt.m & trt.f == 260 ~ 26-26,
    #                           trt.f == trt.m & trt.f == 419 ~ 40-19,
    #                           trt.f == trt.m & trt.f == 426 ~ 40-26,
    #                           trt.f == trt.m & trt.f == 433 ~ 40-33,
    #                           trt.f < trt.m ~ as.numeric(trt.m),
    #                           trt.f > trt.m ~ as.numeric(trt.f))
    ) #%>%
  #drop_na()


summ_rate_pertent %>%
  filter((trt.type == "within" | trt.type == "ctrl")
         & pop == "lab"
         ) %>% 
  ggplot(aes(#lty = pop,
             x = jdate.rel, # custom cutoffs per trt?
             group = id.tent,
             color = as.factor(trt.f)
             )) +
  geom_point(aes(y = rate.pertent)) +
  geom_line(aes(y = rate.pertent)) +
  facet_wrap(#pop 
             ~ trt.f,
             ncol = 4, nrow = 2) + # custom scales for field?
  theme_bw() +
  labs(title = "within trt per tent egg laying rate",
       y = "# eggs laid/female",
       x = "days since tent setup",
       color = "treatment") +
  scale_color_manual(values = RYB,
                      labels = labels.alltrts)


summ_rate_pertent %>%
  filter(#trt.type == "ctrl" | 
           trt.type == "hs M" | trt.type == "hs F") %>% 
  ggplot(aes(#lty = pop,
             x = jdate.rel, # custom cutoffs per trt?
             group = id.tent,
             color = as.factor(trt.btwn)
             )) +
  geom_point(aes(y = rate.pertent)) +
  geom_line(aes(y = rate.pertent)) +
  facet_wrap(trt.type ~ trt.btwn,
             ncol = 3, nrow = 2
             ) + # custom scales for field?
  theme_bw() +
  labs(title = "btwn trt per tent egg laying rate",
       y = "# eggs laid/female",
       x = "days since tent setup",
       color = "treatment") +
  scale_color_manual(values =  c("#acd2bb", "#f1c363", "#a51122"),
                      labels = labels.exptrts)


```



 - plot trt overall
```{r plotting trt overall}
# summ_rate %>%
#   group_by(trt.f, trt.m, pop, jdate.rel) %>%
#   summarise(rate.overall = n.coll/n.ovi)

summ_rate_overall <- summ_rate_pertent %>%
  group_by(trt.f, trt.m, pop, trt.type, jdate.rel) %>%
  arrange(jdate.rel, .by_group = TRUE) %>%
  summarise(rate.overall = mean(rate.pertent),
            n.tents = n(),
            n.ovi.overall = sum(n.ovi.pertent)) %>%
    replace(is.na(.), 0) %>%
  mutate(trt.pair = paste0(trt.f, "-", trt.m),
         label.facet = case_when(trt.f == 260 ~ "26-26",
                                 trt.f == 419 ~ "40-19",
                                 trt.f == 426 ~ "40-26",
                                 trt.f == 433 ~ "40-33"),
         trt.btwn = case_when(trt.f == trt.m & trt.f == 260 ~ 26-26,
                              trt.f == trt.m & trt.f == 419 ~ 40-19,
                              trt.f == trt.m & trt.f == 426 ~ 40-26,
                              trt.f == trt.m & trt.f == 433 ~ 40-33,
                              trt.f < trt.m ~ as.numeric(trt.m),
                              trt.f > trt.m ~ as.numeric(trt.f))
         #pop = factor(pop, levels = c("lab", "field"))
         )

# notes
  # need some more built in labels for the trt types... idk where to put that in tho
  # custom scale labels per layer: https://stackoverflow.com/questions/18394391/custom-legend-for-multiple-layer-ggplot
  
summ_rate_overall %>%
  filter(trt.type == "within" | trt.type == "ctrl") %>%
  ggplot(aes(x = jdate.rel, 
             lty = pop, 
             color = as.factor(trt.f) # want this to be RYB tho
             )) +
  facet_wrap(~ label.facet,
             nrow = 1) +
  geom_point(aes(y = rate.overall)) + 
  geom_line(aes(y = rate.overall)) +
  geom_line(aes(y = n.ovi.overall), color = "black", alpha = 0.55) +
  scale_linetype_manual(values = c("lab" = "solid", "field" = "dashed"),
                        #values = c("solid", "dashed")
                        ) +
  # scale_color_identity(name = "# females", guide = "legend") +
  theme_bw() +
  labs(title = "within treatment daily egg laying rate",
       y = "# eggs laid/female",
       x = "days since tent start"
       #color = 
         )

  
summ_rate_overall %>%
  filter(trt.type == "hs F" | trt.type == "hs M") %>%
  ggplot(aes(x = jdate.rel, 
             color = as.factor(trt.btwn) # want this to be RYB tho
             )) +
  facet_wrap(trt.type ~ trt.pair,
             nrow = 2, ncol = 3) +
  geom_point(aes(y = rate.overall)) + 
  geom_line(aes(y = rate.overall)) +
  geom_line(aes(y = n.ovi.overall), color = "black", alpha = 0.55) +
  scale_linetype_manual(values = c("lab" = "solid", "field" = "dashed"),
                        #values = c("solid", "dashed")
                        ) +
  # scale_color_identity(name = "# females", guide = "legend") +
  theme_bw() +
  labs(title = "btwn treatment daily egg laying rate",
       y = "# eggs laid/female",
       x = "days since tent start",
       color = "parent trt"
         )  
```
### - (**) overlaid plots

```{r calc stats}
summ_rates_all <- summ_rate %>%
  group_by(id.tent, trt.f, trt.m, pop, jdate.rel) %>%
  mutate(n.tents.pertent = n(),
            rate.pertent = sum(n.coll)/sum(n.ovi),
            n.ovi.pertent = sum(n.ovi)) %>%
  ungroup() %>%
  group_by(trt.f, trt.m, pop, jdate.rel) %>%
  mutate(n.tents.overall = n(),
         rate.overall = sum(n.coll)/sum(n.ovi)/n.tents.overall,
         #rate.test = rate.pertent/n(), # this doesnt work bc rate.pertent is diff per tent lol
         n.ovi.overall = sum(n.ovi.pertent)) %>%
  select(c(id.tent, trt.f, trt.m, pop, trt.type, jdate.rel, ends_with("pertent"), ends_with("overall"))) %>%
  mutate(trt.win = case_when(trt.f == trt.m & trt.f == 260 ~ "26-26",
                             trt.f == trt.m & trt.f == 419 ~ "40-19",
                             trt.f == trt.m & trt.f == 426 ~ "40-26",
                             trt.f == trt.m & trt.f == 433 ~ "40-33"),
         trt.btwn = case_when(trt.f == trt.m & trt.f == 260 ~ "26-26",
                              (trt.f > trt.m & trt.f == 419) | (trt.m > trt.f & trt.m == 419) ~ "40-19",
                              (trt.f > trt.m & trt.f == 426) | (trt.m > trt.f & trt.m == 426) ~ "40-26",
                              (trt.f > trt.m & trt.f == 433) | (trt.m > trt.f & trt.m == 433) ~ "40-33")) %>%
  ungroup()
  
```


```{r testing win trt}
# within trts
summ_rates_all %>%
  filter(!is.na(trt.win)) %>%
  ggplot(aes(x = jdate.rel, color = trt.win 
             #group = id.tent
             )) +
  facet_grid(pop~trt.win,
             scales = "free_y"
             #rows = 2, cols  = 4
             ) +
  #geom_point(aes(y = rate.pertent), alpha = 0.5, show.legend = FALSE) +
  geom_line(aes(y = rate.pertent, group = id.tent, #alpha = 0.25, 
                lty = "solid"
                ), 
            alpha= 0.25,
            # lty = "solid",
            # show.legend = FALSE
            ) +
  geom_line(aes(y = rate.overall, group = interaction(trt.f, trt.m, pop), 
                lty = "solid", #alpha = 1
                ), 
            # lty = "solid",
            alpha = 1,
            # show.legend = FALSE
            ) +
  geom_line(aes(y = n.ovi.overall, #alpha = 0.7, 
                color = "black", 
                lty = "dashed"
                ),
            # lty = "dashed", 
             #color = "black",
             alpha = 0.65,
             show.legend = FALSE
            ) +
  theme_bw() +
    # scale_color_manual(values = c(RYB),
    #                  labels = c(labels.alltrts),
    #                  name = "temperature treatments") +
  scale_color_manual(values = c(RYB, "black"),
                     labels = c(labels.alltrts, "females"),
                     name = "temperature treatments") +
  scale_linetype_manual(values = c("dashed", "solid"),
                        labels = c("# ovipositing females", "lay rate"),
                        name = "rate") +
  # scale_alpha_manual(values = c("overall lay rate" = as.factor(1), "oviposition" = as.factor(0.7), "per tent lay rate"= as.factor(0.25)),
  #                    #labels = c("per trt", "per tent"),
  #                    name = "statistic") +
  labs(title = "within treatment hatch rates",
       #y = "# eggs/female per day",
       y = "rate/count",
       x = "days since initial tent setup",
       #lty = "rate"
       ) +
  xlim(c(1, 23)) +
  guides(color = "none",
         lty = "none")
  
# GOOD ENOUGH idk how to get rid of the females line in R lol

```

```{r btwn trt}
design <- "
abcd
#efg
" 

summ_rates_all %>%
  filter(!is.na(trt.btwn) & pop == "lab") %>%
  mutate(trt.type = case_when(trt.type == "hs F" ~ "F",
                              trt.type == "hs M" ~ "M",
                              trt.type == "ctrl" ~ "ctrl F & M",
                              TRUE ~ as.character(trt.type))) %>%
  ggplot(aes(x = jdate.rel, 
             color = as.factor(trt.btwn)
  )) +
  # facet_wrap(trt.type ~ trt.pair,
  #            nrow = 2, ncol = 3) +
  ggh4x::facet_manual(#~facet,
                      trt.type ~ trt.btwn,
                      design = design,
                      #scales = "free_x"
                      ) +
  #geom_point(aes(y = rate.overall)) + 
  geom_line(aes(y = rate.pertent, group = id.tent,
                lty = "solid"
                ), 
            alpha = 0.3,
            show.legend = FALSE) +
  geom_line(aes(y = rate.overall,
                lty = "solid"),
            alpha = 1,
            show.legend = FALSE) +
  geom_line(aes(y = n.ovi.overall,
                color = "black",
                lty = "dashed"
                ), 
            alpha = 0.7,
            show.legend = FALSE) +
  scale_color_manual(values = c(RYB, "black"),
                     labels = c(labels.alltrts, "# females"),
                     name = "trts") +
  scale_linetype_manual(values = c("dashed", "solid"),
                        labels = c("# ovipositing females", "lay rate"),
                        name = "rate") +
  theme_bw() +
  labs(title = "btwn treatment daily egg laying rate",
       y = "rate/count",
       x = "days since tent start",
       #color = "parent trt"
  )  +
  xlim(c(1,41)) +
  guides(color = "none",
         lty = "none")

# ALSO GOOD ENOUGH! 

```
### - modeling: # collected (try 1)

OOOOp big mistake. dont do this per day LOL (but prob at least overall tent duration?)

```{r get stats}
summ_eggmod <- data_tstats %>%
  mutate(room = as.factor(room),
         id.tent = as.factor(id.tent),
         trt.f = as.factor(trt.f),
         trt.m = as.factor(trt.m)) %>%
  group_by(id.tent, room, tent.loc, trt.f, trt.m, pop) %>%
  summarise(n.tents = n_distinct(id.tent),
            n.collected = sum(n.coll, na.rm = TRUE),
            n.hatched = sum(n.tothatch, na.rm = TRUE),
            n.females = sum(n.new.f, na.rm = TRUE),
            rate.hatch = n.hatched/n.collected,
            rate.f = round(n.collected/n.females, digits = 1))

```

```{r}
mod.coll <- glm(n.collected ~ trt.f + trt.m + pop + n.females, 
                data = summ_eggmod, family = poisson)

summary(mod.coll) # everything has an effect
anova(mod.coll) # lmao nothing is important tho!
```

- all the vars have a small but significant effect, but none of the variables matter
- AIC: 5235.5

drop the `n.females` bc idk if that matters tbh.... (it does)
```{r}
mod.coll2 <- glm(n.collected ~ trt.f + trt.m + pop, 
                data = summ_eggmod, family = poisson)

summary(mod.coll2)
anova(mod.coll2)
```
similar results, but AIC = 8073.5

look for random effects:

```{r}
mod.coll3 <- lme4::lmer(n.coll ~ trt.f + trt.m + n.curr.f + pop + (1|id.tent), 
                data = data_tstats, 
                #family = "poisson"
                )

summary(mod.coll3)
anova(mod.coll3)
```

with `lme4::lmer`, no major effects/no sig variables. residual for `id.tent` = 231

with `lmerTest::lmer`, `trt.f` is `*` and `curr.f` is `***` for both effect size and importance. residual for `id.tent` = 231 also

**summary:** did not quite calculate the stats/response for this right (i.e. `rate` isn't using the right "unit") -- so moving on to try 2


### - modeling: lay rate (i.e. coll rate, try 2)

qns before going in: 
- what's the right response variable for this? (rate? overall eggs?)
  - and then, what factors? (depends on the level? overall or per tent? random effs?)
  
first pass mod: looking for relevant variables...

```{r warning=FALSE}
mod.lay <- glm(rate.overall ~ 
                 as.factor(trt.f) + #as.factor(trt.m) + 
                 pop + 
                 n.ovi.overall + n.tents.overall #+ jdate.rel
               ,
               data = summ_rates_all,
               family = poisson)
  # getting a TON of non-integer warnings lolol

summary(mod.lay) # everything matters (minorly) except trt.f = 900 and trt.m (***). AIC = Inf LOL
anova(mod.lay) # nothing matters!!
```
so we can probably drop the `trt.m` term which makes sense tbh! (bc `trt.m` shouldn't have an effect on if females lay lol). we can try it: 

```{r warning=FALSE}
mod.lay2 <- glm(rate.overall ~ 
                 as.factor(trt.f) + pop + 
                 n.ovi.overall + n.tents.overall #+ jdate.rel
                ,
               data = summ_rates_all,
               family = poisson)
  # getting a TON of non-integer warnings again

summary(mod.lay2) # everything matters (minorly) except trt.f = 900. AIC = Inf
anova(mod.lay2) # nothing rlly matters again tho ðŸ« ..
```

it's hard to say if this model is rlly that meaningful since there's no AIC info... anyway. time to add in some random effects:

```{r}
mod.lay3 <- lme4::lmer(rate.overall ~ 
                        as.factor(trt.f) + as.factor(trt.m) + pop + 
                        n.ovi.overall + n.tents.overall + 
                         #jdate.rel +
                        (1|id.tent),
                      data = summ_rates_all,
                      )

summary(mod.lay3) # residual = 109 over 434 obs and 35 tent groups
anova(mod.lay3) # also nothing matters ðŸ‘

# looking at distributions with joel
with(summ_rates_all, density(rate.overall))
#plot.density(summ_rates_all$rate.overall)
summary(summ_rates_all$rate.overall)
```

**summary:** response is more correct now, but there's a lot of 0's in the data that should be addressed first


### - modeling: lay rate (try 3)

(addressed the 0 ovipositing females thing, have a better idea of what to include as explanatory variables/what im doing with random effects too!)

```{r warning=FALSE}
# try as a non-mixed mod first
mod3.lay <- glm(rate.overall ~ 
                 as.factor(trt.f) + as.factor(trt.m) + pop + 
                 n.ovi.overall + n.tents.overall + 
                  id.tent + jdate.rel,
               data = summ_rates_all,
               family = poisson)
  # getting a TON of non-integer warnings lolol

#summary(mod3.lay) # there are some diffs in what is signif...; AIC = Inf
anova(mod3.lay, test = "Chisq") # JKKKK everything matters.....
```
summary results:

- without adding in `n.tents.overall`:
  - *: f = 426, jdate
  - **: tent = 107-C, 107-D
  - ***: poplab, n.ovi, n.tents

- including `n.tents.overall`:
  - ***: f  = 426, 433; poplab, n.tents
  - * 301-P, ** 107-C, *** 107-D
  
- regardless if `n.tents.overall` is included or not, all vars aside from `j.date` are `***` in `anova(test = "Chisq")`

```{r warning = FALSE}
# try with mixed effs
mod3.lay2 <- lme4::glmer(rate.overall ~
                          as.factor(trt.f) + as.factor(trt.m) + pop +
                          n.ovi.overall + n.tents.overall +
                          (1|id.tent) + (1|jdate.rel),
                        data = summ_rates_all,
                        family = poisson
                        )
  # insane non-int warnings

#summary(mod3.lay2) # u get results but lots of non-ints
anova(mod3.lay2, test = "Chisq") # big F values: n.tents (77.18), n.ovi (65.36), pop (18.4)


mod3.lay2a <- lme4::glmer(rate.overall ~
                          as.factor(trt.f) + as.factor(trt.m) + pop +
                          n.ovi.overall + n.tents.overall +
                          (1|id.tent) + #(1|jdate.rel)
                            jdate.rel,
                        data = summ_rates_all,
                        family = poisson
                        ) 
  # probably a ton of non-integer warnings lol
#summary(mod3.lay2a) # lots of reslts but also lots of non-ints
anova(mod3.lay2a, test = "Chisq") # big F values: n.tents (77.18), n.ovi (65.36), pop (18.4)
```

**summary:** do not use non-ints with poisson lol

### - (**) // 240308: redoing mods again

going to log transform first bc shit keeps breaking and poisson is mad

```{r transform data}
summ_rates_all <- summ_rates_all %>%
  mutate(lt.overall = log(rate.overall + 1),
         lt.pertent = log(rate.pertent + 1))

# 240328: apparently `log()` *is* LN in r so we're goood
```

and quickly visualise...

```{r}
summ_rates_all %>%
  filter(pop == "lab" &
           !is.na(trt.win)) %>% 
  ggplot(aes(x = jdate.rel,
             y = lt.overall,
             color = trt.win)) +
  geom_line() 

summ_rates_all %>%
  filter(pop == "lab" &
           !is.na(trt.btwn) & trt.type != "ctrl") %>%
  ggplot(aes(x = jdate.rel,
             y = lt.overall,
             color = trt.btwn,
             group = trt.btwn)) +
  geom_line() +
  facet_wrap(~ trt.type)

```
they look okay, i guess? ðŸ˜¬ nothing looks horribly wrong...

now model again.. with the log transformed data



```{r}
# ignore: this isnt the right response unit (want to look at rate per tent)

# mod4.lay <- lm(lt.overall ~ as.factor(trt.f) + as.factor(trt.m) + pop + jdate.rel,
#                data = summ_rates_all)
# summary(mod4.lay)
# anova(mod4.lay, test = "Chisq")
# AIC(mod4.lay)
```
- from summary: the f/m trts are varyingly signif... pop is `***` and `jdate` is `***`.
  - adj R sq is 0.3174
- from anova: `f`, `pop`, `jdate` are `***` and `m` is `**`
- AIC: 889.5077

Response: lt.overall
                  Df  Sum Sq Mean Sq F value    Pr(>F)    
as.factor(trt.f)   3  36.138  12.046 15.0540 3.353e-09 ***
as.factor(trt.m)   3   9.561   3.187  3.9829  0.008278 ** 
pop                1  62.967  62.967 78.6903 < 2.2e-16 ***
jdate.rel          1  22.409  22.409 28.0042 2.223e-07 ***
Residuals        327 261.662   0.800 

let's see a mixed model:

```{r}
# ignore: this isnt the right response unit (want to look at rate per tent)

# mod4.lay2 <- lme4::lmer(lt.overall ~ as.factor(trt.f) + as.factor(trt.m) + pop + (1|jdate.rel),
#                data = summ_rates_all)
# summary(mod4.lay2)
# anova(mod4.lay2, test = "Chisq")
# lmerTest::ranova(mod4.lay2, test = "Chisq")
# AIC(mod4.lay2)
```
- summary: no significant fixed effs LOL
- anova (F-values): `trt.f` = 13, `pop` = 77.5320.
- AIC = 876.3347 â†’ so this is a marginally better model for the `rate.overall` data

                 npar Sum Sq Mean Sq F value
as.factor(trt.f)    3 25.614   8.538 13.8019
as.factor(trt.m)    3  6.096   2.032  3.2847
pop                 1 47.962  47.962 77.5320


**summary:** 
- am i doing this right.. (should i be using `lm()` for this?) â†’ even after log-transforming, there's still non-ints so can't use poisson...
- according to AIC, the mixed effect model seems to be a bit better for modeling `rate.overall`



now, look at the `pertent` models

```{r}
# ignore: this is using the wrong predictors (tent cant be a fixed eff since tent 1 in trt 1 â‰  tent 1 in trt 2)

# mod4.lay3 <- lm(lt.pertent ~ as.factor(trt.f) + as.factor(trt.m) + pop + 
#                   n.ovi.pertent + id.tent + jdate.rel,
#                data = summ_rates_all)
# summary(mod4.lay3)
# anova(mod4.lay3, test = "Chisq")
# AIC(mod4.lay3)
```
- summary:
  - some actual tents are signif (from `*` to `***` but the effect sizes aren't that big)
  - pop, parent trt varyingly matter
  - jdate is `*`; `n.ovi` is `***`
  - adj R-sq is 0.4784
- anova: everything vaguely matters

Response: lt.pertent
                  Df  Sum Sq Mean Sq F value    Pr(>F)    
as.factor(trt.f)   3  36.455  12.152 13.4600 2.891e-08 ***
as.factor(trt.m)   3  14.215   4.738  5.2485  0.001524 ** 
pop                1  76.396  76.396 84.6208 < 2.2e-16 ***
n.ovi.pertent      1   5.162   5.162  5.7180  0.017406 *  
id.tent           25 170.706   6.828  7.5634 < 2.2e-16 ***
jdate.rel          1   5.179   5.179  5.7370  0.017222 *  
Residuals        301 271.743   0.903  

- AIC: 954.2095


now try with random effs...

```{r}
# see lab only bugs in LB stats

mod4.lay4 <- lme4::lmer(lt.pertent ~ as.factor(trt.f) + as.factor(trt.m) + pop + 
                  n.ovi.pertent + (1|id.tent) + (1|jdate.rel),
               data = summ_rates_all, REML = FALSE)
summary(mod4.lay4)
anova(mod4.lay4, test = "Chisq")
lmerTest::ranova(mod4.lay4, test = "Chisq")
AIC(mod4.lay4)
# trying REML=F, nmle::lmer to get signif of the fixed effs via anova(test=chisq) doesnt work either :\


# with joel: determine signif by dropping terms consecutively
  # this works, it's just tedious
mod <- lme4::lmer(lt.pertent ~ as.factor(trt.f) + as.factor(trt.m) + 
                  n.ovi.pertent + (1|id.tent) + (1|jdate.rel),
               data = summ_rates_all, REML = FALSE)
anova(mod, mod4.lay4)
```


- summary
  - none of the fixed effs matter lawl
- very meh anova
                 npar Sum Sq Mean Sq F value
as.factor(trt.f)    3 1.4662  0.4887  0.6271
as.factor(trt.m)    3 2.7994  0.9331  1.1973
pop                 1 8.6211  8.6211 11.0614
n.ovi.pertent       1 6.4242  6.4242  8.2426

- AIC:988.0647


and what if we drop `jdate.rel` as a random effect?

```{r}
mod4.lay5 <- lme4::lmer(lt.pertent ~ as.factor(trt.f) + as.factor(trt.m) + pop + 
                  n.ovi.pertent + (1|id.tent) + jdate.rel,
               data = summ_rates_all)
summary(mod4.lay5)
anova(mod4.lay5, test = "Chisq")
lmerTest::ranova(mod4.lay5, test = "Chisq")
AIC(mod4.lay5)
```
- summary: no fixed effs matter
- anova: similar to when date is an RE
- AIC: 1006.285 â†’ so this is deffo a worse model. exclude this in the distributions checking

### - checking distributions/qq plots
QQ plot time!!!!
```{r}
autoplot(mod4.lay, which = 1:2) # overall
autoplot(mod4.lay3, which = 1:2) # pertent

# does not work for lmers
#autoplot(mod4.lay2, which = 1:2)
#autoplot(mod4.lay4, which = 1:2)
```
lol idk how to interp these tbh! let's use base R instead:

(from: https://stats.stackexchange.com/questions/125856/r-lmer-model-diagnosis-qqnorm)

```{r}
# overall

# (run these lines tgt)

# lm
qqnorm(resid(mod4.lay), main = "QQ plot: lm rate.overall")
qqline(resid(mod4.lay))

# lmer
qqnorm(resid(mod4.lay2), main = "QQ plot: lmer rate.overall")
qqline(resid(mod4.lay2))
  # joel says this is lovely!!!

```
// TODO: revist the interp of this LOL


but now time to look up qq plots for mixed eff models... 

```{r}
# per tent mods:

# lm
qqnorm(resid(mod4.lay3), main = "QQ plot: lm rate.pertent")
qqline(resid(mod4.lay3))

# lmer
qqnorm(resid(mod4.lay4), main = "QQ plot: lmer rate.pertent")
qqline(resid(mod4.lay4))

# so basically since lt.overall is N-dist itll prob be a little more agnostic to.. whatver stat bs stuff

```

// TODO: interp

## // lunch bunch: hatching

```{r}
# take out field individs for these figs
data_tstatsL <- data_tstats %>%
  filter(pop == "lab")
```


```{r}
# do math
summ_hatch_plot <- data_tstatsL %>%
  group_by(trt.f, trt.m,
           ) %>%
  summarise(n.tents = n_distinct(id.tent), # check
            n.collected = sum(n.coll, na.rm = TRUE),
            n.hatched = sum(n.tothatch, na.rm = TRUE),
            n.females = sum(n.new.f, na.rm = TRUE),
            rate.hatch = n.hatched/n.collected,
            se.hatch = sqrt(rate.hatch*(1-rate.hatch)/n.collected),  # check if im calcing right???
            rate.collf = n.collected/n.females,
            se.collf = sqrt(rate.collf*(1-rate.collf/n.collected)),
            ) %>%
  drop_na(trt.m) %>% # drop tents w/o males
  mutate(trt.win = case_when(trt.f == trt.m & trt.f == 260 ~ "26-26",
                             trt.f == trt.m & trt.f == 419 ~ "40-19",
                             trt.f == trt.m & trt.f == 426 ~ "40-26",
                             trt.f == trt.m & trt.f == 433 ~ "40-33"),
         trt.btwn = case_when(trt.f == 260 & trt.m == 260 ~ "26-26", 
                              trt.f == 419 | trt.m == 419 ~ "40-19",
                              trt.f == 426 | trt.m == 426 ~ "40-26",
                              trt.f == 433 | trt.m == 433 ~ "40-33"),
         trt.sex = case_when(trt.f == trt.m ~ "F and M",
                             trt.f > 400 & trt.m < 400 ~ "F only",
                             trt.f < 400 & trt.m > 400 ~ "M only"),
         trt.type = case_when(trt.f == 260 & trt.m == 260 ~ "control",
                              trt.f > 400 | trt.m > 400 ~ "experimental"),
         trt.temp = case_when(trt.f == trt.m & trt.f == 260 ~ "26-26",
                              trt.f == trt.m & trt.f > 400 ~ as.character(trt.win),
                              TRUE ~ as.character(trt.btwn)),
         is.ctrl = case_when(trt.temp == "26-26" ~ "yes",
                             TRUE ~ "no"))

summ_ctrl <- summ_hatch_plot %>%
  filter(is.ctrl == "yes")
```

```{r}
pal = c("#1a7e9e", "#4d126c", "#b0325a", "#f8880b")
  #c("#73add1", "#f46d43", "#d73027", "#b2182b")
  #c("#35978f", "#f1bbda", "#de77ae", "#c5237d")
  #c("#35978f", "#c2a5cf", "#de77ae", "#d95f02")
  #c("#35978f", "#9970ab", "#c5237d", "#f46d43")
  #c("#66C2A5", "#8DA0CB", "#E78AC3", "#FC8D62")

# plotting win trts
p2 <- 
summ_hatch_plot %>%
  filter(#is.ctrl == "no" & 
    !is.na(trt.win)) %>%
  ggplot(aes(y = rate.hatch, x = rate.collf,
             shape = trt.sex, #fill = trt.type, 
             color = trt.temp)) +
  geom_point(size = 3, #show.legend = FALSE
             ) +
  geom_text(aes(label = n.females), vjust = -1, hjust = -1, show.legend = FALSE) +
  y_err_hrate(err = 3) + # 1+2, default axes
  x_err_ncollf(err = 0.005) + 
  #y_err_hrate(err = 7) + # 1+2, custom x-y
  x_err_ncollf(err = 0.005) +
  #geom_point(data = summ_ctrl, shape = 1, size = 2.5) +
  scale_color_manual(values = pal) +
  scale_shape_manual(values = 4) +
  guides(shape = "none", linetype="none", color = "none") +
  labs(y = "within treatment hatch proportion", x = "eggs collected per female") +
  theme_bw()

# plotting btwn trts
p1 <- 
summ_hatch_plot %>%
  filter(#is.ctrl == "no" & 
           trt.btwn == "26-26" |
           is.na(trt.win)) %>%
  ggplot(aes(y = rate.hatch, x = rate.collf,
             shape = trt.sex, #fill = trt.type, 
             color = trt.temp)) +
  geom_point(size = 3) +
  #geom_line(aes(lty = trt.sex, group = trt.sex)) +
  geom_text(aes(label = n.females), vjust = -1.2, hjust = -0.8, show.legend = FALSE) +
  #geom_point(data = summ_ctrl, shape = 1, size = 2.5) +
  y_err_hrate(err = 7.5) + # 1+2, default axes
  x_err_ncollf(err = 0.005) + 
  #y_err_hrate(err = 10) + # 1+2, custom x-y
  #x_err_ncollf(err = 0.005) +
  scale_color_manual(values = pal) +
  #scale_shape_manual(values = c(19, 17, 15)) +
  scale_shape_manual(values = c(4, 19, 1)) +
  labs(y = "between treatment hatch proportion", x = "eggs collected per female") +
  #guides(color = "none", linetype = "none", shape = "none") +
  theme_bw()

# combine plots
#p2 + 
p1 +
  plot_layout(guides = "collect",
              axes = "collect_x",
              #ncol = 2, nrow = 1,
              widths = c(2:2)) &
  theme(legend.position = "top", legend.box = "vertical", legend.margin = margin(0.1)) &
  labs(shape = "heat-stressed sex", color = "day-night temperatures (Â°C)") &
  ylim(c(0, 0.18)) #& xlim(c(0, 350))
```

```{r}
# plotting 0 < hatch rate
summ_hatch_plot %>%
  filter(rate.hatch > 0) %>%
  ggplot(aes(y = rate.hatch, x = rate.collf,
             shape = trt.sex, 
             color = trt.temp)) +
  geom_point(size = 2.5) +
  geom_text(aes(label = n.females), vjust = -1, hjust = -1, show.legend = FALSE) +
  y_err_hrate(err = 3) +
  x_err_ncollf(err = 0.005) +
  scale_color_manual(values = c("#324DA0", "#acd2bb", "#a51122")) +
  labs(y = "hatch proportion", x = "eggs collected per female") +
  ylim(c(0, 0.18)) +
  theme_bw()
```




# B2: 240304 redo plotting, per tent

**for the most part these changes have been incorporated into the code now, but is retained here for troubleshooting**

things we want to fix:

- PER tent calcs
- check for lagging 0s

 - calc ovipositing F

```{r}
summ_rate2 <- data_tstats %>%
  mutate_at(c(6:13), ~replace_na(., 0)) %>% #
  group_by(id.tent) %>%
  mutate(jdate.rel = jdate - first(jdate)) %>%
  ungroup() %>%
  group_by(id.tent, trt.f, trt.m, pop, trt.type, jdate.rel) %>%
  arrange(jdate.rel, .by_group = TRUE) %>%
  mutate(#n.laying = n.curr.f + n.died.f, .after = "n.curr.f",
         n.ovi = dplyr::lag(n.curr.f, default = first(n.curr.f)) + n.died.f, .after = "n.curr.f") %>%
  ungroup()
  # mutate_at(n.laying == 0 & n.coll > 0, "n.laying" = lag(n.laying))
  # summarise()

# where n.ovipositing females = 0 but n.collected > 0, add the # collected to the day before:
# first, figure out the rows
cond2 <- (summ_rate2$n.coll > 0 & summ_rate2$n.ovi == 0)
summ_rate2 %>%
  mutate(index = as.numeric(rownames(.)), .before = 1) %>%
  subset(cond2 | lead(cond2) | lead(cond2, n=2))  #%>%
  #View()
rm(cond2)

# edit values
summ_rate2$n.coll[c(55, 66, 73, 115, 152, 210)] <- 1
summ_rate2$n.coll[c(56, 67, 75, 116, 153, 211)] <- 0

# # additional modifications to make the math(?) right:
# # remove 0's
# summ_rate2 <- summ_rate2 %>%
#   filter(!(n.coll == 0 & n.ovi == 0))

```

- checks for other df mods

- check 1: check where eggs and ovipositing females stop

```{r}
summ_rate2 %>%
  mutate(ind = rownames(.), .before = 1) %>%
  group_by(id.tent) %>%
  mutate(last = last(jdate.rel), .after = "jdate.rel") %>%
  filter(n.coll == 0 & n.ovi == 0
         & jdate.rel > 0
         & jdate.rel != last(jdate.rel)
         ) %>% View()
  # so i should filter out these values?
  # 89 for: coll = ovi = 0
  
summ_rate2 %>%
  filter(id.tent == "301-X") %>% # example tent
  # filter(trt.pair != "err" &
  #          pop == "lab" &
  #          trt.pair == "ct F + hs M") %>% # View()
  ggplot(aes(x = jdate.rel, color = trt.pair, group = id.tent)) +
  geom_line(aes(y = n.ovi), lty = "dashed", show.legend = FALSE) +
  geom_line(aes(y = n.coll), show.legend = FALSE) +
  facet_grid(~ id.tent, scales = "free") +
  # xlim(c(9, 13))
  theme_bw()
  
```

so i'll filter out where `n.ovi` and `n.coll` = 0 and also change `xlim` to probably day 1 then

- overlaid plots

```{r calcs}
# check if the n.tents.overall is actually counted right...:
# summ_all_rates2 %>%
#   filter(trt.f == 260 & trt.m == 260 & pop == "field") %>%

# summ_all_rates2 <- summ_rate2 %>%
#   group_by(id.tent, trt.f, trt.m, pop, jdate.rel) %>%
#   mutate(n.tents.pertent = n(),
#             rate.pertent = sum(n.coll)/sum(n.ovi),
#             n.ovi.pertent = sum(n.ovi)) %>%
#   ungroup() %>%
#   group_by(trt.f, trt.m, pop, jdate.rel) %>%
#   mutate(n.tents.overall = n(),
#          rate.overall = sum(n.coll)/sum(n.ovi)/n.tents.overall,
#          #rate.test = rate.pertent/n(), # this doesnt work bc rate.pertent is diff per tent lol
#          n.ovi.overall = sum(n.ovi.pertent)) %>%
#   select(c(id.tent, trt.f, trt.m, pop, trt.type, jdate.rel, ends_with("pertent"), ends_with("overall"))) %>%
#   mutate(trt.win = case_when(trt.f == trt.m & trt.f == 260 ~ "26-26",
#                              trt.f == trt.m & trt.f == 419 ~ "40-19",
#                              trt.f == trt.m & trt.f == 426 ~ "40-26",
#                              trt.f == trt.m & trt.f == 433 ~ "40-33"),
#          trt.btwn = case_when(trt.f == trt.m & trt.f == 260 ~ "26-26",
#                               (trt.f > trt.m & trt.f == 419) | (trt.m > trt.f & trt.m == 419) ~ "40-19",
#                               (trt.f > trt.m & trt.f == 426) | (trt.m > trt.f & trt.m == 426) ~ "40-26",
#                               (trt.f > trt.m & trt.f == 433) | (trt.m > trt.f & trt.m == 433) ~ "40-33")) %>%
#   ungroup()
# 
# # UMM i think this is okay
  
```

- check that the per day per tent stats are right...

```{r}
# summ_all_rates2 %>%
#   filter(trt.m == 426 & trt.f == 426 & pop == "lab") #%>%
#   #filter(!duplicated(rate.overall)) %>% 
#   #View()

```

```{r win trts}
# # within trts
# summ_all_rates2 %>%
#   filter(!is.na(trt.win)) %>%
#   ggplot(aes(x = jdate.rel, color = trt.win 
#              #group = id.tent
#              )) +
#   facet_grid(pop~trt.win,
#              scales = "free_y"
#              #rows = 2, cols  = 4
#              ) +
#   #geom_point(aes(y = rate.pertent), alpha = 0.5, show.legend = FALSE) +
#   geom_line(aes(y = rate.pertent, group = id.tent, #alpha = 0.25, 
#                 lty = "solid"
#                 ), 
#             alpha= 0.25,
#             # lty = "solid",
#             # show.legend = FALSE
#             ) +
#   geom_line(aes(y = rate.overall, group = interaction(trt.f, trt.m, pop), 
#                 lty = "solid", #alpha = 1
#                 ), 
#             # lty = "solid",
#             alpha = 1,
#             # show.legend = FALSE
#             ) +
#   geom_line(aes(y = n.ovi.overall, #alpha = 0.7, 
#                 color = "black", 
#                 lty = "dashed"
#                 ),
#             # lty = "dashed", 
#              #color = "black",
#              alpha = 0.65,
#              show.legend = FALSE
#             ) +
#   theme_bw() +
#     # scale_color_manual(values = c(RYB),
#     #                  labels = c(labels.alltrts),
#     #                  name = "temperature treatments") +
#   scale_color_manual(values = c(RYB, "black"),
#                      labels = c(labels.alltrts, "females"),
#                      name = "temperature treatments") +
#   scale_linetype_manual(values = c("dashed", "solid"),
#                         labels = c("# ovipositing females", "lay rate"),
#                         name = "rate") +
#   # scale_alpha_manual(values = c("overall lay rate" = as.factor(1), "oviposition" = as.factor(0.7), "per tent lay rate"= as.factor(0.25)),
#   #                    #labels = c("per trt", "per tent"),
#   #                    name = "statistic") +
#   labs(title = "within treatment hatch rates",
#        #y = "# eggs/female per day",
#        y = "rate/count",
#        x = "days since initial tent setup",
#        #lty = "rate"
#        ) +
#   xlim(c(1, 23)) +
#   guides(color = "none",
#          lty = "none")
#   
# # GOOD ENOUGH idk how to get rid of the females line in R lol
  
```

```{r btwn trts}
# design <- "
# aefg
# #bcd
# " 
# 
# summ_all_rates2 %>%
#   filter(!is.na(trt.btwn) & pop == "lab") %>%
#   ggplot(aes(x = jdate.rel, 
#              color = as.factor(trt.btwn) # want this to be RYB tho
#   )) +
#   # facet_wrap(trt.type ~ trt.pair,
#   #            nrow = 2, ncol = 3) +
#   ggh4x::facet_manual(#~facet,
#                       trt.type ~ trt.btwn,
#                       design = design,
#                       #scales = "free_x"
#                       ) +
#   #geom_point(aes(y = rate.overall)) + 
#   geom_line(aes(y = rate.pertent, group = id.tent,
#                 lty = "solid"
#                 ), 
#             alpha = 0.3,
#             show.legend = FALSE) +
#   geom_line(aes(y = rate.overall,
#                 lty = "solid"),
#             alpha = 1,
#             show.legend = FALSE) +
#   geom_line(aes(y = n.ovi.overall,
#                 color = "black",
#                 lty = "dashed"
#                 ), 
#             alpha = 0.7,
#             show.legend = FALSE) +
#   scale_color_manual(values = c(RYB, "black"),
#                      labels = c(labels.alltrts, "# females"),
#                      name = "trts") +
#   scale_linetype_manual(values = c("dashed", "solid"),
#                         labels = c("# ovipositing females", "lay rate"),
#                         name = "rate") +
#   theme_bw() +
#   labs(title = "btwn treatment daily egg laying rate",
#        y = "rate/count",
#        x = "days since tent start",
#        #color = "parent trt"
#   )  +
#   xlim(c(1,41)) +
#   guides(color = "none",
#          lty = "none")
# 
# # ALSO GOOD ENOUGH!
```


next
- plot
- do other checks joel told me to do
- model

- checking residual distibutions

(reusing the models from above ... (i.e try 3 ish)) â†’ which models to look at for in particular?

**summary:** (okay we are ignoring this bc using non-integers in poisson makes R mad.)


### - other distribution checks...

(are there still tails in the data? how does it look after getting rid of some of the zeroes?)

```{r}
summary(summ_rate_zeros$n.coll)
summary(summ_rate$n.coll)
```

**summary:** the data is still asymmetrical!

# C. longevity

### (**) - plots

```{r calc avg longevity}

data_longevity <- data_longevity %>%
  mutate(surv = jdate.died - jdate.ec)

summ_longevity <- data_longevity %>%
  filter(track.reason == "surv-fert" | track.reason == "surv") %>%
  drop_na(jdate.died) %>%
  group_by(trt, sex, pop) %>%
  summarise(avg.surv = mean(surv),
            se.surv = sd(na.omit(surv))/sqrt(length(na.omit(surv))),
            n = n())

```

```{r}
pd = position_dodge(-0.5)

summ_longevity %>%
  ggplot(aes(y = avg.surv, x = as.factor(trt), color = as.factor(trt), shape = sex)) +
  geom_point(size = 3, position = pd) +
  geom_errorbar(aes(ymax = avg.surv + se.surv, ymin = avg.surv - se.surv,
                    width = 0.5),
                position = pd) +
  facet_wrap(~pop) +
  geom_text(aes(label = n), hjust = -1, show.legend = FALSE,
            position = pd) +
  theme_bw() +
  scale_color_manual(values = RYB,
                     labels = labels.alltrts,) +
  scale_x_discrete(labels = labels.alltrts) +
  labs(title = "avg adult longevity",
       y = "average survival post-eclosion (days)",
       x = "temperature trt (day-night, Â°C )") +
  guides(color = "none")
```

// TODO: currently not planning on running stats! (maybe just a quick anova lol?)

## // lunch bunch
```{r}
pd = position_dodge(0.5)

summ_longevity %>%
  mutate(labels.alltrts2 = case_when(trt == 260 ~ "control",
                         trt == 419 ~ "19Â°C",
                         trt == 426 ~ "26Â°C",
                        trt == 433 ~ "33Â°C"),
         labels.alltrts2 = factor(labels.alltrts2, levels = c("control", "19Â°C", "26Â°C", "33Â°C"))) %>%
  filter(labels.alltrts2 != "control") %>%
  filter(pop == "lab") %>%
  ggplot(aes(y = avg.surv, x = labels.alltrts2, color = sex, #color = as.factor(trt), 
             shape = sex
             )) +
  geom_point(size = 2.5, position = pd) +
  geom_errorbar(aes(ymax = avg.surv + se.surv, ymin = avg.surv - se.surv,
                    width = 0.5),
                position = pd) +
  #facet_wrap(~pop) +
  geom_text(aes(label = n), hjust = 2, show.legend = FALSE,
            position = pd) +
  theme_bw() +
  #scale_shape_manual(values = c(19, 1)) +
  labs(#title = "avg adult longevity",
       y = "adult survival post eclosion (days)",
       x = "minimum temperature") +
  #guides(color = "none") +
  theme(legend.position = "top")

```
# // lunch bunch stats

## - longevity
```{r lab only df}
# for egg laying
# see the summ_rates_all stuff (mod4) for egg laying bc i think that seems mostly sorted lol

# for longevity
data_longevityL <- data_longevity %>%
  filter(pop == "lab",
         trt != 260) 
  # use the "surv" for math
```

```{r longevity stats}
# look at longevity as a function of NT
mod.long <- lm(surv ~ as.factor(minT)*sex, data = data_longevityL) #AIC: 311.9173
mod.long2 <- lm(surv ~ as.factor(minT) + sex, data = data_longevityL) #AIC: 308.1136
mod.long3 <- lm(surv ~ minT*sex, data = data_longevityL) #AIC: 308.0313
mod.long4 <- lm(surv ~ minT+sex, data = data_longevityL) #AIC: 306.2079

# is NT as factor or numeric better? (prob as a factor)
anova(mod.long, mod.long3, test = "Chisq") # LOL no diff rip
# based on AIC, minT as numeric is better

anova(mod.long4, test = "Chisq")
summary(mod.long4)


# look at long as a function of mean/fluct
mod.long_mf <- lm(surv ~ as.factor(meanT)*as.factor(flucT)*sex, data = data_longevityL)
mod.long_mf2 <- lm(surv ~ as.factor(meanT)+as.factor(flucT)+sex, data = data_longevityL) # AIC: 308.1136
anova(mod.long_mf, mod.long_mf2, test = "Chisq") # add is better

# is numeric better? -- yes
mod.long_mf3 <- lm(surv ~ meanT+flucT+sex, data = data_longevityL) #AIC: 306.2079 same as mod.long4....
anova(mod.long_mf2, mod.long_mf3, test = "Chisq") # (mf2 has lower RSS but higher AIC?)
anova(mod.long_mf3, test = "Chisq")

# NT vs mf mod?
anova(mod.long4, mod.long_mf3, test = "Chisq")
```

## - laying
```{r egg laying all together}
summ_rates_L <- summ_rates_all %>% filter(pop == "lab")

mod4.lay4a <- lme4::lmer(lt.pertent ~ as.factor(trt.f) + as.factor(trt.m) + 
                  n.ovi.pertent + (1|id.tent) + (1|jdate.rel),
               data = summ_rates_L, REML = FALSE)
summary(mod4.lay4a)
anova(mod4.lay4a, test = "Chisq") # doesnt give signif for fixed terms
lmerTest::ranova(mod4.lay4a, test = "Chisq") # signif for random terms
AIC(mod4.lay4a) # AIC: 900.4932

drop1(mod4.lay4a, test="Chisq")


# drop the ctrls
summ_rates_Lexpt <- filter(summ_rates_L, !(trt.f == 260 & trt.m== 260))

mod4.lay4b <- lme4::lmer(lt.pertent ~ as.factor(trt.f) + as.factor(trt.m) + 
                  n.ovi.pertent + (1|id.tent) + (1|jdate.rel),
               data = summ_rates_Lexpt, REML = FALSE)

drop1(mod4.lay4b, test="Chisq")
```

```{r subset a bit}
summ_rates_btwn <- summ_rates_L %>%
  filter(!is.na(trt.btwn) & trt.btwn != "26-26")

summ_rates_win <- summ_rates_L %>%
  filter(!is.na(trt.win) & trt.win != "26-26")

mod4.lay5a <- lme4::lmer(lt.pertent ~ as.factor(trt.win) + 
                  n.ovi.pertent + (1|id.tent) + (1|jdate.rel),
               data = summ_rates_win, REML = FALSE)

mod4.lay5b <- lme4::lmer(lt.pertent ~ as.factor(trt.f) + as.factor(trt.m) + 
                  n.ovi.pertent + (1|id.tent) + (1|jdate.rel),
               data = summ_rates_btwn, REML = FALSE)

mod4.lay5c <- lme4::lmer(lt.pertent ~ as.factor(trt.btwn) + 
                  n.ovi.pertent + (1|id.tent) + (1|jdate.rel),
               data = summ_rates_btwn, REML = FALSE)

drop1(mod4.lay5a, test="Chisq")
drop1(mod4.lay5b, test="Chisq")
drop1(mod4.lay5c, test="Chisq")
```

## - hatching
```{r try for hatching...}
# prep df -- remove ctrls
summ_hatchLB <- summ_hatchall %>%
  #filter(trt.pair != "ct F + ct M") %>%
  filter(pop == "lab") %>%
  pivot_longer(cols = c("trt.f", "trt.m"), names_to = c(".value", "sex"), names_sep = "\\.") %>%
  filter(trt != 260) %>%
  mutate(trt.type = case_when(trt.type == "hs F" | trt.type == "hs M" ~ "btwn",
                              TRUE ~ "win"))

# summ_hatchLB2 <- summ_hatchLB %>% 
#   filter(n.hatched > 0) # nhatch mod breaks using 0's


# model hatch rate (unpivoted)
# mod.hprop <- lm(lt.hprop ~ as.factor(trt.f) + as.factor(trt.m) + rate.collf, data = summ_hatchLB)
# anova(mod.hprop, test = "Chisq")

# model hatch rate (pivoted)

# model total # hatched
  # dont use - not the right unit
# mod.nhatch <- glm(n.hatched ~ as.factor(trt.f) + as.factor(trt.m) + n.females + n.collected, 
#                   data = summ_hatchLB, family = poisson)
# anova(mod.nhatch, test = "Chisq")
```

```{r hatching with exptl only}
# look at btwn hprop
summ_hatchbt <- summ_hatchLB %>%
  filter(trt.type == "btwn") %>% 
  distinct(id.tent, lt.hprop, .keep_all = TRUE) # shit keeps breaking if u dont do this

# model hatch rate
# mod.hrate2 <- lm(lt.hrate ~ as.factor(trt.f) + as.factor(trt.m) + rate.collf, data = summ_hatchLB3)
# anova(mod.hrate2, test = "Chisq")

# model total # hatched
# mod.nhatch2 <- glm(n.hatched ~ as.factor(trt.f) + as.factor(trt.m) + n.females + n.collected, 
#                   data = summ_hatchLB3, family = poisson)
# anova(mod.nhatch2, test = "Chisq")

# models..
#mod.bprop <- lme4::lmer(lt.hprop ~ as.factor(trt)*sex + rate.collf + (1|id.tent), data = summ_hatchbt)
  # this is not giving (model fails to converge) so lets not do that
  # this doesnt work after distinct()
# qqnorm(resid(mod.bprop))
# qqline(resid(mod.bprop)) # this looks terrible on the fail to converge model (duplicates)

mod.bprop2 <- lm(lt.hprop ~ as.factor(trt)*sex + rate.collf, data = summ_hatchbt)
anova(mod.bprop2, test = "Chisq") # bad model ("perfect fit")

mod.bprop3 <- lm(lt.hprop ~ as.factor(trt)*trt.pair + rate.collf, data = summ_hatchbt)
anova(mod.bprop3) # bad model ("perfect fit")

mod.bprop4 <- lm(lt.hprop ~ as.factor(trt)*sex, data = summ_hatchbt)
anova(mod.bprop4) # bad model ("perfect fit")
```


```{r}
# look at win prop
summ_hatchwin <- summ_hatchLB %>%
  filter(trt.type == "win") %>% 
  distinct(id.tent, lt.hprop, .keep_all = TRUE)

mod.wprop <- lm(lt.hprop ~ trt, data = summ_hatchwin)
anova(mod.wprop, test = "Chisq")
```





# to do

- ~~better overlaid overall/per tent rate plots (fix # ovi females)~~
- fix mods: need to not batch by jdate lol
- ~~longevity~~
- ~~response var: standardise by tent~~
- ~~add adult mass plots~~

# followups

1. 240304: B2 - recalc egg laying + redo mods
  - also checked data distributions
2. 240308: redoing mods again
